<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aluguel de Ve√≠culos</title>

  <!-- Bibliotecas CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

  <!-- Bibliotecas JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --primary-color: #37b61e;
      --secondary-color: #2E86C1;
      --danger-color: #E74C3C;
      --text-color: #333;
      --light-gray: #f5f5f5;
      --border-color: #ddd;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body { 
      font-family: Arial, sans-serif; 
      background: #ffffff; 
      padding: 15px; 
      color: var(--text-color);
      line-height: 1.5;
    }
    
    .container { 
      background: rgb(247, 247, 247); 
      padding: 20px; 
      max-width: 1000px; 
      margin: auto; 
      border-radius: 10px; 
      box-shadow: 0 0 10px rgba(0,0,0,0.1); 
    }
    
    h1, h2 { 
      text-align: center; 
      color: var(--primary-color); 
      margin-top: 0;
    }
    
    h1 { font-size: 1.8rem; }
    h2 { font-size: 1.5rem; }
    
    .form-group { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 15px; 
    }
    
    .form-item { 
      flex: 1 1 100%; 
      display: flex; 
      flex-direction: column; 
    }
    
    label { 
      font-weight: bold; 
      margin-bottom: 5px; 
      font-size: 0.9rem;
    }
    
    input, select, textarea { 
      padding: 10px; 
      border: 1px solid var(--border-color); 
      border-radius: 5px; 
      font-size: 1rem; 
      width: 100%;
    }
    
    textarea { 
      resize: vertical; 
      min-height: 80px;
    }
    
    button { 
      background-color: var(--secondary-color); 
      color: white; 
      padding: 12px 20px; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
      font-weight: bold; 
      margin-top: 10px; 
      font-size: 1rem;
      transition: background-color 0.3s;
      width: 100%;
    }
    
    button:hover {
      background-color: #1a6ea8;
    }
    
    .valor-destaque { 
      background: #dff0d8; 
      color: #155724; 
      padding: 15px; 
      border-radius: 6px; 
      font-size: 1.2rem; 
      text-align: center; 
      margin-top: 20px; 
    }
    
    .resultado, #historicoContainer { 
      margin-top: 20px; 
      overflow-x: auto;
    }
    
    .resultado table, #historicoContainer table { 
      width: 100%; 
      border-collapse: collapse; 
      background: white; 
      font-size: 0.9rem;
    }
    
    table td, table th { 
      padding: 8px; 
      border: 1px solid var(--border-color); 
      text-align: left;
    }
    
    th { 
      background: var(--light-gray); 
    }
    
    .pdf-header { 
      text-align: center; 
      margin-bottom: 15px; 
    }
    
    .pdf-title { 
      font-size: 1.1rem; 
      font-weight: bold; 
    }
    
    .pdf-subtitle { 
      font-size: 0.9rem; 
      color: #555; 
    }
    
    .pdf-footer { 
      text-align: center; 
      margin-top: 15px; 
      font-size: 0.8rem; 
      color: #777; 
    }
    
    .btn-excluir { 
      background-color: var(--danger-color); 
      padding: 5px 10px; 
      font-size: 0.8rem; 
      margin: 2px; 
      white-space: nowrap;
    }
    
    .btn-excluir:hover {
      background-color: #c0392b;
    }
    
    .btn-limpar {
      background-color: var(--danger-color) !important;
    }
    
    .btn-limpar:hover {
      background-color: #c0392b !important;
    }
    
    .no-print { 
      display: block; 
    }
    
    .print-only { 
      display: none; 
    }
    
    .controls { 
      display: flex; 
      gap: 10px; 
      margin-bottom: 15px; 
      flex-wrap: wrap; 
    }
    
    .controls select { 
      padding: 8px; 
      border-radius: 5px; 
      flex: 1 1 200px;
    }
    
    .controls button {
      flex: 1 1 150px;
      margin-top: 0;
    }
    
    /* Estilo compacto para o resultado */
    .resultado-compact table { 
      width: 100%; 
      font-size: 0.85rem; 
    }
    
    .resultado-compact td, .resultado-compact th { 
      padding: 6px; 
    }
    
    .resultado-compact .total-row { 
      font-weight: bold; 
      background-color: var(--light-gray); 
    }
    
    hr {
      border: 0;
      height: 1px;
      background-color: var(--border-color);
      margin: 20px 0;
    }
    
    /* Estilos para o calend√°rio - mantendo o mesmo estilo do vale alimenta√ß√£o */
    .flatpickr-day.feriado, 
    .flatpickr-day.feriado-movel,
    .flatpickr-day.domingo {
      background-color: #f5c6cb !important;
      color: #721c24 !important;
      cursor: not-allowed !important;
      font-weight: bold !important;
      border: 1px dashed #f194a1 !important;
      text-decoration: line-through !important;
    }
    
    .flatpickr-day.feriado:hover, 
    .flatpickr-day.feriado-movel:hover,
    .flatpickr-day.domingo:hover {
      background-color: #f5c6cb !important;
    }
    
    /* Media Queries para telas maiores */
    @media (min-width: 768px) {
      .form-item { 
        flex: 1 1 calc(50% - 15px); 
      }
      
      button {
        width: auto;
        display: inline-block;
      }
      
      .controls button {
        flex: 0 1 auto;
      }
      
      h1 { font-size: 2rem; }
      h2 { font-size: 1.7rem; }
      
      .valor-destaque { 
        font-size: 1.4rem; 
      }
    }
    
    @media print {
      .no-print { 
        display: none !important; 
      }
      
      .print-only { 
        display: block !important; 
      }
      
      body { 
        background: white; 
        padding: 0; 
      }
      
      .container { 
        box-shadow: none; 
        background: white; 
        padding: 10px; 
      }
      
      button { 
        display: none !important; 
      }
      
      .resultado table, #historicoContainer table {
        font-size: 10pt;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="print-only">ALUGUEL DE VE√çCULOS - HIST√ìRICO COMPLETO</h1>
    <h1 class="no-print">ALUGUEL DE VE√çCULOS</h1>

    <div class="no-print">
      <div class="form-group">
        <div class="form-item">
          <label>üë∑ Operador:</label>
          <select id="operador">
            <option value="">-- Selecione --</option>
            <option>Caio Jos√©</option>
            <option>Daniel Rodrigo</option>
            <option>Igor Nascimento</option>
            <option>Lissandro da Silva</option>
            <option>Leonardo Vaz</option>
            <option>Patrick Darlan</option>
            <option>Ricardo Alves</option>
            <option>Keniel Vasque</option>
          </select>
        </div>

        <div class="form-item">
          <label>üöó Tipo de Ve√≠culo:</label>
          <select id="tipo">
            <option value="">-- Selecione --</option>
            <option value="moto">Moto (R$ 750)</option>
            <option value="carro">Carro (R$ 1500)</option>
          </select>
        </div>

        <div class="form-item">
          <label>üìÖ Dias previstos:</label>
          <input type="text" id="faltas" placeholder="Clique e selecione os dias √∫teis" />
        </div>

        <div class="form-item">
          <label>‚úÖ Dias reais trabalhados:</label>
          <input type="number" id="diasReais" min="0" placeholder="Digite o n√∫mero de dias trabalhados" />
        </div>

        <div class="form-item">
          <label>üìâ Faltas a descontar:</label>
          <input type="number" id="faltasDesconto" min="0" />
        </div>

        <div class="form-item">
          <label>üçä Desconto CAJU (R$):</label>
          <input type="number" id="descontoCaju" step="0.01" min="0" />
        </div>

        <div class="form-item">
          <label>üí∞ Outros Descontos (R$):</label>
          <input type="number" id="outrosDescontos" step="0.01" min="0" />
        </div>

        <div class="form-item" style="flex: 1 1 100%;">
          <label>üìù Justificativa:</label>
          <textarea id="justificativa" rows="3" placeholder="Obrigat√≥ria se houver desconto."></textarea>
        </div>
      </div>

      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="calcularValor()">‚ûï Calcular</button>
        <button onclick="exportarPDF()">üìÑ Salvar PDF</button>
      </div>

      <div class="valor-destaque" id="valorOperador" style="display:none;"></div>
      <div class="resultado" id="resultado" style="display:none;"></div>

      <hr>
    </div>

    <div id="historicoSection">
      <h2>üìö Hist√≥rico</h2>
      <div class="controls no-print">
        <select id="filtroOperador" onchange="mostrarHistorico()">
          <option value="">Todos os Operadores</option>
        </select>
        <button onclick="mostrarHistorico()">üîÑ Atualizar</button>
        <button onclick="exportarHistoricoPDF()">üì§ Exportar Hist√≥rico</button>
        <button class="btn-limpar" onclick="confirmarLimpezaHistorico()">üßπ Limpar Hist√≥rico</button>
        <button onclick="sincronizarHistoricoCompleto()">üîÑ Sincronizar com Planilha</button>
      </div>

      <div id="historicoContainer" style="display:none;"></div>
    </div>
  </div>

  <script>
    const Swal = window.Swal;
    let diasSelecionados = [];

    // Feriados fixos (dia/m√™s)
    const feriadosFixos = [
      { dia: 1, mes: 1 },   // Ano Novo
      { dia: 21, mes: 4 },  // Tiradentes
      { dia: 1, mes: 5 },   // Dia do Trabalho
      { dia: 7, mes: 9 },   // Independ√™ncia
      { dia: 12, mes: 10 }, // Nossa Senhora Aparecida
      { dia: 2, mes: 11 },  // Finados
      { dia: 15, mes: 11 }, // Proclama√ß√£o da Rep√∫blica
      { dia: 25, mes: 12 }  // Natal
    ];

    // Feriados m√≥veis (ano espec√≠fico)
    const feriadosMoveis = {
      "2025-03-04": "Carnaval",
      "2025-04-18": "Sexta-feira Santa",
      "2025-06-19": "Corpus Christi"
    };

    // Configura√ß√£o do flatpickr com os dias bloqueados
    flatpickr("#faltas", {
      mode: "multiple", 
      dateFormat: "Y-m-d", 
      locale: "pt",
      onChange: selected => diasSelecionados = selected,
      disable: [
        function(date) {
          // Verifica se √© domingo (0 = Domingo, 1 = Segunda, ..., 6 = S√°bado)
          if (date.getDay() === 0) {
            return true;
          }
          
          // Verifica feriados fixos
          const dia = date.getDate();
          const mes = date.getMonth() + 1; // getMonth() retorna 0-11
          
          const isFeriadoFixo = feriadosFixos.some(f => f.dia === dia && f.mes === mes);
          if (isFeriadoFixo) {
            return true;
          }
          
          // Verifica feriados m√≥veis
          const dataFormatada = date.getFullYear() + '-' + 
                              String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                              String(date.getDate()).padStart(2, '0');
          
          if (feriadosMoveis[dataFormatada]) {
            return true;
          }
          
          return false;
        }
      ],
      onDayCreate: function(dObj, dStr, fp, dayElem) {
        const date = dayElem.dateObj;
        
        // Marca domingos
        if (date.getDay() === 0) {
          dayElem.classList.add('domingo');
          dayElem.title = "Domingo";
        }
        
        // Marca feriados fixos
        const dia = date.getDate();
        const mes = date.getMonth() + 1;
        
        const isFeriadoFixo = feriadosFixos.some(f => f.dia === dia && f.mes === mes);
        if (isFeriadoFixo) {
          dayElem.classList.add('feriado');
          dayElem.title = "Feriado Nacional";
        }
        
        // Marca feriados m√≥veis
        const dataFormatada = date.getFullYear() + '-' + 
                            String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(date.getDate()).padStart(2, '0');
        
        if (feriadosMoveis[dataFormatada]) {
          dayElem.classList.add('feriado-movel');
          dayElem.title = feriadosMoveis[dataFormatada];
        }
      }
    });

    // Fun√ß√£o para gerar um ID num√©rico aleat√≥rio √∫nico
    function gerarID() {
      const min = 10000; // N√∫mero m√≠nimo de 5 d√≠gitos
      const max = 99999; // N√∫mero m√°ximo de 5 d√≠gitos
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function formatarValor(valor) {
      return parseFloat(valor).toFixed(2)
        .replace('.', ',')
        .replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    async function calcularValor() {
      const operador = document.getElementById("operador").value;
      const tipo = document.getElementById("tipo").value;
      const diasTrabalhadosInput = document.getElementById("diasReais");
      const diasTrabalhados = parseInt(diasTrabalhadosInput.value) || 0;
      const faltasExtras = parseInt(document.getElementById("faltasDesconto").value) || 0;
      const descontoCaju = Math.max(parseFloat(document.getElementById("descontoCaju").value) || 0, 0);
      const outrosDescontos = Math.max(parseFloat(document.getElementById("outrosDescontos").value) || 0, 0);
      const justificativa = document.getElementById("justificativa").value;
      
      // Gerar ID num√©rico aleat√≥rio √∫nico para este c√°lculo
      const idCalculo = gerarID();

      if (!operador || !tipo || diasSelecionados.length === 0) {
        await Swal.fire({
          icon: 'warning',
          title: 'Campos obrigat√≥rios',
          text: 'Preencha todos os campos obrigat√≥rios.',
          confirmButtonColor: '#3085d6'
        });
        return;
      }

      if (diasTrabalhados === 0) {
        const { isConfirmed } = await Swal.fire({
          icon: 'question',
          title: 'Confirma√ß√£o necess√°ria',
          text: 'Dias trabalhados est√° como 0. Isso significa que o operador n√£o trabalhou nenhum dia. Deseja continuar?',
          showCancelButton: true,
          confirmButtonText: 'Sim, continuar',
          cancelButtonText: 'Cancelar',
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33'
        });
        
        if (!isConfirmed) {
          diasTrabalhadosInput.focus();
          return;
        }
      }

      if ((faltasExtras > 0 || descontoCaju > 0 || outrosDescontos > 0) && justificativa.trim() === "") {
        await Swal.fire({
          icon: 'warning',
          title: 'Justificativa necess√°ria',
          text: 'Por favor, justifique os descontos aplicados.',
          confirmButtonColor: '#3085d6'
        });
        return;
      }

      const valorMensal = tipo === "moto" ? 750 : 1500;
      const valorPorDia = valorMensal / diasSelecionados.length;
      const valorFinal = Math.max((valorPorDia * diasTrabalhados) - (faltasExtras * valorPorDia) - descontoCaju - outrosDescontos, 0);
      const totalDescontos = (faltasExtras * valorPorDia) + descontoCaju + outrosDescontos;

      document.getElementById("valorOperador").style.display = "block";
      document.getElementById("valorOperador").innerText = `üí∞ Valor a receber: R$ ${formatarValor(valorFinal)} (ID: ${idCalculo})`;

      document.getElementById("resultado").style.display = "block";
      document.getElementById("resultado").innerHTML = `
        <div class="pdf-content resultado-compact">
          <div class="pdf-header">
            <div class="pdf-title">Comprovante de Aluguel de Ve√≠culo</div>
            <div class="pdf-subtitle">${new Date().toLocaleDateString('pt-BR')} | ID: ${idCalculo}</div>
          </div>
          <table>
            <tr><th colspan="2" style="text-align:center;background:var(--primary-color);color:white;">DADOS DO ALUGUEL</th></tr>
            <tr><td style="width:50%;"><strong>Operador:</strong></td><td>${operador}</td></tr>
            <tr><td><strong>Tipo de Ve√≠culo:</strong></td><td>${tipo === "moto" ? "Moto" : "Carro"} (R$ ${formatarValor(valorMensal)})</td></tr>
            <tr><td><strong>Per√≠odo:</strong></td><td>${diasSelecionados.length} dias √∫teis</td></tr>
            
            <tr><th colspan="2" style="text-align:center;background:var(--primary-color);color:white;">C√ÅLCULO</th></tr>
            <tr><td><strong>Valor por dia:</strong></td><td>R$ ${formatarValor(valorPorDia)}</td></tr>
            <tr><td><strong>Dias trabalhados:</strong></td><td>${diasTrabalhados}</td></tr>
            <tr><td><strong>Valor bruto:</strong></td><td>R$ ${formatarValor(valorPorDia * diasTrabalhados)}</td></tr>
            
            <tr><th colspan="2" style="text-align:center;background:var(--primary-color);color:white;">DESCONTOS</th></tr>
            <tr><td><strong>Faltas extras (${faltasExtras} dias):</strong></td><td>R$ ${formatarValor(faltasExtras * valorPorDia)}</td></tr>
            <tr><td><strong>Desconto CAJU:</strong></td><td>R$ ${formatarValor(descontoCaju)}</td></tr>
            <tr><td><strong>Outros descontos:</strong></td><td>R$ ${formatarValor(outrosDescontos)}</td></tr>
            <tr><td><strong>Total descontos:</strong></td><td>R$ ${formatarValor(totalDescontos)}</td></tr>
            
            <tr class="total-row"><td><strong>VALOR L√çQUIDO:</strong></td><td><strong>R$ ${formatarValor(valorFinal)}</strong></td></tr>
            
            ${justificativa ? `<tr><th colspan="2" style="text-align:center;background:var(--light-gray);">JUSTIFICATIVA</th></tr>
            <tr><td colspan="2">${justificativa}</td></tr>` : ''}
            
            <tr><td colspan="2" style="text-align:center;font-size:0.8rem;padding-top:15px;">
              Sistema de Aluguel de Ve√≠culos - ${new Date().getFullYear()} | ID: ${idCalculo}
            </td></tr>
          </table>
        </div>`;

      salvarHistorico({
        id: idCalculo,
        operador, tipo, diasPrevistos: diasSelecionados.length, diasTrabalhados,
        valorPorDia: valorPorDia.toFixed(2), faltasExtras, descontoCaju, outrosDescontos,
        justificativa, valorFinal: valorFinal.toFixed(2)
      });

      await Swal.fire({
        icon: 'success',
        title: 'C√°lculo conclu√≠do!',
        text: `O valor do aluguel foi calculado com sucesso. ID: ${idCalculo}`,
        confirmButtonColor: '#3085d6'
      });
    }

    function salvarHistorico(dados) {
      const historico = JSON.parse(localStorage.getItem("historicoAluguel") || "[]");
      historico.push({ ...dados, data: new Date().toLocaleString("pt-BR") });
      localStorage.setItem("historicoAluguel", JSON.stringify(historico));
      atualizarFiltroOperadores();
      mostrarHistorico();
    }

    function mostrarHistorico() {
      const filtro = document.getElementById("filtroOperador").value;
      const historico = JSON.parse(localStorage.getItem("historicoAluguel") || "[]");
      const filtrado = filtro ? historico.filter(h => h.operador === filtro) : historico;

      let html = `<div class="pdf-content">
        <div class="pdf-header">
          <div class="pdf-title">Hist√≥rico de Aluguel de Ve√≠culos</div>
          <div class="pdf-subtitle">${new Date().toLocaleDateString('pt-BR')}</div>
        </div>
        <table><thead><tr>
          <th>ID</th>
          <th>Data</th><th>Operador</th><th>Tipo</th><th>Dias Prev.</th><th>Dias Trab.</th>
          <th>Valor/Dia</th><th>Descontos</th><th>Valor Final</th>
          <th class="no-print">A√ß√µes</th>
        </tr></thead><tbody>`;

      for (let i = filtrado.length - 1; i >= 0; i--) {
        const h = filtrado[i];
        const totalDescontos = (h.faltasExtras * parseFloat(h.valorPorDia)) + h.descontoCaju + h.outrosDescontos;
        const idxOriginal = historico.findIndex(x =>
          x.data === h.data &&
          x.operador === h.operador &&
          x.tipo === h.tipo &&
          x.valorFinal === h.valorFinal
        );

        html += `<tr>
          <td>${h.id}</td>
          <td>${h.data.split(',')[0]}</td><td>${h.operador}</td><td>${h.tipo === "moto" ? "Moto" : "Carro"}</td><td>${h.diasPrevistos}</td>
          <td>${h.diasTrabalhados}</td><td>R$ ${parseFloat(h.valorPorDia).toFixed(2).replace('.', ',')}</td>
          <td>R$ ${totalDescontos.toFixed(2).replace('.', ',')}</td>
          <td>R$ ${parseFloat(h.valorFinal).toFixed(2).replace('.', ',')}</td>
          <td class="no-print"><button class="btn-excluir" onclick="confirmarExclusaoRegistro(${idxOriginal})">Excluir</button></td>
        </tr>`;
      }

      html += "</tbody></table></div>";
      document.getElementById("historicoContainer").innerHTML = html;
      document.getElementById("historicoContainer").style.display = filtrado.length > 0 ? "block" : "none";
    }

    async function confirmarExclusaoRegistro(index) {
      const { isConfirmed } = await Swal.fire({
        title: 'Tem certeza?',
        text: "Voc√™ n√£o poder√° reverter esta a√ß√£o!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Sim, excluir!',
        cancelButtonText: 'Cancelar'
      });
      
      if (isConfirmed) {
        const historico = JSON.parse(localStorage.getItem("historicoAluguel") || "[]");
        historico.splice(index, 1);
        localStorage.setItem("historicoAluguel", JSON.stringify(historico));
        
        await Swal.fire({
          icon: 'success',
          title: 'Exclu√≠do!',
          text: 'O registro foi removido com sucesso.',
          confirmButtonColor: '#3085d6'
        });
        
        mostrarHistorico();
      }
    }

    async function confirmarLimpezaHistorico() {
      const { isConfirmed } = await Swal.fire({
        title: 'Tem certeza absoluta?',
        text: "Isso apagar√° TODOS os registros permanentemente!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim, limpar tudo!',
        cancelButtonText: 'Cancelar'
      });
      
      if (isConfirmed) {
        localStorage.removeItem("historicoAluguel");
        
        await Swal.fire({
          icon: 'success',
          title: 'Hist√≥rico limpo!',
          text: 'Todos os registros foram removidos com sucesso.',
          confirmButtonColor: '#3085d6'
        });
        
        mostrarHistorico();
      }
    }

    function atualizarFiltroOperadores() {
      const historico = JSON.parse(localStorage.getItem("historicoAluguel") || "[]");
      const operadores = [...new Set(historico.map(h => h.operador))];
      const select = document.getElementById("filtroOperador");
      select.innerHTML = `<option value="">Todos os Operadores</option>`;
      operadores.forEach(op => {
        const opt = document.createElement("option");
        opt.value = op;
        opt.textContent = op;
        select.appendChild(opt);
      });
    }

    function exportarPDF() {
      const elemento = document.querySelector(".resultado");
      if (!elemento) return;
      
      const opt = {
        margin: [0, 0, 0, 0],
        filename: 'comprovante_aluguel_veiculo.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 7,
          logging: false,
          useCORS: true
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'portrait',
          putOnlyUsedFonts: true
        }
      };
      
      // Gera o PDF com as margens ajustadas
      html2pdf().set(opt).from(elemento).save();
    }

    async function exportarHistoricoPDF() {
      // Obter todos os dados do hist√≥rico
      const historico = JSON.parse(localStorage.getItem("historicoAluguel") || "[]");
      
      // Verificar se h√° registros para exportar
      if (historico.length === 0) {
        await Swal.fire({
          icon: 'warning',
          title: 'Nenhum registro',
          text: 'N√£o h√° registros no hist√≥rico para exportar.',
          confirmButtonColor: '#3085d6'
        });
        return;
      }
      
      // Ordenar do mais recente para o mais antigo
      historico.sort((a, b) => new Date(b.data) - new Date(a.data));
      
      // Criar o conte√∫do HTML para o PDF
      let html = `
        <div style="font-family: Arial, sans-serif; padding: 10px;">
          <h1 style="text-align: center; color: var(--primary-color);">ALUGUEL DE VE√çCULOS - HIST√ìRICO COMPLETO</h1>
          <div style="text-align: center; margin-bottom: 15px; color: #555;">
            Gerado em ${new Date().toLocaleDateString('pt-BR')} - Total de registros: ${historico.length}
          </div>
          <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
            <thead>
              <tr style="background-color: var(--light-gray);">
                <th style="border: 1px solid var(--border-color); padding: 5px;">ID</th>
                <th style="border: 1px solid var(--border-color); padding: 5px;">Data</th>
                <th style="border: 1px solid var(--border-color); padding: 5px;">Operador</th>
                <th style="border: 1px solid var(--border-color); padding: 5px;">Tipo</th>
                <th style="border: 1px solid var(--border-color); padding: 5px;">Dias Prev.</th>
                <th style="border: 1px solid var(--border-color); padding: 5px;">Dias Trab.</th>
                <th style="border: 1px solid var(--border-color); padding: 5px;">Valor/Dia</th>
                <th style="border: 1px solid var(--border-color); padding: 5px;">Descontos</th>
                <th style="border: 1px solid var(--border-color); padding: 5px;">Valor Final</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      // Adicionar cada registro ao HTML
      historico.forEach(h => {
        const totalDescontos = (h.faltasExtras * parseFloat(h.valorPorDia)) + h.descontoCaju + h.outrosDescontos;
        html += `
          <tr>
            <td style="border: 1px solid var(--border-color); padding: 5px;">${h.id}</td>
            <td style="border: 1px solid var(--border-color); padding: 5px;">${h.data.split(',')[0]}</td>
            <td style="border: 1px solid var(--border-color); padding: 5px;">${h.operador}</td>
            <td style="border: 1px solid var(--border-color); padding: 5px;">${h.tipo === "moto" ? "Moto" : "Carro"}</td>
            <td style="border: 1px solid var(--border-color); padding: 5px; text-align: center;">${h.diasPrevistos}</td>
            <td style="border: 1px solid var(--border-color); padding: 5px; text-align: center;">${h.diasTrabalhados}</td>
            <td style="border: 1px solid var(--border-color); padding: 5px; text-align: right;">R$ ${parseFloat(h.valorPorDia).toFixed(2).replace('.', ',')}</td>
            <td style="border: 1px solid var(--border-color); padding: 5px; text-align: right;">R$ ${totalDescontos.toFixed(2).replace('.', ',')}</td>
            <td style="border: 1px solid var(--border-color); padding: 5px; text-align: right;">R$ ${parseFloat(h.valorFinal).toFixed(2).replace('.', ',')}</td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
          <div style="text-align: center; margin-top: 15px; font-size: 10px; color: #777;">
            Sistema de Aluguel de Ve√≠culos - ${new Date().getFullYear()}
          </div>
        </div>
      `;
      
      // Criar um elemento tempor√°rio para gerar o PDF
      const element = document.createElement('div');
      element.innerHTML = html;
      document.body.appendChild(element);
      
      // Configura√ß√µes para o PDF
      const opt = {
        margin: [10, 10, 10, 10],
        filename: 'historico_completo_aluguel.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 2,
          logging: true,
          useCORS: true,
          scrollX: 0,
          scrollY: 0
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'landscape',
          putOnlyUsedFonts: true
        }
      };
      
      // Gerar o PDF
      html2pdf().set(opt).from(element).save().then(() => {
        // Remover o elemento tempor√°rio ap√≥s a gera√ß√£o do PDF
        document.body.removeChild(element);
        
        Swal.fire({
          icon: 'success',
          title: 'PDF gerado!',
          text: 'O hist√≥rico foi exportado com sucesso.',
          confirmButtonColor: '#3085d6'
        });
      });
    }

    function salvarNoGoogleSheets(dados) {
      const url = "https://script.google.com/macros/s/AKfycbyfhztX3ZILYcyS7DkS_rVfEWruituv86SY71gk3cgjx563BEC6YzXkOhOfcb4hcqo2QQ/exec";
      
      const payload = {
        operador: dados.operador,
        tipo: dados.tipo,
        diasPrevistos: dados.diasPrevistos,
        diasTrabalhados: dados.diasTrabalhados,
        valorPorDia: dados.valorPorDia,
        faltasExtras: dados.faltasExtras || 0,
        descontoCaju: dados.descontoCaju || 0,
        outrosDescontos: dados.outrosDescontos || 0,
        justificativa: dados.justificativa || '',
        valorFinal: dados.valorFinal,
        dataRegistro: dados.dataRegistro || new Date().toISOString()
      };

      fetch(url, {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(payload)
      })
      .then(() => console.log("Dados enviados para o Google Sheets com sucesso!"))
      .catch(error => console.error("Erro ao enviar para o Google Sheets:", error));
    }

    async function sincronizarHistoricoCompleto() {
      const historico = JSON.parse(localStorage.getItem("historicoAluguel") || "[]");
      
      // Verificar se h√° registros para sincronizar
      if (historico.length === 0) {
        await Swal.fire({
          icon: 'warning',
          title: 'Nenhum registro',
          text: 'N√£o h√° registros no hist√≥rico para sincronizar.',
          confirmButtonColor: '#3085d6'
        });
        return;
      }
      
      const { isConfirmed } = await Swal.fire({
        title: 'Confirmar sincroniza√ß√£o',
        html: `Deseja sincronizar <b>${historico.length}</b> registros com a planilha?<br><small>Esta opera√ß√£o pode levar alguns minutos.</small>`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sim, sincronizar',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33'
      });
      
      if (!isConfirmed) return;
      
      const loadingSwal = Swal.fire({
        title: 'Sincronizando...',
        html: `Enviando <b>0/${historico.length}</b> registros`,
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      // Enviar cada registro individualmente
      let enviados = 0;
      const promises = historico.map((registro, index) => {
        return new Promise(resolve => {
          setTimeout(async () => {
            try {
              await salvarNoGoogleSheets(registro);
              enviados++;
              
              if (loadingSwal.isVisible()) {
                Swal.update({
                  html: `Enviando <b>${enviados}/${historico.length}</b> registros`
                });
              }
              
              resolve(true);
            } catch (error) {
              resolve(false);
            }
          }, index * 500); // 500ms de intervalo entre requisi√ß√µes
        });
      });
      
      Promise.all(promises).then(results => {
        const sucessos = results.filter(Boolean).length;
        const falhas = historico.length - sucessos;
        
        Swal.fire({
          title: 'Sincroniza√ß√£o conclu√≠da!',
          html: `Resultado:<br><br>
                <b>${sucessos}</b> registros sincronizados com sucesso<br>
                <b>${falhas}</b> registros n√£o sincronizados`,
          icon: sucessos === historico.length ? 'success' : falhas === historico.length ? 'error' : 'warning',
          confirmButtonColor: '#3085d6'
        });
      });
    }

    // Atualiza filtro ao carregar
    atualizarFiltroOperadores();
    mostrarHistorico();
  </script>
</body>
</html>
