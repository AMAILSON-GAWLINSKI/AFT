<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Aluguel de Veículos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    :root {
      --primary: #2E86C1;
      --danger: #E74C3C;
      --success: #28B463;
      --warning: #F39C12;
      --gray: #F2F2F2;
    }
    
    /* Reset e estilos base */
    * {
      box-sizing: border-box;
      transition: all 0.2s ease;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      color: #333;
      min-height: 100vh;
      padding: 15px;
      margin: 0;
    }

    .container {
      max-width: 1100px;
      width: 100%;
      margin: 0 auto;
      background: #ffffff;
      min-height: 100vh;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    h1, h2, h3 {
      text-align: center;
      color: #38a738c9;
      margin-top: 0;
    }
    
    h1 {
      font-size: 1.8rem;
      margin-bottom: 20px;
    }
    
    h2 {
      font-size: 1.5rem;
    }
    
    h3 {
      font-size: 1.3rem;
    }

    /* Estilos do formulário */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-col {
      flex: 1;
      min-width: 200px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* Estilos de cards e tabelas */
    .card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      font-size: 0.85rem;
    }

    th {
      background-color: var(--primary);
      color: white;
      padding: 10px;
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: 0.9rem;
    }

    td { 
      padding: 8px; 
      border-bottom: 1px solid #ddd; 
      text-align: center;
    }

    /* Botões */
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.9rem;
      white-space: nowrap;
      min-width: 120px;
      text-align: center;
    }

    .btn-primary { background-color: var(--primary); }
    .btn-secondary { background-color: #5A5A5A; }
    .btn-success { background-color: var(--success); }
    .btn-danger { background-color: var(--danger); }
    .btn-warning { background-color: var(--warning); color: #212529; }
    .btn-info { background-color: #17a2b8; }
    .btn-gray { background-color: #888; }
    
    .btn:hover {
      opacity: 0.9;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      width: 100%;
    }

    /* Resultado e resumo */
    #resultado {
      margin-top: 15px;
      padding: 15px;
      background: #e9f7ef;
      border-left: 5px solid #2e7d32;
      border-radius: 8px;
      display: none;
      line-height: 1.6;
    }

    #resumo {
      margin-top: 15px;
      padding: 15px;
      background: #eef;
      border-radius: 8px;
      overflow-x: auto;
    }
    
    /* Estilo para os botões de ação */
    .btn-excluir {
      background-color: #E74C3C;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 8px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    
    .btn-editar {
      background-color: #2E86C1;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 8px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-right: 5px;
    }
    
    .btn-excluir:hover, .btn-editar:hover {
      opacity: 0.8;
    }
    
    /* Estilo para o popup */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .popup-container {
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      max-width: 90%;
      width: 400px;
      text-align: center;
      animation: fadeIn 0.3s;
    }
    
    .popup-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 15px;
    }
    
    .popup-message {
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .popup-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }
    
    .popup-button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      min-width: 80px;
      transition: all 0.2s;
    }
    
    .popup-button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .popup-confirm {
      background-color: var(--success);
      color: white;
    }
    
    .popup-cancel {
      background-color: var(--danger);
      color: white;
    }
    
    .popup-ok {
      background-color: var(--primary);
      color: white;
      width: 100%;
    }
    
    .popup-highlight {
      font-weight: bold;
      color: var(--danger);
    }
    
    .popup-details {
      background-color: #F8F9F9;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: left;
      font-size: 0.9rem;
    }
    
    .popup-details-item {
      margin-bottom: 5px;
    }
    
    .popup-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    .popup-success .popup-title {
      color: var(--success);
    }
    
    .popup-warning .popup-title {
      color: var(--warning);
    }
    
    .popup-error .popup-title {
      color: var(--danger);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .form-col {
        min-width: 100%;
      }
      
      .btn {
        padding: 10px 8px;
        font-size: 0.8rem;
        min-width: 100px;
      }
      
      .btn-editar, .btn-excluir {
        padding: 4px 6px;
        font-size: 0.7rem;
      }
      
      .popup-container {
        width: 90%;
        padding: 15px;
      }
      
      .popup-title {
        font-size: 1.1rem;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      .card {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .popup-buttons {
        flex-direction: column;
        gap: 10px;
      }
      
      .popup-button {
        width: 100%;
      }
      
      .btn-row {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
    
    /* Ajuste para os botões principais */
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .btn-principal {
      flex: 1;
      min-width: 150px;
    }

    /* Estilo para o calendário flatpickr - ATUALIZADO */
    .flatpickr-day.selected {
      background: #28B463 !important;
      color: white !important;
      border: none !important;
      border-radius: 0 !important;
      box-shadow: none !important;
    }

    .flatpickr-day.feriado, 
    .flatpickr-day.feriado-movel,
    .flatpickr-day.domingo {
      background-color: #f5c6cb !important;
      color: #721c24 !important;
      cursor: not-allowed !important;
      font-weight: bold !important;
      border: none !important;
      border-radius: 0 !important;
      text-decoration: line-through !important;
    }
    
    .flatpickr-day.feriado:hover, 
    .flatpickr-day.feriado-movel:hover,
    .flatpickr-day.domingo:hover {
      background-color: #f5c6cb !important;
    }

    .flatpickr-day {
      border-radius: 0 !important;
    }

    /* Valor em destaque */
    .valor-destaque {
      background: #dff0d8;
      color: #155724;
      padding: 15px;
      border-radius: 6px;
      font-size: 1.2rem;
      text-align: center;
      margin-top: 20px;
    }

    /* Para impressão */
    @media print {
      .no-print {
        display: none !important;
      }
      
      body {
        background: white;
        padding: 0;
      }
      
      .container {
        box-shadow: none;
        background: white;
        padding: 10px;
      }
      
      .btn {
        display: none !important;
      }
    }
    
    /* Estilo para o campo de exportação PDF */
    .export-pdf-container {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px dashed #ccc;
      text-align: center;
    }
    
    .export-pdf-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #2E86C1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ALUGUEL DE VEÍCULOS</h1>
    
    <!-- Formulário principal -->
    <div class="card">
      <div class="form-row">
        <div class="form-col">
          <label>👷 Operador:</label>
          <select id="operador">
            <option value="">Selecione um operador</option>
            <option>Caio José</option>
            <option>Daniel Rodrigo</option>
            <option>Igor Nascimento</option>
            <option>Lissandro da Silva</option>
            <option>Leonardo Vaz</option>
            <option>Patrick Darlan</option>
            <option>Ricardo Alves</option>
            <option>Luana Parcianello</option>
            <option>Keniel Vasque</option>
            <option>TESTE</option>
          </select>
        </div>
        <div class="form-col">
          <label>🚗 Tipo de Veículo:</label>
          <select id="tipo">
            <option value="">Selecione o tipo</option>
            <option value="moto">Moto (R$ 750)</option>
            <option value="carro">Carro (R$ 1500)</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <label>📅 Dias previstos:</label>
          <input type="text" id="faltas" placeholder="Clique e selecione os dias úteis" />
        </div>
        <div class="form-col">
          <label>✅ Dias reais trabalhados:</label>
          <input type="number" id="diasReais" min="0" placeholder="Nº de dias trabalhados" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <label>📉 Faltas a descontar:</label>
          <input type="number" id="faltasDesconto" min="0" placeholder="Nº de faltas" />
        </div>
        <div class="form-col">
          <label>🍊 Desconto CAJU (R$):</label>
          <input type="number" id="descontoCaju" step="0.01" min="0" placeholder="Valor do desconto" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <label>💰 Outros Descontos (R$):</label>
          <input type="number" id="outrosDescontos" step="0.01" min="0" placeholder="Outros descontos" />
        </div>
        <div class="form-col">
          <label>📝 Justificativa:</label>
          <textarea id="justificativa" placeholder="Obrigatória se houver desconto."></textarea>
        </div>
      </div>

      <div class="btn-container">
        <button onclick="calcularValor()" class="btn btn-success btn-principal">CALCULAR</button>
        <button id="btnExportar" onclick="exportarPDF()" class="btn btn-info btn-principal" style="display: none;">📄 SALVAR CÁLCULO</button>
        <button id="btnExportarCompleto" onclick="exportarPDFCompleto()" class="btn btn-secondary btn-principal" style="display: none;">📤 SALVAR HISTÓRICO</button>
        <button id="btnAtualizarDados" class="btn btn-warning btn-principal" onclick="carregarDados(); sincronizarItensLocais();" title="Atualiza dados do servidor e sincroniza alterações locais">🔄 ATUALIZAR</button>
      </div>
    </div>

    <div id="resultado" class="card"></div>
    
    <!-- Campo para exportar em PDF - NOVO -->
    <div id="exportarPDFContainer" class="export-pdf-container" style="display: none;">
      <div class="export-pdf-title">📄 Exportar Cálculo em PDF</div>
      <button onclick="exportarPDF()" class="btn btn-primary">Exportar PDF</button>
    </div>
    
    <!-- Filtros -->
    <div class="card">
      <h3>🔍 Filtros</h3>
      <div class="form-row">
        <div class="form-col">
          <label>Operador:</label>
          <select id="filtroOperador">
            <option value="Todos">TODOS os operadores</option>
          </select>
        </div>
        <div class="form-col">
          <label>Data:</label>
          <input type="month" id="filtroData" value="">
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="filtrarHistorico()">Aplicar Filtros</button>
        <button class="btn btn-gray" onclick="limparFiltros()">Limpar Filtros</button>
      </div>
    </div>
    
    <!-- Tabela de histórico -->
    <div class="card">
      <div style="overflow-x: auto;">
        <table id="tabelaHistorico">
          <thead>
            <tr>
              <th>ID</th>
              <th>Operador</th>
              <th>Tipo</th>
              <th>Dias Prev.</th>
              <th>Dias Trab.</th>
              <th>Faltas</th>
              <th>Total (R$)</th>
              <th>Data/Hora</th>
              <th class="no-print">Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <!-- Resumo -->
    <div id="resumo" class="card">
      <h3>📈 Resumo dos Valores</h3>
      <div id="resumoConteudo"></div>
    </div>
  </div>

  <script>
    // Configurações do Supabase
    const SUPABASE_URL = "https://nsfliimhsokyzhacnfdg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhbmFzZSIsInJlZiI6Im5zZmxpaW1oc29reXpoYWNuZmRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczNDg3MzQsImV4cCI6MjA2MjkyNDczNH0.QqosDhPG2xK16rAfitDiW837GMIL_dh5lmDwg8cOn_8";
    const { jsPDF } = window.jspdf;
    
    // Variáveis globais
    let historicoAluguel = [];
    let diasSelecionados = [];
    let editandoId = null;

    // Feriados fixos (dia/mês)
    const feriadosFixos = [
      { dia: 1, mes: 1 },   // Ano Novo
      { dia: 21, mes: 4 },  // Tiradentes
      { dia: 1, mes: 5 },   // Dia do Trabalho
      { dia: 7, mes: 9 },   // Independência
      { dia: 12, mes: 10 }, // Nossa Senhora Aparecida
      { dia: 2, mes: 11 },  // Finados
      { dia: 15, mes: 11 }, // Proclamação da República
      { dia: 25, mes: 12 }  // Natal
    ];

    // Feriados móveis (ano específico)
    const feriadosMoveis = {
      "2025-03-04": "Carnaval",
      "2025-04-18": "Sexta-feira Santa",
      "2025-06-19": "Corpus Christi"
    };

    // Configuração do flatpickr com os dias bloqueados
    flatpickr("#faltas", {
      mode: "multiple", 
      dateFormat: "Y-m-d", 
      locale: "pt",
      onChange: selected => diasSelecionados = selected,
      disable: [
        function(date) {
          // Verifica se é domingo (0 = Domingo, 1 = Segunda, ..., 6 = Sábado)
          if (date.getDay() === 0) {
            return true;
          }
          
          // Verifica feriados fixos
          const dia = date.getDate();
          const mes = date.getMonth() + 1; // getMonth() retorna 0-11
          
          const isFeriadoFixo = feriadosFixos.some(f => f.dia === dia && f.mes === mes);
          if (isFeriadoFixo) {
            return true;
          }
          
          // Verifica feriados móveis
          const dataFormatada = date.getFullYear() + '-' + 
                              String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                              String(date.getDate()).padStart(2, '0');
          
          if (feriadosMoveis[dataFormatada]) {
            return true;
          }
          
          return false;
        }
      ],
      onDayCreate: function(dObj, dStr, fp, dayElem) {
        const date = dayElem.dateObj;
        
        // Marca domingos
        if (date.getDay() === 0) {
          dayElem.classList.add('domingo');
          dayElem.title = "Domingo";
        }
        
        // Marca feriados fixos
        const dia = date.getDate();
        const mes = date.getMonth() + 1;
        
        const isFeriadoFixo = feriadosFixos.some(f => f.dia === dia && f.mes === mes);
        if (isFeriadoFixo) {
          dayElem.classList.add('feriado');
          dayElem.title = "Feriado Nacional";
        }
        
        // Marca feriados móveis
        const dataFormatada = date.getFullYear() + '-' + 
                            String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(date.getDate()).padStart(2, '0');
        
        if (feriadosMoveis[dataFormatada]) {
          dayElem.classList.add('feriado-movel');
          dayElem.title = feriadosMoveis[dataFormatada];
        }
      }
    });

    // Função para gerar ID único
    function gerarID() {
      const min = 10000;
      const max = 99999;
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    // Função para formatar valores monetários
    function formatarValor(valor) {
      return parseFloat(valor).toFixed(2)
        .replace('.', ',')
        .replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    // Função para editar um registro no Supabase
    async function editarRegistroSupabase(id, dadosAtualizados) {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/aluguel_veiculos?id=eq.${id}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_KEY,
            "Authorization": `Bearer ${SUPABASE_KEY}`
          },
          body: JSON.stringify(dadosAtualizados)
        });

        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.error("Erro ao editar registro:", error);
        throw error;
      }
    }
    
    // Função para calcular o valor do aluguel
    async function calcularValor() {
      const operador = document.getElementById("operador").value;
      const tipo = document.getElementById("tipo").value;
      const diasTrabalhadosInput = document.getElementById("diasReais");
      const diasTrabalhados = parseInt(diasTrabalhadosInput.value) || 0;
      const faltasExtras = parseInt(document.getElementById("faltasDesconto").value) || 0;
      const descontoCaju = Math.max(parseFloat(document.getElementById("descontoCaju").value) || 0, 0);
      const outrosDescontos = Math.max(parseFloat(document.getElementById("outrosDescontos").value) || 0, 0);
      const justificativa = document.getElementById("justificativa").value;
      
      // Verificações de campos obrigatórios
      if (!operador) { 
        mostrarPopup('Atenção', 'Por favor, selecione um operador.', 'error');
        return; 
      }
      
      if (!tipo) { 
        mostrarPopup('Atenção', 'Por favor, selecione o tipo de veículo.', 'error');
        return; 
      }
      
      if (diasSelecionados.length === 0) { 
        mostrarPopup('Atenção', 'Por favor, selecione os dias previstos.', 'error');
        return; 
      }
      
      if (diasTrabalhados === 0) {
        const confirmar = await mostrarPopupConfirmacao(
          "Atenção",
          "Dias trabalhados está como 0. Isso significa que o operador não trabalhou nenhum dia. Deseja continuar?",
          { "Operador": operador }
        );
        
        if (!confirmar) {
          diasTrabalhadosInput.focus();
          return;
        }
      }
      
      if ((faltasExtras > 0 || descontoCaju > 0 || outrosDescontos > 0) && justificativa.trim() === "") {
        mostrarPopup('Atenção', 'Por favor, justifique os descontos aplicados.', 'error');
        return;
      }

      const valorMensal = tipo === "moto" ? 750 : 1500;
      const valorPorDia = valorMensal / diasSelecionados.length;
      const valorFinal = Math.max((valorPorDia * diasTrabalhados) - (faltasExtras * valorPorDia) - descontoCaju - outrosDescontos, 0);
      const totalDescontos = (faltasExtras * valorPorDia) + descontoCaju + outrosDescontos;
      
      // Gerar ID único para este cálculo
      const idCalculo = editandoId || gerarID();
      const timestamp = new Date().toISOString();
      
      // Formatando o período para exibição
      const primeiroDia = new Date(diasSelecionados[0]);
      const ultimoDia = new Date(diasSelecionados[diasSelecionados.length - 1]);
      const periodo = `${primeiroDia.toLocaleDateString('pt-BR')} a ${ultimoDia.toLocaleDateString('pt-BR')}`;

      // Exibir resultado
      const resultadoDiv = document.getElementById("resultado");
      resultadoDiv.style.display = "block";
      resultadoDiv.innerHTML = `
        <h4>${editandoId ? 'Cálculo Atualizado' : 'Resultado do Cálculo'}</h4>
        <p><strong>ID do Cálculo:</strong> ${idCalculo}</p>
        <p><strong>Operador:</strong> ${operador}</p>
        <p><strong>Período:</strong> ${periodo}</p>
        
        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
          <h5 style="margin-bottom: 10px; color: #2E86C1;">Detalhes do Cálculo</h5>
          <p><strong>Tipo de Veículo:</strong> ${tipo === "moto" ? "Moto" : "Carro"} (R$ ${valorMensal.toFixed(2)})</p>
          <p><strong>Dias Previstos:</strong> ${diasSelecionados.length} dias × R$ ${valorPorDia.toFixed(2)} = <strong>R$ ${valorMensal.toFixed(2)}</strong></p>
          <p><strong>Dias Trabalhados:</strong> ${diasTrabalhados} dias × R$ ${valorPorDia.toFixed(2)} = <strong>R$ ${(valorPorDia * diasTrabalhados).toFixed(2)}</strong></p>
          
          ${totalDescontos > 0 ? `
            <p><strong>Descontos:</strong></p>
            <ul style="margin-left: 20px;">
              ${faltasExtras > 0 ? `<li>Faltas extras (${faltasExtras} dias): R$ ${(faltasExtras * valorPorDia).toFixed(2)}</li>` : ''}
              ${descontoCaju > 0 ? `<li>Desconto CAJU: R$ ${descontoCaju.toFixed(2)}</li>` : ''}
              ${outrosDescontos > 0 ? `<li>Outros descontos: R$ ${outrosDescontos.toFixed(2)}</li>` : ''}
            </ul>
            <p><strong>Total Descontos:</strong> R$ ${totalDescontos.toFixed(2)}</p>
          ` : ''}
          
          <p style="margin-top: 10px;">
            <strong style="color: #28a745; font-size: 1.1em;">VALOR LÍQUido:</strong> R$ ${valorFinal.toFixed(2)}
          </p>
        </div>
        
        ${justificativa ? `
        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
          <h5 style="margin-bottom: 10px; color: #2E86C1;">📝 Justificativa</h5>
          <p>${justificativa}</p>
        </div>
        ` : ''}
      `;

      // Mostrar o campo de exportação em PDF
      document.getElementById('exportarPDFContainer').style.display = 'block';
      
      // Dados para salvar no Supabase
      const dadosParaSalvar = {
        id: idCalculo,
        timestamp: timestamp,
        operador: operador,
        tipo_veiculo: tipo,
        valor_mensal: valorMensal.toFixed(2),
        dias_previstos: diasSelecionados.length,
        dias_trabalhados: diasTrabalhados,
        valor_por_dia: valorPorDia.toFixed(2),
        faltas_extras: faltasExtras,
        desconto_caju: descontoCaju.toFixed(2),
        outros_descontos: outrosDescontos.toFixed(2),
        total_descontos: totalDescontos.toFixed(2),
        valor_final: valorFinal.toFixed(2),
        justificativa: justificativa,
        periodo: periodo,
        dias_selecionados: diasSelecionados.join(', ')
      };

      try {
        let response;
        if (editandoId) {
          // Atualiza o registro existente
          response = await editarRegistroSupabase(idCalculo, dadosParaSalvar);
          
          // Remove o registro antigo do histórico local
          historicoAluguel = historicoAluguel.filter(item => item.id !== idCalculo);
        } else {
          // Cria um novo registro
          response = await fetch(`${SUPABASE_URL}/rest/v1/aluguel_veiculos`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "apikey": SUPABASE_KEY,
              "Authorization": `Bearer ${SUPABASE_KEY}`,
              "Prefer": "return=representation"
            },
            body: JSON.stringify(dadosParaSalvar)
          });
        }

        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }

        // Adiciona ao histórico local
        historicoAluguel.unshift({
          ...dadosParaSalvar,
          data: new Date(timestamp).toLocaleString('pt-BR')
        });

        // Salva no localStorage como backup
        localStorage.setItem('historicoAluguel', JSON.stringify(historicoAluguel));

        atualizarHistorico();
        atualizarFiltroOperadores();

        document.getElementById('btnExportar').style.display = 'block';
        document.getElementById('btnExportarCompleto').style.display = 'block';
        document.getElementById('btnAtualizarDados').style.display = 'inline-block';

        mostrarPopupAutomatico(
          editandoId ? 'Atualizado!' : 'Sucesso!', 
          editandoId ? 'Cálculo atualizado com sucesso!' : 'Cálculo salvo com sucesso no banco de dados.',
          'success'
        );
        
        // Limpa o modo de edição
        if (editandoId) {
          editandoId = null;
          limparCampos();
        }
      } catch (error) {
        console.error("Erro ao salvar no Supabase:", error);
        mostrarPopupAutomatico('Erro', 'Não foi possível salvar o cálculo. Os dados serão armazenados localmente.', 'error');
        
        // Adiciona ao histórico local mesmo em caso de erro
        historicoAluguel.unshift({
          ...dadosParaSalvar,
          data: new Date().toLocaleString('pt-BR')
        });
        localStorage.setItem('historicoAluguel', JSON.stringify(historicoAluguel));
        atualizarHistorico();
        atualizarFiltroOperadores();
      }
    }

    // Função para carregar dados do Supabase - ATUALIZADA
    async function carregarDados() {
      try {
        // Tenta carregar do Supabase
        const response = await fetch(`${SUPABASE_URL}/rest/v1/aluguel_veiculos?select=*&order=timestamp.desc`, {
          headers: {
            "apikey": SUPABASE_KEY,
            "Authorization": `Bearer ${SUPABASE_KEY}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const dadosSupabase = await response.json();
        
        // Verifica se há dados no Supabase
        if (dadosSupabase && dadosSupabase.length > 0) {
          // Verifica se há dados locais não sincronizados
          const historicoSalvo = localStorage.getItem('historicoAluguel');
          let dadosLocais = [];
          
          if (historicoSalvo) {
            dadosLocais = JSON.parse(historicoSalvo);
            
            // Filtra apenas os itens locais que não existem no Supabase
            const itensNaoSincronizados = dadosLocais.filter(itemLocal => 
                !dadosSupabase.some(itemSupabase => itemSupabase.id === itemLocal.id)
            );
            
            // Combina os dados (Supabase + itens locais não sincronizados)
            historicoAluguel = [
                ...dadosSupabase.map(item => ({
                    ...item,
                    data: new Date(item.timestamp).toLocaleString('pt-BR')
                })),
                ...itensNaoSincronizados
            ];
          } else {
            historicoAluguel = dadosSupabase.map(item => ({
                ...item,
                data: new Date(item.timestamp).toLocaleString('pt-BR')
            }));
          }
          
          // Salva no localStorage como backup
          localStorage.setItem('historicoAluguel', JSON.stringify(historicoAluguel));
        } else {
          // Se não houver dados no Supabase, tenta carregar do localStorage
          const historicoSalvo = localStorage.getItem('historicoAluguel');
          if (historicoSalvo) {
            historicoAluguel = JSON.parse(historicoSalvo);
          }
        }
        
        // Mostra popup que fecha automaticamente
        mostrarPopupAutomatico('Dados Atualizados', 'Os dados foram carregados com sucesso.', 'success');
        
      } catch (error) {
        console.error("Erro ao carregar do Supabase, usando localStorage:", error);
        // Se houver erro, usa o localStorage como fallback
        const historicoSalvo = localStorage.getItem('historicoAluguel');
        if (historicoSalvo) {
          historicoAluguel = JSON.parse(historicoSalvo);
        }
        mostrarPopupAutomatico('Aviso', 'Dados carregados do cache local.', 'warning');
      }
      
      // Atualiza a interface
      atualizarHistorico();
      atualizarFiltroOperadores();
      
      // Define o mês atual como padrão no filtro
      const hoje = new Date();
      const mesAtual = hoje.getFullYear() + '-' + String(hoje.getMonth() + 1).padStart(2, '0');
      document.getElementById('filtroData').value = mesAtual;
    }

    // Função para sincronizar itens locais - NOVA
    async function sincronizarItensLocais() {
      try {
          const historicoSalvo = localStorage.getItem('historicoAluguel');
          if (!historicoSalvo) return;
          
          const dadosLocais = JSON.parse(historicoSalvo);
          
          // Verifica quais itens locais não existem no Supabase
          const response = await fetch(`${SUPABASE_URL}/rest/v1/aluguel_veiculos?select=id`, {
              headers: {
                  "apikey": SUPABASE_KEY,
                  "Authorization": `Bearer ${SUPABASE_KEY}`
              }
          });
          
          if (!response.ok) {
              throw new Error(`Erro HTTP: ${response.status}`);
          }
          
          const idsSupabase = (await response.json()).map(item => item.id);
          const itensParaSincronizar = dadosLocais.filter(item => !idsSupabase.includes(item.id));
          
          // Tenta enviar cada item não sincronizado
          for (const item of itensParaSincronizar) {
              await fetch(`${SUPABASE_URL}/rest/v1/aluguel_veiculos`, {
                  method: "POST",
                  headers: {
                      "Content-Type": "application/json",
                      "apikey": SUPABASE_KEY,
                      "Authorization": `Bearer ${SUPABASE_KEY}`,
                      "Prefer": "return=representation"
                  },
                  body: JSON.stringify(item)
              });
          }
          
          // Recarrega os dados após sincronização
          carregarDados();
          
      } catch (error) {
          console.error("Erro ao sincronizar itens locais:", error);
          mostrarPopupAutomatico('Atenção', 'Alguns itens locais não puderam ser sincronizados.', 'warning');
      }
    }

    // Função para mostrar popup que fecha automaticamente
    function mostrarPopupAutomatico(titulo, mensagem, tipo = 'info') {
      const popupDiv = document.createElement('div');
      popupDiv.className = 'popup-overlay';
      
      const icon = tipo === 'success' => '✅' : tipo === 'error' ? '❌' : 'ℹ️';
      const popupClass = tipo === 'success' ? 'popup-success' : 
                        tipo === 'error' ? 'popup-error' : 
                        tipo === 'warning' ? 'popup-warning' : '';
      
      popupDiv.innerHTML = `
        <div class="popup-container ${popupClass}">
          <div class="popup-icon">${icon}</div>
          <div class="popup-title">${titulo}</div>
          <div class="popup-message">${mensagem}</div>
          <div class="popup-buttons">
            <button class="popup-button popup-ok" id="popupAutoClose">OK</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(popupDiv);
      
      // Fecha automaticamente após 2 segundos
      const timer = setTimeout(() => {
        if (document.body.contains(popupDiv)) {
          document.body.removeChild(popupDiv);
        }
      }, 2000);
      
      // Fecha ao clicar no botão
      document.getElementById('popupAutoClose').addEventListener('click', () => {
        clearTimeout(timer);
        document.body.removeChild(popupDiv);
      });
    }

    // Função para mostrar popup de confirmação
    function mostrarPopupConfirmacao(titulo, mensagem, detalhes = null) {
      return new Promise((resolve) => {
        const popup = document.createElement('div');
        popup.className = 'popup-overlay';
        
        let detalhesHTML = '';
        if (detalhes) {
          detalhesHTML = `
            <div class="popup-details">
              ${Object.entries(detalhes).map(([key, value]) => `
                <div class="popup-details-item"><strong>${key}:</strong> ${value}</div>
              `).join('')}
            </div>
          `;
        }
        
        popup.innerHTML = `
          <div class="popup-container popup-warning">
            <div class="popup-icon">⚠️</div>
            <div class="popup-title">${titulo}</div>
            <div class="popup-message">${mensagem}</div>
            ${detalhesHTML}
            <div class="popup-buttons">
              <button class="popup-button popup-confirm" id="popupConfirm">Sim</button>
              <button class="popup-button popup-cancel" id="popupCancel">Não</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(popup);
        
        document.getElementById('popupConfirm').addEventListener('click', () => {
          document.body.removeChild(popup);
          resolve(true);
        });
        
        document.getElementById('popupCancel').addEventListener('click', () => {
          document.body.removeChild(popup);
          resolve(false);
        });
      });
    }

    // Função para atualizar o histórico na tela
    function atualizarHistorico() {
      const tbody = document.querySelector("#tabelaHistorico tbody");
      tbody.innerHTML = '';

      const historicoFiltrado = filtrarListaHistorico();

      if (historicoFiltrado.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" style="text-align: center;">Nenhum registro encontrado</td></tr>`;
        document.getElementById('resumo').style.display = 'none';
        return;
      }

      historicoFiltrado.forEach(item => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td>${item.id}</td>
          <td>${item.operador}</td>
          <td>${item.tipo_veiculo === "moto" ? "Moto" : "Carro"}</td>
          <td>${item.dias_previstos}</td>
          <td>${item.dias_trabalhados}</td>
          <td>${item.faltas_extras}</td>
          <td>R$ ${parseFloat(item.valor_final).toFixed(2)}</td>
          <td>${item.data}</td>
          <td class="no-print">
            <button class="btn-excluir" onclick="excluirItemHistorico(${item.id})">Excluir</button>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
      
      // Atualiza o resumo
      atualizarResumoHistorico(historicoFiltrado);
      document.getElementById('resumo').style.display = 'block';
      
      document.getElementById('btnExportarCompleto').style.display = historicoFiltrado.length > 0 ? 'block' : 'none';
    }
    
    // Função para atualizar o resumo do histórico
    function atualizarResumoHistorico(dados) {
      const resumoDiv = document.getElementById('resumoConteudo');
      
      // Agrupa por operador
      const porOperador = {};
      dados.forEach(item => {
        if (!porOperador[item.operador]) {
          porOperador[item.operador] = {
            totalCalculos: 0,
            totalDias: 0,
            totalValor: 0,
            ids: []
          };
        }
        
        porOperador[item.operador].totalCalculos++;
        porOperador[item.operador].totalDias += item.dias_trabalhados;
        porOperador[item.operador].totalValor += parseFloat(item.valor_final);
        porOperador[item.operador].ids.push(item.id);
      });
      
      // Cria a tabela de resumo
      let html = '<div style="overflow-x: auto;"><table>';
      html += '<thead><tr><th>Operador</th><th>Total de Cálculos</th><th>Total de Dias</th><th>Total Pago (R$)</th><th>IDs</th></tr></thead>';
      html += '<tbody>';
      
      for (const [operador, dados] of Object.entries(porOperador)) {
        html += `<tr>
          <td>${operador}</td>
          <td>${dados.totalCalculos}</td>
          <td>${dados.totalDias}</td>
          <td>R$ ${dados.totalValor.toFixed(2)}</td>
          <td>${dados.ids.join(', ')}</td>
        </tr>`;
      }
      
      html += '</tbody></table></div>';
      resumoDiv.innerHTML = html;
    }
    
    // Função para atualizar o filtro de operadores
    function atualizarFiltroOperadores() {
      const selectFiltro = document.getElementById('filtroOperador');
      const operadoresUnicos = [...new Set(historicoAluguel.map(item => item.operador))].sort();
      
      // Mantém a seleção atual
      const valorAtual = selectFiltro.value;
      selectFiltro.innerHTML = '<option value="Todos">TODOS os operadores</option>';
      
      operadoresUnicos.forEach(op => {
        const option = document.createElement('option');
        option.value = op;
        option.textContent = op;
        selectFiltro.appendChild(option);
      });
      
      // Restaura a seleção se ainda existir
      if (operadoresUnicos.includes(valorAtual)) {
        selectFiltro.value = valorAtual;
      }
    }

    // Função para filtrar o histórico - ATUALIZADA
    function filtrarListaHistorico() {
        const filtroOperador = document.getElementById('filtroOperador').value;
        const filtroData = document.getElementById('filtroData').value;
        
        return historicoAluguel.filter(item => {
            // Filtro por operador
            const operadorMatch = filtroOperador === "Todos" || item.operador === filtroOperador;
            
            // Filtro por mês/ano
            let dataMatch = true;
            if (filtroData) {
                const dataItem = new Date(item.timestamp);
                const mesItem = dataItem.getFullYear() + '-' + String(dataItem.getMonth() + 1).padStart(2, '0');
                dataMatch = mesItem === filtroData;
            }

            return operadorMatch && dataMatch;
        });
    }

    // Função para aplicar filtros
    function filtrarHistorico() {
        atualizarHistorico();
    }
    
    // Função para limpar filtros
    function limparFiltros() {
      document.getElementById('filtroOperador').value = 'Todos';
      document.getElementById('filtroData').value = '';
      filtrarHistorico();
    }

    // Função para limpar campos do formulário
    function limparCampos() {
      document.getElementById('operador').value = '';
      document.getElementById('tipo').value = '';
      document.getElementById('faltas').value = '';
      document.getElementById('diasReais').value = '';
      document.getElementById('faltasDesconto').value = '';
      document.getElementById('descontoCaju').value = '';
      document.getElementById('outrosDescontos').value = '';
      document.getElementById('justificativa').value = '';
      diasSelecionados = [];

      document.getElementById('resultado').style.display = 'none';
      document.getElementById('resultado').innerHTML = '';

      document.getElementById('btnExportar').style.display = 'none';
      document.getElementById('exportarPDFContainer').style.display = 'none';
    }

    // Função para exportar PDF do cálculo atual
    function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      
      // Obtém os dados do resultado
      const resultadoDiv = document.getElementById('resultado');
      const titulo = resultadoDiv.querySelector('h4').textContent;
      const nomeOperador = document.getElementById('operador').value || 'Operador';
      const dataAtual = new Date().toLocaleDateString('pt-BR');
      
      // Configurações do documento
      pdf.setProperties({
          title: `Aluguel de Veículo - ${nomeOperador}`,
          subject: 'Cálculo de Aluguel de Veículo',
          author: 'Sistema de Cálculos',
          keywords: 'aluguel, veículo, cálculo',
          creator: 'Sistema de Cálculos'
      });
      
      // Cabeçalho
      pdf.setFontSize(16);
      pdf.setTextColor(46, 134, 193);
      pdf.setFont("helvetica", "bold");
      pdf.text(`Aluguel de Veículo - ${nomeOperador}`, 105, 15, { align: 'center' });
      
      pdf.setFontSize(12);
      pdf.setTextColor(100, 100, 100);
      pdf.setFont("helvetica", "normal");
      pdf.text(`Gerado em: ${dataAtual}`, 105, 22, { align: 'center' });
      pdf.text(titulo, 105, 29, { align: 'center' });
      
      // Conteúdo
      pdf.setFontSize(11);
      pdf.setTextColor(0, 0, 0);
      
      let yPos = 40;
      const lineHeight = 7;
      const marginLeft = 15;
      
      // Extrai todos os parágrafos do resultado
      const paragrafos = resultadoDiv.querySelectorAll('p, h5');
      
      paragrafos.forEach(p => {
          // Divide o texto em linhas que cabem no PDF
          const lines = pdf.splitTextToSize(p.textContent, 180);
          
          lines.forEach(line => {
              pdf.text(line, marginLeft, yPos);
              yPos += lineHeight;
          });
          
          // Espaço extra após cada parágrafo
          yPos += 2;
      });
      
      // Adiciona linha horizontal
      pdf.setDrawColor(200, 200, 200);
      pdf.line(marginLeft, yPos + 5, 195, yPos + 5);
      yPos += 10;
      
      // Adiciona rodapé
      pdf.setFontSize(10);
      pdf.setTextColor(150, 150, 150);
      pdf.text('Documento gerado automaticamente pelo sistema de cálculos', 105, yPos, { align: 'center' });
      
      // Salva o PDF
      pdf.save(`aluguel_veiculo_${nomeOperador.replace(' ', '_')}_${new Date().toISOString().slice(0, 10)}.pdf`);
    }

    // Função para exportar PDF do histórico completo
    function exportarPDFCompleto() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm'
      });
      
      // Usa todo o histórico, não apenas o filtrado
      const historicoCompleto = [...historicoAluguel];

      doc.setFontSize(16);
      doc.text("Histórico Completo de Cálculos - Aluguel de Veículos", 105, 15, null, null, 'center');

      doc.setFontSize(10);
      
      // Tabela de registros
      const headers = [["ID", "Operador", "Tipo", "Dias Prev.", "Dias Trab.", "Faltas", "Total (R$)", "Data/Hora"]];
      
      const dataTabela = historicoCompleto.map(item => {
        return [
          item.id,
          item.operador,
          item.tipo_veiculo === "moto" ? "Moto" : "Carro",
          item.dias_previstos,
          item.dias_trabalhados,
          item.faltas_extras,
          parseFloat(item.valor_final).toFixed(2),
          item.data
        ];
      });
      
      doc.autoTable({
        head: headers,
        body: dataTabela,
        startY: 25,
        theme: "grid",
        headStyles: { 
          fillColor: [46, 134, 193],
          textColor: 255,
          fontStyle: 'bold'
        },
        alternateRowStyles: {
          fillColor: [240, 240, 240]
        },
        margin: { top: 25 },
        styles: {
          fontSize: 10,
          cellPadding: 3,
          overflow: 'linebreak'
        },
        columnStyles: {
          6: { halign: 'right' }
        }
      });

      doc.save(`historico_completo_aluguel_veiculos_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.pdf`);
    }

    // Função para editar item
    function editarItem(id) {
      const item = historicoAluguel.find(item => item.id === id);
      if (!item) return;
      
      // Preenche o formulário com os dados do item
      document.getElementById('operador').value = item.operador;
      document.getElementById('tipo').value = item.tipo_veiculo;
      
      // Configura os dias selecionados
      diasSelecionados = item.dias_selecionados.split(', ');
      document.getElementById('faltas')._flatpickr.setDate(diasSelecionados);
      
      document.getElementById('diasReais').value = item.dias_trabalhados;
      document.getElementById('faltasDesconto').value = item.faltas_extras;
      document.getElementById('descontoCaju').value = item.desconto_caju;
      document.getElementById('outrosDescontos').value = item.outros_descontos;
      document.getElementById('justificativa').value = item.justificativa;
      
      // Define que estamos editando
      editandoId = id;
      
      // Rola para o topo do formulário
      window.scrollTo(0, 0);
      
      // Altera o botão calcular para indicar edição
      document.querySelector('.btn-success').textContent = 'ATUALIZAR CÁLCULO';
    }

    // Função para excluir item do histórico
    async function excluirItemHistorico(id) {
      const confirmar = await mostrarPopupConfirmacao(
        "Confirmar exclusão",
        "Tem certeza que deseja excluir este registro permanentemente?",
        { "ID": id, "Operador": historicoAluguel.find(item => item.id === id)?.operador }
      );
      
      if (!confirmar) {
        return;
      }
      
      try {
        // Remove do Supabase
        const response = await fetch(`${SUPABASE_URL}/rest/v1/aluguel_veiculos?id=eq.${id}`, {
          method: "DELETE",
          headers: {
            "apikey": SUPABASE_KEY,
            "Authorization": `Bearer ${SUPABASE_KEY}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        // Remove do array local
        historicoAluguel = historicoAluguel.filter(item => item.id !== id);
        
        // Salva no localStorage
        localStorage.setItem('historicoAluguel', JSON.stringify(historicoAluguel));
        
        // Atualiza a interface
        atualizarHistorico();
        atualizarFiltroOperadores();
        
        mostrarPopupAutomatico('Excluído!', 'O registro foi removido com sucesso.', 'success');
      } catch (error) {
        console.error("Erro ao excluir:", error);
        mostrarPopupAutomatico('Erro', 'Não foi possível excluir o registro.', 'error');
      }
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
      // Configura eventos de filtro
      document.getElementById('filtroOperador').addEventListener('change', filtrarHistorico);
      document.getElementById('filtroData').addEventListener('change', filtrarHistorico);
      
      // Carrega dados do Supabase (com fallback para localStorage)
      carregarDados();
    });
  </script>
</body>
</html>
