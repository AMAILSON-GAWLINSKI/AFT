<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Vale Alimenta√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary: #2E86C1;
      --danger: #E74C3C;
      --success: #28B463;
      --warning: #F39C12;
      --gray: #F2F2F2;
    }
    
    /* Reset e estilos base */
    * {
      box-sizing: border-box;
      transition: all 0.2s ease;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      color: #333;
      min-height: 100vh;
      padding: 15px;
      margin: 0;
    }

    .container {
      max-width: 1100px;
      width: 100%;
      margin: 0 auto;
      background: #ffffff;
      min-height: 100vh;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    h1, h2, h3 {
      text-align: center;
      color: #38a738c9;
      margin-top: 0;
    }
    
    h1 {
      font-size: 1.8rem;
      margin-bottom: 20px;
    }
    
    h2 {
      font-size: 1.5rem;
    }
    
    h3 {
      font-size: 1.3rem;
    }

    /* Estilos do formul√°rio */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-col {
      flex: 1;
      min-width: 200px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }

    /* Container para sele√ß√£o de operador com bot√µes */
    .operador-container {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .operador-container select {
      flex: 1;
    }
    
    .btn-operador {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 5px 10px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-add-operador {
      color: var(--success);
    }
    
    .btn-remove-operador {
      color: var(--danger);
    }
    
    .btn-edit-operador {
      color: var(--primary);
    }
    
    .btn-operador:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    /* Estilos do calend√°rio melhorados */
    #calendario {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 10px;
      background-color: #ffffff;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #eee;
    }

    #calendario div,
    #calendario button {
      text-align: center;
      padding: 8px;
      border-radius: 6px;
      font-size: 13px;
    }

    #calendario div {
      font-weight: bold;
      background-color: #6c757d;
      color: #ffffff;
    }

    #calendario button {
      border: 1px solid #ccc;
      background-color: #f8f9fa;
      color: #333;
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    
    #calendario button:hover {
      background-color: #e2e6ea;
    }

    #calendario button.ativo {
      background-color: #28a745;
      color: #ffffff;
      font-weight: bold;
      border-color: #1c7430;
    }

    /* Feriados - apenas estilo visual, n√£o bloqueado */
    #calendario button.feriado {
      background-color: #f5c6cb;
      color: #721c24;
      font-weight: bold;
      border: 1px dashed #f194a1;
    }
    
    #calendario button.feriado.ativo {
      background-color: #28a745;
      color: #ffffff;
      border: 2px solid #721c24;
    }
    
    #calendario button.feriado-movel {
      background-color: #f5c6cb;
      color: #721c24;
      font-weight: bold;
      border: 1px dashed #f194a1;
    }
    
    #calendario button.feriado-movel.ativo {
      background-color: #28a745;
      color: #ffffff;
      border: 2px solid #721c24;
    }

    /* Estilos de cards e tabelas */
    .card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      font-size: 0.85rem;
    }

    th {
      background-color: var(--primary);
      color: white;
      padding: 10px;
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: 0.9rem;
    }

    td { 
      padding: 8px; 
      border-bottom: 1px solid #ddd; 
      text-align: center;
    }

    /* Bot√µes */
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.9rem;
      white-space: nowrap;
      min-width: 120px;
      text-align: center;
    }

    .btn-primary { background-color: var(--primary); }
    .btn-secondary { background-color: #5A5A5A; }
    .btn-success { background-color: var(--success); }
    .btn-danger { background-color: var(--danger); }
    .btn-warning { background-color: var(--warning); color: #212529; }
    .btn-info { background-color: #17a2b8; }
    .btn-gray { background-color: #888; }
    
    .btn:hover {
      opacity: 0.9;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      width: 100%;
    }

    /* Resultado e resumo */
    #resultado {
      margin-top: 15px;
      padding: 15px;
      background: #e9f7ef;
      border-left: 5px solid #2e7d32;
      border-radius: 8px;
      display: none;
      line-height: 1.6;
    }

    #resumo {
      margin-top: 15px;
      padding: 15px;
      background: #eef;
      border-radius: 8px;
      overflow-x: auto;
    }
    
    /* Estilo para os bot√µes de a√ß√£o */
    .btn-excluir {
      background-color: #E74C3C;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 8px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    
    .btn-editar {
      background-color: #2E86C1;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 8px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-right: 5px;
    }
    
    .btn-excluir:hover, .btn-editar:hover {
      opacity: 0.8;
    }
    
    /* Estilo para o popup */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .popup-container {
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      max-width: 90%;
      width: 400px;
      text-align: center;
      animation: fadeIn 0.3s;
    }
    
    .popup-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 15px;
    }
    
    .popup-message {
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .popup-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }
    
    .popup-button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      min-width: 80px;
      transition: all 0.2s;
    }
    
    .popup-button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    .popup-confirm {
      background-color: var(--success);
      color: white;
    }
    
    .popup-cancel {
      background-color: var(--danger);
      color: white;
    }
    
    .popup-ok {
      background-color: var(--primary);
      color: white;
      width: 100%;
    }
    
    .popup-highlight {
      font-weight: bold;
      color: var(--danger);
    }
    
    .popup-details {
      background-color: #F8F9F9;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: left;
      font-size: 0.9rem;
    }
    
    .popup-details-item {
      margin-bottom: 5px;
    }
    
    .popup-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    .popup-success .popup-title {
      color: var(--success);
    }
    
    .popup-warning .popup-title {
      color: var(--warning);
    }
    
    .popup-error .popup-title {
      color: var(--danger);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Modal para gerenciar operadores */
    .operador-modal {
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      max-width: 90%;
      width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .operador-list {
      margin: 20px 0;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 5px;
    }
    
    .operador-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
    }
    
    .operador-item:last-child {
      border-bottom: none;
    }
    
    .operador-item span {
      flex: 1;
    }
    
    .operador-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn-remove-small {
      background-color: #E74C3C;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 3px 8px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    
    .btn-remove-small:hover {
      opacity: 0.8;
    }
    
    .operador-input-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .operador-input-group input {
      flex: 1;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .form-col {
        min-width: 100%;
      }
      
      .btn {
        padding: 10px 8px;
        font-size: 0.8rem;
        min-width: 100px;
      }
      
      #calendario button {
        padding: 8px;
        font-size: 12px;
      }
      
      .btn-editar, .btn-excluir {
        padding: 4px 6px;
        font-size: 0.7rem;
      }
      
      .popup-container, .operador-modal {
        width: 90%;
        padding: 15px;
      }
      
      .popup-title {
        font-size: 1.1rem;
      }
      
      .operador-container {
        flex-wrap: wrap;
      }
      
      .operador-actions {
        flex-direction: column;
        gap: 5px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      .card {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      #calendario button {
        padding: 6px;
        font-size: 11px;
      }
      
      .popup-buttons {
        flex-direction: column;
        gap: 10px;
      }
      
      .popup-button {
        width: 100%;
      }
      
      .btn-row {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
      
      .operador-input-group {
        flex-direction: column;
      }
    }
    
    /* Estilo para operador com benef√≠cio */
    .operador-com-beneficio {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .operador-com-beneficio select {
      flex: 2;
    }
    
    .operador-com-beneficio input {
      flex: 1;
    }
    
    /* Ajuste para os bot√µes principais */
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .btn-principal {
      flex: 1;
      min-width: 150px;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>VALE ALIMENTA√á√ÉO</h1>
    
    <!-- Formul√°rio principal -->
    <div class="card">
      <div class="form-row">
        <div class="form-col">
          <label>üë∑ Operador:</label>
          <div class="operador-container">
            <select id="beneficiario">
              <option value="">Selecione um operador</option>
              <!-- Op√ß√µes ser√£o carregadas dinamicamente -->
            </select>
            <button class="btn-operador btn-add-operador" onclick="abrirModalOperadores()" title="Gerenciar operadores">‚ûï</button>
            <button class="btn-operador btn-remove-operador" onclick="removerOperadorSelecionado()" title="Remover operador selecionado">üóëÔ∏è</button>
          </div>
        </div>
        <div class="form-col">
          <label>Valor do Benef√≠cio:</label>
          <input type="number" id="valorDiario" value="28.00" step="0.01" placeholder="Valor di√°rio">
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <label>üí≤ Tipo de Desconto:</label>
          <select id="tipoDesconto">
            <option value="percentual">Percentual (%)</option>
            <option value="fixo">Valor Fixo (R$)</option>
          </select>
        </div>
        <div class="form-col">
          <label>üîñ Valor do Desconto:</label>
          <input type="number" id="valorDesconto" step="0.01" placeholder="Ex: 5 (para %) ou 150 (para R$)">
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <label>‚è±Ô∏è Dias com -4h trabalhadas:</label>
          <input type="number" id="qtdDescontos4h" min="0" step="1" placeholder="N¬∫ de dias">
        </div>
        <div class="form-col">
          <label>üìÖ Selecione o M√™s:</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <button onclick="mudarMes(-1)" class="btn btn-secondary">‚üµ</button>
            <input type="month" id="mesSelecionado" onchange="gerarCalendario()" style="flex: 1;">
            <button onclick="mudarMes(1)" class="btn btn-secondary">‚ü∂</button>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <label>üìÖ Selecione os Dias Trabalhados:</label>
          <div id="calendario"></div>
          
          <!-- √Årea para mostrar os meses selecionados -->
          <div id="mesesSelecionadosContainer" style="display: none; margin-top: 10px;">
            <label>Meses Selecionados:</label>
            <div id="mesesSelecionadosList" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;"></div>
          </div>
        </div>
      </div>

      <div class="btn-container">
        <button onclick="adicionarMes()" class="btn btn-primary btn-principal">ADICIONAR M√äS</button>
        <button onclick="calcularVA()" class="btn btn-success btn-principal">CALCULAR</button>
        <button onclick="exportarPDFCalculoAtual()" class="btn btn-info btn-principal">üìÑ EXPORTAR PDF</button>
        <button id="btnExportarCompleto" onclick="exportarPDFCompleto()" class="btn btn-secondary btn-principal" style="display: none;">üì§ SALVAR HIST√ìRICO</button>
        <button id="btnAtualizarDados" class="btn btn-warning btn-principal" onclick="carregarDados()">üîÑ ATUALIZAR</button>
      </div>
    </div>

    <div id="resultado" class="card"></div>
    
    <!-- Filtros -->
    <div class="card">
      <h3>üîç Filtros</h3>
      <div class="form-row">
        <div class="form-col">
          <label>Operador:</label>
          <select id="filtroOperador">
            <option value="Todos">TODOS os operadores</option>
          </select>
        </div>
        <div class="form-col">
          <label>Data:</label>
          <input type="month" id="filtroData">
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="filtrarHistorico()">Aplicar Filtros</button>
        <button class="btn btn-gray" onclick="limparFiltros()">Limpar Filtros</button>
      </div>
    </div>
    
    <!-- Tabela de hist√≥rico -->
    <div class="card">
      <div style="overflow-x: auto;">
        <table id="tabelaHistorico">
          <thead>
            <tr>
              <th>ID</th>
              <th>Operador</th>
              <th>Per√≠odo</th>
              <th>Dias</th>
              <th>-4h</th>
              <th>Total (R$)</th>
              <th>Data/Hora</th>
              <th class="no-print">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <!-- Resumo -->
    <div id="resumo" class="card">
      <h3>üìà Resumo dos Valores</h3>
      <div id="resumoConteudo"></div>
    </div>
  </div>

  <script>
    // Configura√ß√µes do Supabase
    const SUPABASE_URL = "https://nsfliimhsokyzhacnfdg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zZmxpaW1oc29reXpoYWNuZmRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczNDg3MzQsImV4cCI6MjA2MjkyNDczNH0.QqosDhPG2xK16rAfitDiW837GMIL_dh5lmDwg8cOn_8";
    const { jsPDF } = window.jspdf;
    
    // Vari√°veis globais
    let historicoVA = [];
    let diasMarcados = {};
    let mesesSelecionados = [];
    let editandoId = null;
    let ultimoCalculo = null;
    let operadores = []; // Array para armazenar operadores

    // Inicializar lista de operadores (pode ser carregada do localStorage)
    function inicializarOperadores() {
      // Tenta carregar do localStorage
      const operadoresSalvos = localStorage.getItem('operadoresVA');
      
      if (operadoresSalvos) {
        operadores = JSON.parse(operadoresSalvos);
      } else {
        // Lista inicial padr√£o
        operadores = [
          "Higor Sarmento",
          "Rafael Machado",
          "Lidurino junior",
          "Joelson Carlos",
          "Ricardo Alves",
          "Igor Nascimento",
          "Keniel vasque",
          "Luana Parcianello"
        ];
        salvarOperadores();
      }
      
      atualizarSelectOperadores();
    }

    function salvarOperadores() {
      localStorage.setItem('operadoresVA', JSON.stringify(operadores));
    }

    function atualizarSelectOperadores() {
      const select = document.getElementById('beneficiario');
      const filtroSelect = document.getElementById('filtroOperador');
      const valorAtual = select.value;
      const filtroValorAtual = filtroSelect.value;
      
      // Limpa e recria as op√ß√µes do select principal
      select.innerHTML = '<option value="">Selecione um operador</option>';
      
      operadores.forEach(operador => {
        const option = document.createElement('option');
        option.value = operador;
        option.textContent = operador;
        select.appendChild(option);
      });
      
      // Restaura a sele√ß√£o se ainda existir
      if (operadores.includes(valorAtual)) {
        select.value = valorAtual;
      }
      
      // Atualiza o filtro de operadores
      atualizarFiltroOperadores();
    }

    // Fun√ß√£o para formatar data no formato "1 de outubro de 2025"
    function formatarDataExtenso(dataString) {
      const [ano, mes, dia] = dataString.split('-').map(Number);
      const data = new Date(ano, mes - 1, dia);
      
      const diaNum = data.getDate();
      const mesNome = data.toLocaleString('pt-BR', { month: 'long' });
      const anoNum = data.getFullYear();
      
      return `${diaNum} de ${mesNome} de ${anoNum}`;
    }

    // Fun√ß√£o para gerar ID √∫nico
    function gerarID() {
      const min = 10000;
      const max = 99999;
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    // Fun√ß√£o para editar um registro no Supabase
    async function editarRegistroSupabase(id, dadosAtualizados) {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/vale_alimentacao?id=eq.${id}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_KEY,
            "Authorization": `Bearer ${SUPABASE_KEY}`
          },
          body: JSON.stringify(dadosAtualizados)
        });

        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.error("Erro ao editar registro:", error);
        throw error;
      }
    }
    
    function adicionarMes() {
      const mesSelecionadoInput = document.getElementById('mesSelecionado');
      if (!mesSelecionadoInput.value) return;
      
      const mesSelecionado = mesSelecionadoInput.value;
      
      if (mesesSelecionados.includes(mesSelecionado)) {
        mostrarPopup('Aten√ß√£o', 'Este m√™s j√° foi adicionado!', 'warning');
        return;
      }
      
      mesesSelecionados.push(mesSelecionado);
      mesesSelecionados.sort();
      
      atualizarMesesSelecionadosUI();
      
      document.getElementById('mesesSelecionadosContainer').style.display = 'block';
      gerarCalendario();
    }
    
    function removerMes(mes) {
      mesesSelecionados = mesesSelecionados.filter(m => m !== mes);
      atualizarMesesSelecionadosUI();
      
      if (mesesSelecionados.length === 0) {
        document.getElementById('mesesSelecionadosContainer').style.display = 'none';
      }
      
      // Remove os dias marcados para o m√™s removido
      delete diasMarcados[mes];
      gerarCalendario();
    }
    
    function atualizarMesesSelecionadosUI() {
      const container = document.getElementById('mesesSelecionadosList');
      container.innerHTML = '';
      
      mesesSelecionados.forEach(mes => {
        const [ano, mesNum] = mes.split('-');
        const data = new Date(ano, mesNum - 1, 1);
        const nomeMes = data.toLocaleString('pt-BR', { month: 'long' });
        
        const tag = document.createElement('div');
        tag.style.display = 'flex';
        tag.style.alignItems = 'center';
        tag.style.gap = '5px';
        tag.style.background = '#e2e6ea';
        tag.style.padding = '5px 10px';
        tag.style.borderRadius = '16px';
        
        tag.innerHTML = `
          ${nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1)}/${ano}
          <button onclick="removerMes('${mes}')" style="background: none; border: none; cursor: pointer; color: #6c757d;">‚úï</button>
        `;
        
        container.appendChild(tag);
      });
    }

    function gerarCalendario() {
      const mesSelecionadoInput = document.getElementById('mesSelecionado');
      if (!mesSelecionadoInput.value) return;

      const mesSelecionado = mesSelecionadoInput.value;
      const [ano, mes] = mesSelecionado.split('-').map(Number);
      const calendario = document.getElementById('calendario');
      calendario.innerHTML = '';

      const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
      diasSemana.forEach(dia => {
        const diaSemanaDiv = document.createElement('div');
        diaSemanaDiv.textContent = dia;
        calendario.appendChild(diaSemanaDiv);
      });

      const primeiroDiaSemana = new Date(ano, mes - 1, 1).getDay();
      const diasNoMes = new Date(ano, mes, 0).getDate();
      const diasTrabalhadosMesAtual = diasMarcados[mesSelecionado] || [];

      const feriadosFixos = [
          { dia: 1, mes: 1 }, { dia: 21, mes: 4 }, { dia: 1, mes: 5 },
          { dia: 7, mes: 9 }, { dia: 12, mes: 10 }, { dia: 2, mes: 11 },
          { dia: 15, mes: 11 }, { dia: 25, mes: 12 }
      ];
      
      const feriadosMoveis = {
        "2025-03-04": "Carnaval",
        "2025-04-18": "Sexta-feira Santa",
        "2025-06-19": "Corpus Christi",
        "2025-03-04": "Carnaval",
        "2025-04-18": "Sexta-feira Santa",
        "2025-06-19": "Corpus Christi",

    "2026-02-13": "Sexta-feira de Carnaval",
    "2026-02-16": "Segunda-feira de Carnaval",
    "2026-02-17": "Ter√ßa-feira de Carnaval",
    "2026-02-18": "Quarta-feira de Cinzas",
    "2026-04-03": "Sexta-feira Santa",
    "2026-06-04": "Corpus Christi",

    "2027-02-05": "Sexta-feira de Carnaval",
    "2027-02-08": "Segunda-feira de Carnaval",
    "2027-02-09": "Ter√ßa-feira de Carnaval",
    "2027-02-10": "Quarta-feira de Cinzas",
    "2027-03-26": "Sexta-feira Santa",
    "2027-05-27": "Corpus Christi",

    "2028-02-25": "Sexta-feira de Carnaval",
    "2028-02-28": "Segunda-feira de Carnaval",
    "2028-02-29": "Ter√ßa-feira de Carnaval",
    "2028-03-01": "Quarta-feira de Cinzas",
    "2028-04-14": "Sexta-feira Santa",
    "2028-06-15": "Corpus Christi",

    "2029-02-09": "Sexta-feira de Carnaval",
    "2029-02-12": "Segunda-feira de Carnaval",
    "2029-02-13": "Ter√ßa-feira de Carnaval",
    "2029-02-14": "Quarta-feira de Cinzas",
    "2029-03-30": "Sexta-feira Santa",
    "2029-05-31": "Corpus Christi",

    "2030-03-01": "Sexta-feira de Carnaval",
    "2030-03-04": "Segunda-feira de Carnaval",
    "2030-03-05": "Ter√ßa-feira de Carnaval",
    "2030-03-06": "Quarta-feira de Cinzas",
    "2030-04-19": "Sexta-feira Santa",
    "2030-06-20": "Corpus Christi",

    "2031-02-21": "Sexta-feira de Carnaval",
    "2031-02-24": "Segunda-feira de Carnaval",
    "2031-02-25": "Ter√ßa-feira de Carnaval",
    "2031-02-26": "Quarta-feira de Cinzas",
    "2031-04-11": "Sexta-feira Santa",
    "2031-06-12": "Corpus Christi",

    "2032-02-06": "Sexta-feira de Carnaval",
    "2032-02-09": "Segunda-feira de Carnaval",
    "2032-02-10": "Ter√ßa-feira de Carnaval",
    "2032-02-11": "Quarta-feira de Cinzas",
    "2032-03-26": "Sexta-feira Santa",
    "2032-05-27": "Corpus Christi",

    "2033-02-25": "Sexta-feira de Carnaval",
    "2033-02-28": "Segunda-feira de Carnaval",
    "2033-03-01": "Ter√ßa-feira de Carnaval",
    "2033-03-02": "Quarta-feira de Cinzas",
    "2033-04-15": "Sexta-feira Santa",
    "2033-06-16": "Corpus Christi",

    "2034-02-10": "Sexta-feira de Carnaval",
    "2034-02-13": "Segunda-feira de Carnaval",
    "2034-02-14": "Ter√ßa-feira de Carnaval",
    "2034-02-15": "Quarta-feira de Cinzas",
    "2034-03-31": "Sexta-feira Santa",
    "2034-06-01": "Corpus Christi",

    "2035-03-02": "Sexta-feira de Carnaval",
    "2035-03-05": "Segunda-feira de Carnaval",
    "2035-03-06": "Ter√ßa-feira de Carnaval",
    "2035-03-07": "Quarta-feira de Cinzas",
    "2035-04-20": "Sexta-feira Santa",
    "2035-06-21": "Corpus Christi",

    "2036-02-22": "Sexta-feira de Carnaval",
    "2036-02-25": "Segunda-feira de Carnaval",
    "2036-02-26": "Ter√ßa-feira de Carnaval",
    "2036-02-27": "Quarta-feira de Cinzas",
    "2036-04-11": "Sexta-feira Santa",
    "2036-06-12": "Corpus Christi",

    "2037-02-06": "Sexta-feira de Carnaval",
    "2037-02-09": "Segunda-feira de Carnaval",
    "2037-02-10": "Ter√ßa-feira de Carnaval",
    "2037-02-11": "Quarta-feira de Cinzas",
    "2037-03-27": "Sexta-feira Santa",
    "2037-05-28": "Corpus Christi",

    "2038-02-26": "Sexta-feira de Carnaval",
    "2038-03-01": "Segunda-feira de Carnaval",
    "2038-03-02": "Ter√ßa-feira de Carnaval",
    "2038-03-03": "Quarta-feira de Cinzas",
    "2038-04-16": "Sexta-feira Santa",
    "2038-06-17": "Corpus Christi",

    "2039-02-11": "Sexta-feira de Carnaval",
    "2039-02-14": "Segunda-feira de Carnaval",
    "2039-02-15": "Ter√ßa-feira de Carnaval",
    "2039-02-16": "Quarta-feira de Cinzas",
    "2039-04-01": "Sexta-feira Santa",
    "2039-06-02": "Corpus Christi",

    "2040-03-02": "Sexta-feira de Carnaval",
    "2040-03-05": "Segunda-feira de Carnaval",
    "2040-03-06": "Ter√ßa-feira de Carnaval",
    "2040-03-07": "Quarta-feira de Cinzas",
    "2040-04-20": "Sexta-feira Santa",
    "2040-06-21": "Corpus Christi",

    "2041-02-15": "Sexta-feira de Carnaval",
    "2041-02-18": "Segunda-feira de Carnaval",
    "2041-02-19": "Ter√ßa-feira de Carnaval",
    "2041-02-20": "Quarta-feira de Cinzas",
    "2041-04-05": "Sexta-feira Santa",
    "2041-06-06": "Corpus Christi",

    "2042-02-07": "Sexta-feira de Carnaval",
    "2042-02-10": "Segunda-feira de Carnaval",
    "2042-02-11": "Ter√ßa-feira de Carnaval",
    "2042-02-12": "Quarta-feira de Cinzas",
    "2042-03-28": "Sexta-feira Santa",
    "2042-05-29": "Corpus Christi",

    "2043-02-27": "Sexta-feira de Carnaval",
    "2043-03-02": "Segunda-feira de Carnaval",
    "2043-03-03": "Ter√ßa-feira de Carnaval",
    "2043-03-04": "Quarta-feira de Cinzas",
    "2043-04-17": "Sexta-feira Santa",
    "2043-06-18": "Corpus Christi",

    "2044-02-12": "Sexta-feira de Carnaval",
    "2044-02-15": "Segunda-feira de Carnaval",
    "2044-02-16": "Ter√ßa-feira de Carnaval",
    "2044-02-17": "Quarta-feira de Cinzas",
    "2044-04-01": "Sexta-feira Santa",
    "2044-06-02": "Corpus Christi",

    "2045-03-03": "Sexta-feira de Carnaval",
    "2045-03-06": "Segunda-feira de Carnaval",
    "2045-03-07": "Ter√ßa-feira de Carnaval",
    "2045-03-08": "Quarta-feira de Cinzas",
    "2045-04-21": "Sexta-feira Santa",
    "2045-06-22": "Corpus Christi",

    "2046-02-16": "Sexta-feira de Carnaval",
    "2046-02-19": "Segunda-feira de Carnaval",
    "2046-02-20": "Ter√ßa-feira de Carnaval",
    "2046-02-21": "Quarta-feira de Cinzas",
    "2046-04-06": "Sexta-feira Santa",
    "2046-06-07": "Corpus Christi",

    "2047-02-08": "Sexta-feira de Carnaval",
    "2047-02-11": "Segunda-feira de Carnaval",
    "2047-02-12": "Ter√ßa-feira de Carnaval",
    "2047-02-13": "Quarta-feira de Cinzas",
    "2047-03-29": "Sexta-feira Santa",
    "2047-05-30": "Corpus Christi",

    "2048-02-28": "Sexta-feira de Carnaval",
    "2048-03-02": "Segunda-feira de Carnaval",
    "2048-03-03": "Ter√ßa-feira de Carnaval",
    "2048-03-04": "Quarta-feira de Cinzas",
    "2048-04-17": "Sexta-feira Santa",
    "2048-06-18": "Corpus Christi",

    "2049-02-13": "Sexta-feira de Carnaval",
    "2049-02-16": "Segunda-feira de Carnaval",
    "2049-02-17": "Ter√ßa-feira de Carnaval",
    "2049-02-18": "Quarta-feira de Cinzas",
    "2049-04-02": "Sexta-feira Santa",
    "2049-06-03": "Corpus Christi",

    "2050-03-04": "Sexta-feira de Carnaval",
    "2050-03-07": "Segunda-feira de Carnaval",
    "2050-03-08": "Ter√ßa-feira de Carnaval",
    "2050-03-09": "Quarta-feira de Cinzas",
    "2050-04-22": "Sexta-feira Santa",
    "2050-06-23": "Corpus Christi"
      };

      for (let i = 0; i < primeiroDiaSemana; i++) {
        const emptyDiv = document.createElement('div');
        emptyDiv.style.visibility = 'hidden';
        calendario.appendChild(emptyDiv);
      }

      for (let dia = 1; dia <= diasNoMes; dia++) {
        const botaoDia = document.createElement('button');
        botaoDia.textContent = dia;
        botaoDia.dataset.dia = dia;

        const dataAtual = new Date(ano, mes - 1, dia);
        const diaDaSemana = dataAtual.getDay();

        const isFeriadoFixo = feriadosFixos.some(f => f.dia === dia && f.mes === mes);
        const dataFormatada = `${ano}-${String(mes).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        const isFeriadoMovel = feriadosMoveis[dataFormatada];
        const isDomingo = diaDaSemana === 0;

        // Aplica estilos de feriado, mas permite sele√ß√£o
        if (isFeriadoFixo) {
          botaoDia.classList.add('feriado');
          botaoDia.title = "Feriado Nacional";
        } else if (isFeriadoMovel) {
          botaoDia.classList.add('feriado-movel');
          botaoDia.title = feriadosMoveis[dataFormatada];
        } else if (isDomingo) {
          botaoDia.classList.add('feriado');
          botaoDia.title = "Domingo";
        }
        
        // Verifica se o dia est√° marcado como trabalhado
        if (diasTrabalhadosMesAtual.includes(dia)) {
          botaoDia.classList.add('ativo');
        }
        
        // Adiciona evento de clique para todos os dias
        botaoDia.addEventListener('click', () => toggleDiaTrabalhado(mesSelecionado, dia, botaoDia));

        calendario.appendChild(botaoDia);
      }
    }

    function toggleDiaTrabalhado(mesRef, dia, botao) {
      if (!diasMarcados[mesRef]) {
        diasMarcados[mesRef] = [];
      }

      const index = diasMarcados[mesRef].indexOf(dia);
      if (index > -1) {
        diasMarcados[mesRef].splice(index, 1);
        botao.classList.remove('ativo');
      } else {
        diasMarcados[mesRef].push(dia);
        diasMarcados[mesRef].sort((a, b) => a - b);
        botao.classList.add('ativo');
      }
    }

    function mudarMes(direcao) {
      const mesInput = document.getElementById('mesSelecionado');
      const [anoAtual, mesAtual] = mesInput.value.split('-').map(Number);
      const novaData = new Date(anoAtual, mesAtual - 1 + direcao, 1);
      const novoAno = novaData.getFullYear();
      const novoMes = String(novaData.getMonth() + 1).padStart(2, '0');
      mesInput.value = `${novoAno}-${novoMes}`;
      gerarCalendario();
    }

    async function calcularVA() {
      const nome = document.getElementById('beneficiario').value;
      const valorDia = parseFloat(document.getElementById('valorDiario').value);
      const tipoDesconto = document.getElementById('tipoDesconto').value;
      const valorDescontoInput = document.getElementById('valorDesconto').value;
      const qtdDescontos4h = parseInt(document.getElementById('qtdDescontos4h').value || 0);
      
      if (!nome) { 
        mostrarPopup('Aten√ß√£o', 'Por favor, selecione um operador.', 'error');
        return; 
      }
      if (isNaN(valorDia) || valorDia <= 0) { 
        mostrarPopup('Aten√ß√£o', 'Por favor, insira um valor di√°rio v√°lido.', 'error');
        return; 
      }
      
      if (mesesSelecionados.length === 0) {
        mostrarPopup('Aten√ß√£o', 'Por favor, adicione pelo menos um m√™s usando o bot√£o "Adicionar M√™s".', 'error');
        return;
      }
      
      let totalDiasTrabalhados = 0;
      let mesesComDias = [];
      let todosDiasSelecionados = [];
      
      for (const mes of mesesSelecionados) {
        const diasDoMes = diasMarcados[mes] || [];
        if (diasDoMes.length > 0) {
          totalDiasTrabalhados += diasDoMes.length;
          mesesComDias.push(mes);
          todosDiasSelecionados = [...todosDiasSelecionados, ...diasDoMes.map(dia => `${mes}-${String(dia).padStart(2, '0')}`)];
        }
      }
      
      if (totalDiasTrabalhados === 0) {
        mostrarPopup('Aten√ß√£o', 'Por favor, selecione pelo menos um dia trabalhado nos meses adicionados.', 'error');
        return;
      }
      
      const valorDesconto = parseFloat(valorDescontoInput) || 0;

      let totalBruto = totalDiasTrabalhados * valorDia;
      let descontoAplicado = 0;
      if (tipoDesconto === 'percentual' && valorDesconto > 0) {
        descontoAplicado = totalBruto * (valorDesconto / 100);
      } else if (tipoDesconto === 'fixo' && valorDesconto > 0) {
        descontoAplicado = valorDesconto;
      }
      let totalLiquido = totalBruto - descontoAplicado;
      const descontoMenos4h = qtdDescontos4h * valorDia;
      totalLiquido -= descontoMenos4h;
      totalLiquido = Math.max(0, totalLiquido);

      // Determinar primeiro e √∫ltimo dia selecionado
      let primeiroDia = null;
      let ultimoDia = null;
      let periodoFormatado = '';
      
      if (todosDiasSelecionados.length > 0) {
        // Ordenar as datas
        const datasOrdenadas = todosDiasSelecionados.sort();
        
        primeiroDia = datasOrdenadas[0];
        ultimoDia = datasOrdenadas[datasOrdenadas.length - 1];
        
        // Formatar o per√≠odo
        const primeiroDiaFormatado = formatarDataExtenso(primeiroDia);
        const ultimoDiaFormatado = formatarDataExtenso(ultimoDia);
        
        periodoFormatado = `de ${primeiroDiaFormatado} at√© ${ultimoDiaFormatado}`;
      }

      const idCalculo = editandoId || gerarID();
      const timestamp = new Date().toISOString();

      const resultadoDiv = document.getElementById('resultado');
      resultadoDiv.style.display = 'block';
      resultadoDiv.innerHTML = `
        <h4>${editandoId ? 'C√°lculo Atualizado' : 'Resultado do C√°lculo'}</h4>
        <p><strong>ID do C√°lculo:</strong> ${idCalculo}</p>
        <p><strong>Operador:</strong> ${nome}</p>
        ${periodoFormatado ? `<p><strong>Per√≠odo:</strong> ${periodoFormatado}</p>` : ''}
        
        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
          <h5 style="margin-bottom: 10px; color: #2E86C1;">üìù Detalhes do C√°lculo</h5>
          <p><strong>Dias Trabalhados:</strong> ${totalDiasTrabalhados} dias √ó R$ ${valorDia.toFixed(2)} = <strong>R$ ${totalBruto.toFixed(2)}</strong></p>
          
          ${descontoAplicado > 0 ? `
            <p><strong>Desconto (${tipoDesconto === 'percentual' ? valorDesconto + '%' : 'Fixo'}):</strong> 
            ${tipoDesconto === 'percentual' ? `${totalBruto.toFixed(2)} √ó ${valorDesconto}% = ` : ''}
            R$ ${descontoAplicado.toFixed(2)}</p>
          ` : ''}
          
          ${qtdDescontos4h > 0 ? `
            <p><strong>Desconto por -4h (${qtdDescontos4h} dias):</strong> 
            ${qtdDescontos4h} √ó R$ ${valorDia.toFixed(2)} = R$ ${descontoMenos4h.toFixed(2)}</p>
          ` : ''}
          
          <p style="margin-top: 10px;">
            <strong>Total Bruto:</strong> R$ ${totalBruto.toFixed(2)}<br>
            <strong>Total Descontos:</strong> R$ ${(descontoAplicado + descontoMenos4h).toFixed(2)}<br>
            <strong style="color: #28a745; font-size: 1.1em;">TOTAL L√çQUIDO:</strong> R$ ${totalLiquido.toFixed(2)}
          </p>
        </div>
        
        <p style="font-size: 0.9em; color: #6c757d;">
        Valor do benef√≠cio di√°rio: R$ ${valorDia.toFixed(2)}
        </p>
      `;

      // Salva os dados do √∫ltimo c√°lculo para exporta√ß√£o
      ultimoCalculo = {
        id: idCalculo,
        nome: nome,
        valorDiario: valorDia,
        tipoDesconto: tipoDesconto,
        valorDesconto: valorDesconto,
        qtdDescontos4h: qtdDescontos4h,
        mesesComDias: mesesComDias,
        totalDiasTrabalhados: totalDiasTrabalhados,
        todosDiasSelecionados: todosDiasSelecionados,
        totalBruto: totalBruto,
        descontoAplicado: descontoAplicado,
        descontoMenos4h: descontoMenos4h,
        totalLiquido: totalLiquido,
        primeiroDia: primeiroDia,
        ultimoDia: ultimoDia,
        periodoFormatado: periodoFormatado,
        timestamp: timestamp
      };

      const dadosParaSalvar = {
          id: idCalculo,
          timestamp: timestamp,
          operador: nome,
          valor_diario: valorDia.toFixed(2),
          tipo_desconto: tipoDesconto,
          valor_desconto: valorDesconto.toFixed(2),
          qtd_descontos_4h: qtdDescontos4h,
          meses: mesesComDias.join(', '),
          dias_trabalhados: totalDiasTrabalhados,
          dias_selecionados: todosDiasSelecionados.join(', '),
          desconto_aplicado: descontoAplicado.toFixed(2),
          desconto_4h: descontoMenos4h.toFixed(2),
          total_bruto: totalBruto.toFixed(2),
          total_liquido: totalLiquido.toFixed(2)
      };

      try {
        let response;
        if (editandoId) {
          // Atualiza o registro existente
          response = await editarRegistroSupabase(idCalculo, dadosParaSalvar);
          
          // Remove o registro antigo do hist√≥rico local
          historicoVA = historicoVA.filter(item => item.id !== idCalculo);
        } else {
          // Cria um novo registro
          response = await fetch(`${SUPABASE_URL}/rest/v1/vale_alimentacao`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "apikey": SUPABASE_KEY,
              "Authorization": `Bearer ${SUPABASE_KEY}`,
              "Prefer": "return=representation"
            },
            body: JSON.stringify(dadosParaSalvar)
          });
        }

        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }

        // Adiciona ao hist√≥rico local
        historicoVA.unshift({
          ...dadosParaSalvar,
          nome, 
          periodo: periodoFormatado,
          diasTrabalhados: totalDiasTrabalhados, 
          descontos4h: qtdDescontos4h,
          total: totalLiquido,
          timestamp: timestamp
        });

        // Salva no localStorage como backup
        localStorage.setItem('historicoVA', JSON.stringify(historicoVA));

        atualizarHistorico();

        document.getElementById('btnExportarCompleto').style.display = 'block';
        document.getElementById('btnAtualizarDados').style.display = 'inline-block';

        mostrarPopup(
          editandoId ? 'Atualizado!' : 'Sucesso!', 
          editandoId ? 'C√°lculo atualizado com sucesso!' : 'C√°lculo salvo com sucesso no banco de dados.',
          'success'
        );
        
        // Limpa o modo de edi√ß√£o
        if (editandoId) {
          editandoId = null;
          limparCampos();
        }
      } catch (error) {
        console.error("Erro ao salvar no Supabase:", error);
        mostrarPopup('Erro', 'N√£o foi poss√≠vel salvar o c√°lculo. Os dados ser√£o armazenados localmente.', 'error');
        
        // Adiciona ao hist√≥rico local mesmo em caso de erro
        historicoVA.unshift({
            id: idCalculo,
            nome, 
            periodo: periodoFormatado,
            diasTrabalhados: totalDiasTrabalhados, 
            descontos4h: qtdDescontos4h,
            total: totalLiquido,
            timestamp: new Date().toISOString()
        });
        localStorage.setItem('historicoVA', JSON.stringify(historicoVA));
        atualizarHistorico();
      }
    }

    async function carregarDados() {
      try {
        // Tenta carregar do Supabase
        const response = await fetch(`${SUPABASE_URL}/rest/v1/vale_alimentacao?select=*&order=timestamp.desc`, {
          headers: {
            "apikey": SUPABASE_KEY,
            "Authorization": `Bearer ${SUPABASE_KEY}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const dadosSupabase = await response.json();
        
        // Verifica se h√° dados no Supabase
        if (dadosSupabase && dadosSupabase.length > 0) {
          historicoVA = dadosSupabase.map(item => {
            // Tenta recriar o per√≠odo formatado a partir dos dias selecionados
            let periodoFormatado = '';
            if (item.dias_selecionados) {
              const diasArray = item.dias_selecionados.split(', ');
              if (diasArray.length > 0) {
                const datasOrdenadas = diasArray.sort();
                const primeiroDia = datasOrdenadas[0];
                const ultimoDia = datasOrdenadas[datasOrdenadas.length - 1];
                
                if (primeiroDia && ultimoDia) {
                  const primeiroDiaFormatado = formatarDataExtenso(primeiroDia);
                  const ultimoDiaFormatado = formatarDataExtenso(ultimoDia);
                  periodoFormatado = `de ${primeiroDiaFormatado} at√© ${ultimoDiaFormatado}`;
                }
              }
            }
            
            return {
              ...item,
              nome: item.operador,
              periodo: periodoFormatado || item.meses,
              diasTrabalhados: item.dias_trabalhados,
              descontos4h: item.qtd_descontos_4h,
              total: parseFloat(item.total_liquido)
            };
          });
          
          // Salva no localStorage como backup
          localStorage.setItem('historicoVA', JSON.stringify(historicoVA));
        } else {
          // Se n√£o houver dados no Supabase, tenta carregar do localStorage
          const historicoSalvo = localStorage.getItem('historicoVA');
          if (historicoSalvo) {
            historicoVA = JSON.parse(historicoSalvo);
          }
        }
      } catch (error) {
        console.error("Erro ao carregar do Supabase, usando localStorage:", error);
        // Se houver erro, usa o localStorage como fallback
        const historicoSalvo = localStorage.getItem('historicoVA');
        if (historicoSalvo) {
          historicoVA = JSON.parse(historicoSalvo);
        }
      }
      
      // Atualiza a interface
      atualizarHistorico();
      atualizarFiltroOperadores();
    }

    function atualizarHistorico() {
      const tbody = document.querySelector("#tabelaHistorico tbody");
      tbody.innerHTML = '';

      const historicoFiltrado = filtrarListaHistorico();

      if (historicoFiltrado.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align: center;">Nenhum registro encontrado</td></tr>`;
        document.getElementById('resumo').style.display = 'none';
        return;
      }

      historicoFiltrado.forEach(item => {
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
          <td>${item.id}</td>
          <td>${item.nome}</td>
          <td>${item.periodo || item.meses}</td>
          <td>${item.diasTrabalhados}</td>
          <td>${item.descontos4h}</td>
          <td>R$ ${item.total.toFixed(2)}</td>
          <td>${new Date(item.timestamp).toLocaleString('pt-BR')}</td>
          <td class="no-print">
            <button class="btn-excluir" onclick="excluirItemHistorico(${item.id})">Excluir</button>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
      
      // Atualiza o resumo
      atualizarResumoHistorico(historicoFiltrado);
      document.getElementById('resumo').style.display = 'block';
      
      document.getElementById('btnExportarCompleto').style.display = historicoFiltrado.length > 0 ? 'block' : 'none';
    }
    
    function atualizarResumoHistorico(dados) {
      const resumoDiv = document.getElementById('resumoConteudo');
      
      // Agrupa por operador
      const porOperador = {};
      dados.forEach(item => {
        if (!porOperador[item.nome]) {
          porOperador[item.nome] = {
            totalCalculos: 0,
            totalDias: 0,
            totalValor: 0,
            ids: []
          };
        }
        
        porOperador[item.nome].totalCalculos++;
        porOperador[item.nome].totalDias += item.diasTrabalhados;
        porOperador[item.nome].totalValor += item.total;
        porOperador[item.nome].ids.push(item.id);
      });
      
      // Cria a tabela de resumo
      let html = '<div style="overflow-x: auto;"><table>';
      html += '<thead><tr><th>Operador</th><th>Total de C√°lculos</th><th>Total de Dias</th><th>Total Pago (R$)</th><th>IDs</th></tr></thead>';
      html += '<tbody>';
      
      for (const [operador, dados] of Object.entries(porOperador)) {
        html += `<tr>
          <td>${operador}</td>
          <td>${dados.totalCalculos}</td>
          <td>${dados.totalDias}</td>
          <td>R$ ${dados.totalValor.toFixed(2)}</td>
          <td>${dados.ids.join(', ')}</td>
        </tr>`;
      }
      
      html += '</tbody></table></div>';
      resumoDiv.innerHTML = html;
    }
    
    function atualizarFiltroOperadores() {
      const selectFiltro = document.getElementById('filtroOperador');
      const operadoresUnicos = [...new Set(historicoVA.map(item => item.nome))].sort();
      
      // Mant√©m a sele√ß√£o atual
      const valorAtual = selectFiltro.value;
      selectFiltro.innerHTML = '<option value="Todos">TODOS os operadores</option>';
      
      operadoresUnicos.forEach(op => {
        const option = document.createElement('option');
        option.value = op;
        option.textContent = op;
        selectFiltro.appendChild(option);
      });
      
      // Restaura a sele√ß√£o se ainda existir
      if (operadoresUnicos.includes(valorAtual)) {
        selectFiltro.value = valorAtual;
      }
    }

    function filtrarListaHistorico() {
        const filtroOperador = document.getElementById('filtroOperador').value;
        const filtroData = document.getElementById('filtroData').value;

        return historicoVA.filter(item => {
            // Filtro por operador
            const operadorMatch = filtroOperador === "Todos" || item.nome === filtroOperador;
            
            // Filtro por data
            const dataMatch = !filtroData || item.meses.split(', ')[0].startsWith(filtroData);

            return operadorMatch && dataMatch;
        });
    }

    function filtrarHistorico() {
        atualizarHistorico();
    }
    
    function limparFiltros() {
      document.getElementById('filtroOperador').value = 'Todos';
      document.getElementById('filtroData').value = '';
      filtrarHistorico();
    }

    function limparCampos() {
      document.getElementById('beneficiario').value = '';
      document.getElementById('valorDiario').value = '28.00';
      document.getElementById('tipoDesconto').value = 'percentual';
      document.getElementById('valorDesconto').value = '';
      document.getElementById('qtdDescontos4h').value = '';
      document.getElementById('mesSelecionado').value = new Date().toISOString().slice(0, 7);
      diasMarcados = {};
      mesesSelecionados = [];
      document.getElementById('mesesSelecionadosContainer').style.display = 'none';
      document.getElementById('mesesSelecionadosList').innerHTML = '';
      gerarCalendario();

      document.getElementById('resultado').style.display = 'none';
      document.getElementById('resultado').innerHTML = '';

      ultimoCalculo = null;
    }

    // Nova fun√ß√£o para exportar o c√°lculo atual em PDF
    function exportarPDFCalculoAtual() {
      if (!ultimoCalculo) {
        mostrarPopup('Aten√ß√£o', 'N√£o h√° c√°lculo para exportar. Primeiro fa√ßa um c√°lculo.', 'warning');
        return;
      }

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      
      // Configura√ß√µes do documento
      pdf.setProperties({
        title: `Vale Alimenta√ß√£o - ${ultimoCalculo.nome}`,
        subject: 'C√°lculo de Vale Alimenta√ß√£o',
        author: 'Sistema de C√°lculos',
        keywords: 'vale, alimenta√ß√£o, c√°lculo',
        creator: 'Sistema de C√°lculos'
      });
      
      // Cabe√ßalho
      pdf.setFontSize(16);
      pdf.setTextColor(46, 134, 193);
      pdf.setFont("helvetica", "bold");
      pdf.text(`VALE ALIMENTA√á√ÉO - ${ultimoCalculo.nome.toUpperCase()}`, 105, 15, { align: 'center' });
      
      pdf.setFontSize(12);
      pdf.setTextColor(100, 100, 100);
      pdf.setFont("helvetica", "normal");
      pdf.text(`ID: ${ultimoCalculo.id}`, 105, 22, { align: 'center' });
      pdf.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 105, 29, { align: 'center' });
      
      // Informa√ß√µes do c√°lculo
      pdf.setFontSize(11);
      pdf.setTextColor(0, 0, 0);
      
      let yPos = 40;
      const lineHeight = 7;
      const marginLeft = 15;
      
      // Dados b√°sicos
      pdf.text(`Operador: ${ultimoCalculo.nome}`, marginLeft, yPos);
      yPos += lineHeight;
      
      if (ultimoCalculo.periodoFormatado) {
        pdf.text(`Per√≠odo: ${ultimoCalculo.periodoFormatado}`, marginLeft, yPos);
        yPos += lineHeight;
      }
      
      pdf.text(`Valor Di√°rio: R$ ${ultimoCalculo.valorDiario.toFixed(2)}`, marginLeft, yPos);
      yPos += lineHeight;
      
      pdf.text(`Dias Trabalhados: ${ultimoCalculo.totalDiasTrabalhados}`, marginLeft, yPos);
      yPos += lineHeight;
      
      if (ultimoCalculo.qtdDescontos4h > 0) {
        pdf.text(`Dias com -4h: ${ultimoCalculo.qtdDescontos4h}`, marginLeft, yPos);
        yPos += lineHeight;
      }
      
      yPos += 5;
      
      // Detalhes do c√°lculo
      pdf.setFont("helvetica", "bold");
      pdf.text("DETALHES DO C√ÅLCULO", marginLeft, yPos);
      yPos += lineHeight;
      pdf.setFont("helvetica", "normal");
      
      // Linha do valor bruto
      pdf.text(`Total Bruto: ${ultimoCalculo.totalDiasTrabalhados} dias √ó R$ ${ultimoCalculo.valorDiario.toFixed(2)} = R$ ${ultimoCalculo.totalBruto.toFixed(2)}`, marginLeft, yPos);
      yPos += lineHeight;
      
      // Descontos
      if (ultimoCalculo.descontoAplicado > 0) {
        pdf.text(`Desconto (${ultimoCalculo.tipoDesconto === 'percentual' ? ultimoCalculo.valorDesconto + '%' : 'Fixo'}): R$ ${ultimoCalculo.descontoAplicado.toFixed(2)}`, marginLeft, yPos);
        yPos += lineHeight;
      }
      
      if (ultimoCalculo.descontoMenos4h > 0) {
        pdf.text(`Desconto por -4h: ${ultimoCalculo.qtdDescontos4h} √ó R$ ${ultimoCalculo.valorDiario.toFixed(2)} = R$ ${ultimoCalculo.descontoMenos4h.toFixed(2)}`, marginLeft, yPos);
        yPos += lineHeight;
      }
      
      yPos += 5;
      
      // Total
      pdf.setFont("helvetica", "bold");
      pdf.setTextColor(40, 167, 69);
      pdf.text(`TOTAL L√çQUIDO: R$ ${ultimoCalculo.totalLiquido.toFixed(2)}`, marginLeft, yPos);
      yPos += lineHeight + 5;
          
      // Adiciona linha horizontal
      pdf.setDrawColor(200, 200, 200);
      pdf.line(marginLeft, yPos + 5, 195, yPos + 5);
      yPos += 10;
      
      // Adiciona rodap√©
      pdf.setFontSize(10);
      pdf.setTextColor(150, 150, 150);
      pdf.text(`Assinatura de ${ultimoCalculo.nome}`, 105, yPos, { align: 'center' });
      
      // Salva o PDF
      pdf.save(`vale_alimentacao_${ultimoCalculo.nome.replace(' ', '_')}_${ultimoCalculo.id}.pdf`);
    }

    function exportarPDFCompleto() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'mm'
        });
        
        // Usa todo o hist√≥rico, n√£o apenas o filtrado
        const historicoCompleto = [...historicoVA];

        doc.setFontSize(16);
        doc.text("Hist√≥rico Completo de C√°lculos - Vale Alimenta√ß√£o", 105, 15, null, null, 'center');

        doc.setFontSize(10);
        
        // Tabela de registros
        const headers = [["ID", "Operador", "Per√≠odo", "Dias", "-4h", "Total (R$)", "Data/Hora"]];
        
        const dataTabela = historicoCompleto.map(item => {
          return [
            item.id,
            item.nome,
            item.periodo || item.meses,
            item.diasTrabalhados,
            item.descontos4h,
            item.total.toFixed(2),
            new Date(item.timestamp).toLocaleString('pt-BR')
          ];
        });
        
        doc.autoTable({
          head: headers,
          body: dataTabela,
          startY: 25,
          theme: "grid",
          headStyles: { 
            fillColor: [46, 134, 193],
            textColor: 255,
            fontStyle: 'bold'
          },
          alternateRowStyles: {
            fillColor: [240, 240, 240]
          },
          margin: { top: 25 },
          styles: {
            fontSize: 10,
            cellPadding: 3,
            overflow: 'linebreak'
          },
          columnStyles: {
            5: { halign: 'right' }
          }
        });

        doc.save(`historico_completo_va_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.pdf`);
    }
    
    // Fun√ß√£o para mostrar popup
    function mostrarPopup(titulo, mensagem, tipo = 'info') {
      return new Promise((resolve) => {
        const popup = document.createElement('div');
        popup.className = 'popup-overlay';
        
        const icon = tipo === 'success' ? '‚úÖ' : tipo === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
        const popupClass = tipo === 'success' ? 'popup-success' : tipo === 'error' ? 'popup-error' : tipo === 'warning' ? 'popup-warning' : '';
        
        popup.innerHTML = `
          <div class="popup-container ${popupClass}">
            <div class="popup-icon">${icon}</div>
            <div class="popup-title">${titulo}</div>
            <div class="popup-message">${mensagem}</div>
            <div class="popup-buttons">
              <button class="popup-button popup-ok" id="popupOK">OK</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(popup);
        
        document.getElementById('popupOK').addEventListener('click', () => {
          document.body.removeChild(popup);
          resolve(true);
        });
      });
    }

    // Fun√ß√£o para mostrar popup de confirma√ß√£o estilizado
    function mostrarPopupConfirmacao(titulo, mensagem, detalhes = null) {
      return new Promise((resolve) => {
        const popup = document.createElement('div');
        popup.className = 'popup-overlay';
        
        let detalhesHTML = '';
        if (detalhes) {
          detalhesHTML = `
            <div class="popup-details">
              ${Object.entries(detalhes).map(([key, value]) => `
                <div class="popup-details-item"><strong>${key}:</strong> ${value}</div>
              `).join('')}
            </div>
          `;
        }
        
        popup.innerHTML = `
          <div class="popup-container popup-warning">
            <div class="popup-icon">‚ö†Ô∏è</div>
            <div class="popup-title">${titulo}</div>
            <div class="popup-message">${mensagem}</div>
            ${detalhesHTML}
            <div class="popup-buttons">
              <button class="popup-button popup-confirm" id="popupConfirm">Sim</button>
              <button class="popup-button popup-cancel" id="popupCancel">N√£o</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(popup);
        
        document.getElementById('popupConfirm').addEventListener('click', () => {
          document.body.removeChild(popup);
          resolve(true);
        });
        
        document.getElementById('popupCancel').addEventListener('click', () => {
          document.body.removeChild(popup);
          resolve(false);
        });
      });
    }

    // Fun√ß√£o para editar item
    function editarItem(id) {
      const item = historicoVA.find(item => item.id === id);
      if (!item) return;
      
      // Preenche o formul√°rio com os dados do item
      document.getElementById('beneficiario').value = item.nome;
      document.getElementById('valorDiario').value = parseFloat(item.valor_diario).toFixed(2);
      document.getElementById('tipoDesconto').value = item.tipo_desconto;
      document.getElementById('valorDesconto').value = parseFloat(item.valor_desconto).toFixed(2);
      document.getElementById('qtdDescontos4h').value = item.qtd_descontos_4h;
      
      // Limpa os meses e dias selecionados
      mesesSelecionados = [];
      diasMarcados = {};
      
      // Processa os meses e dias selecionados
      const meses = item.meses.split(', ');
      meses.forEach(mes => {
        mesesSelecionados.push(mes);
        
        // Filtra os dias para este m√™s
        const diasDoMes = item.dias_selecionados.split(', ')
          .filter(dia => dia.startsWith(mes))
          .map(dia => parseInt(dia.split('-')[2]));
        
        if (diasDoMes.length > 0) {
          diasMarcados[mes] = diasDoMes;
        }
      });
      
      // Atualiza a UI
      atualizarMesesSelecionadosUI();
      document.getElementById('mesesSelecionadosContainer').style.display = 'block';
      
      // Define o primeiro m√™s como selecionado no calend√°rio
      if (meses.length > 0) {
        document.getElementById('mesSelecionado').value = meses[0];
        gerarCalendario();
      }
      
      // Define que estamos editando
      editandoId = id;
      
      // Rola para o topo do formul√°rio
      window.scrollTo(0, 0);
      
      // Altera o bot√£o calcular para indicar edi√ß√£o
      document.querySelector('.btn-success').textContent = 'ATUALIZAR C√ÅLCULO';
    }

    // Fun√ß√£o para excluir item do hist√≥rico
    async function excluirItemHistorico(id) {
      const confirmar = await mostrarPopupConfirmacao(
        "Confirmar exclus√£o",
        "Tem certeza que deseja excluir este registro permanentemente?",
        { "ID": id, "Operador": historicoVA.find(item => item.id === id)?.nome }
      );
      
      if (!confirmar) {
        return;
      }
      
      try {
        // Remove do Supabase
        const response = await fetch(`${SUPABASE_URL}/rest/v1/vale_alimentacao?id=eq.${id}`, {
          method: "DELETE",
          headers: {
            "apikey": SUPABASE_KEY,
            "Authorization": `Bearer ${SUPABASE_KEY}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        // Remove do array local
        historicoVA = historicoVA.filter(item => item.id !== id);
        
        // Salva no localStorage
        localStorage.setItem('historicoVA', JSON.stringify(historicoVA));
        
        // Atualiza a interface
        atualizarHistorico();
        
        mostrarPopup('Exclu√≠do!', 'O registro foi removido com sucesso.', 'success');
      } catch (error) {
        console.error("Erro ao excluir:", error);
        mostrarPopup('Erro', 'N√£o foi poss√≠vel excluir o registro.', 'error');
      }
    }

    // Fun√ß√µes para gerenciar operadores
    function abrirModalOperadores() {
      const modal = document.createElement('div');
      modal.className = 'popup-overlay';
      
      // Cria a lista de operadores em formato HTML
      let operadoresListHTML = '';
      operadores.forEach((operador, index) => {
        operadoresListHTML += `
          <div class="operador-item">
            <span>${operador}</span>
            <div class="operador-actions">
              <button class="btn-remove-small" onclick="removerOperadorModal(${index})">Remover</button>
            </div>
          </div>
        `;
      });
      
      modal.innerHTML = `
        <div class="operador-modal">
          <div class="popup-title">üë∑ Gerenciar Operadores</div>
          <div class="popup-message">
            <p>Adicione, edite ou remova operadores da lista.</p>
          </div>
          
          <div class="operador-list">
            ${operadoresListHTML || '<div style="text-align: center; padding: 20px; color: #6c757d;">Nenhum operador cadastrado</div>'}
          </div>
          
          <div class="operador-input-group">
            <input type="text" id="novoOperadorInput" placeholder="Nome do novo operador" style="flex: 1;">
            <button class="btn btn-success" onclick="adicionarOperadorModal()">Adicionar</button>
          </div>
          
          <div class="popup-buttons" style="margin-top: 20px;">
            <button class="popup-button popup-ok" id="fecharModalOperadores">Fechar</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('fecharModalOperadores').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // Adiciona evento para pressionar Enter no input
      document.getElementById('novoOperadorInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          adicionarOperadorModal();
        }
      });
      
      // Foca no input
      document.getElementById('novoOperadorInput').focus();
    }
    
    function adicionarOperadorModal() {
      const input = document.getElementById('novoOperadorInput');
      const nomeOperador = input.value.trim();
      
      if (!nomeOperador) {
        mostrarPopup('Aten√ß√£o', 'Por favor, insira um nome para o operador.', 'warning');
        return;
      }
      
      // Verifica se o operador j√° existe
      if (operadores.includes(nomeOperador)) {
        mostrarPopup('Aten√ß√£o', 'Este operador j√° est√° na lista!', 'warning');
        input.value = '';
        return;
      }
      
      // Adiciona o operador √† lista
      operadores.push(nomeOperador);
      operadores.sort(); // Ordena alfabeticamente
      
      // Salva no localStorage
      salvarOperadores();
      
      // Atualiza o select
      atualizarSelectOperadores();
      
      // Limpa o input
      input.value = '';
      
      // Atualiza a modal
      const modal = document.querySelector('.popup-overlay');
      document.body.removeChild(modal);
      abrirModalOperadores();
      
      mostrarPopup('Sucesso!', `Operador "${nomeOperador}" adicionado com sucesso.`, 'success');
    }
    
    function removerOperadorModal(index) {
      const operador = operadores[index];
      
      mostrarPopupConfirmacao(
        "Remover Operador",
        `Tem certeza que deseja remover o operador "${operador}"?`,
        { "Operador": operador }
      ).then(confirmado => {
        if (confirmado) {
          // Remove o operador
          operadores.splice(index, 1);
          
          // Salva no localStorage
          salvarOperadores();
          
          // Atualiza o select
          atualizarSelectOperadores();
          
          // Atualiza a modal
          const modal = document.querySelector('.popup-overlay');
          document.body.removeChild(modal);
          abrirModalOperadores();
          
          mostrarPopup('Removido!', `Operador "${operador}" removido com sucesso.`, 'success');
        }
      });
    }
    
    function removerOperadorSelecionado() {
      const select = document.getElementById('beneficiario');
      const operadorSelecionado = select.value;
      
      if (!operadorSelecionado) {
        mostrarPopup('Aten√ß√£o', 'Nenhum operador selecionado para remover.', 'warning');
        return;
      }
      
      mostrarPopupConfirmacao(
        "Remover Operador",
        `Tem certeza que deseja remover o operador "${operadorSelecionado}"?`,
        { "Operador": operadorSelecionado }
      ).then(confirmado => {
        if (confirmado) {
          // Remove o operador da lista
          const index = operadores.indexOf(operadorSelecionado);
          if (index > -1) {
            operadores.splice(index, 1);
            
            // Salva no localStorage
            salvarOperadores();
            
            // Atualiza o select
            atualizarSelectOperadores();
            
            // Limpa a sele√ß√£o
            select.value = '';
            
            mostrarPopup('Removido!', `Operador "${operadorSelecionado}" removido com sucesso.`, 'success');
          }
        }
      });
    }

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
      // Carrega dados iniciais
      const hoje = new Date();
      const mesAtualISO = hoje.toISOString().slice(0, 7);
      document.getElementById('mesSelecionado').value = mesAtualISO;
      document.getElementById('filtroData').value = mesAtualISO;
      gerarCalendario();
      
      // Inicializa a lista de operadores
      inicializarOperadores();
      
      // Carrega dados do Supabase (com fallback para localStorage)
      carregarDados();
      
      // Configura eventos de filtro
      document.getElementById('filtroOperador').addEventListener('change', filtrarHistorico);
      document.getElementById('filtroData').addEventListener('change', filtrarHistorico);
    });
  </script>
</body>
</html>
