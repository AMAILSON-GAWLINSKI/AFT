<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Erros - AFT Qu√≠mica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    :root {
      --primary: #2E86C1;
      --danger: #E74C3C;
      --success: #28B463;
      --warning: #F39C12;
      --gray: #F2F2F2;
    }
    
    /* Reset e estilos base */
    * {
      box-sizing: border-box;
      transition: all 0.2s ease;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      color: #333;
      min-height: 100vh;
      padding: 15px;
      margin: 0;
    }

    .container {
      max-width: 1100px;
      width: 100%;
      margin: 0 auto;
      background: #ffffff;
      min-height: 100vh;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    h1, h2, h3 {
      text-align: center;
      color: #38a738c9;
      margin-top: 0;
    }
    
    h1 {
      font-size: 1.8rem;
      margin-bottom: 20px;
    }
    
    h2 {
      font-size: 1.5rem;
    }
    
    h3 {
      font-size: 1.3rem;
    }

    /* Estilos do formul√°rio */
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-col {
      flex: 1;
      min-width: 200px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* Estilos de cards e tabelas */
    .card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      font-size: 0.85rem;
    }

    th {
      background-color: var(--primary);
      color: white;
      padding: 10px;
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: 0.9rem;
    }

    td { 
      padding: 8px; 
      border-bottom: 1px solid #ddd; 
      text-align: center;
    }

    /* Bot√µes */
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.9rem;
      white-space: nowrap;
      min-width: 120px;
      text-align: center;
    }

    .btn-primary { background-color: var(--primary); }
    .btn-secondary { background-color: #5A5A5A; }
    .btn-success { background-color: var(--success); }
    .btn-danger { background-color: var(--danger); }
    .btn-warning { background-color: var(--warning); color: #212529; }
    .btn-info { background-color: #17a2b8; }
    .btn-gray { background-color: #888; }
    
    .btn:hover {
      opacity: 0.9;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      width: 100%;
    }

    /* Resultado e resumo */
    #resultado {
      margin-top: 15px;
      padding: 15px;
      background: #e9f7ef;
      border-left: 5px solid #2e7d32;
      border-radius: 8px;
      display: none;
      line-height: 1.6;
    }

    #resumo {
      margin-top: 15px;
      padding: 15px;
      background: #eef;
      border-radius: 8px;
      overflow-x: auto;
    }
    
    /* Estilo para os bot√µes de a√ß√£o */
    .btn-excluir {
      background-color: #E74C3C;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 8px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    
    .btn-editar {
      background-color: #2E86C1;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 8px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-right: 5px;
    }
    
    .btn-excluir:hover, .btn-editar:hover {
      opacity: 0.8;
    }
    
    /* Estilo para o popup */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .popup-container {
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      max-width: 90%;
      width: 400px;
      text-align: center;
      animation: fadeIn 0.3s;
    }
    
    .popup-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 15px;
    }
    
    .popup-message {
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .popup-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }
    
    .popup-button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      min-width: 80px;
    }
    
    .popup-button:hover {
      opacity: 0.9;
    }
    
    .popup-confirm {
      background-color: var(--success);
      color: white;
    }
    
    .popup-cancel {
      background-color: var(--danger);
      color: white;
    }
    
    .popup-ok {
      background-color: var(--primary);
      color: white;
      width: 100%;
    }
    
    .popup-highlight {
      font-weight: bold;
      color: var(--danger);
    }
    
    .popup-details {
      background-color: #F8F9F9;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: left;
      font-size: 0.9rem;
    }
    
    .popup-details-item {
      margin-bottom: 5px;
    }
    
    .popup-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }
    
    .popup-success .popup-title {
      color: var(--success);
    }
    
    .popup-warning .popup-title {
      color: var(--warning);
    }
    
    .popup-error .popup-title {
      color: var(--danger);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .form-col {
        min-width: 100%;
      }
      
      .btn {
        padding: 10px 8px;
        font-size: 0.8rem;
        min-width: 100px;
      }
      
      .btn-editar, .btn-excluir {
        padding: 4px 6px;
        font-size: 0.7rem;
      }
      
      .popup-container {
        width: 90%;
        padding: 15px;
      }
      
      .popup-title {
        font-size: 1.1rem;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      
      .card {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .popup-buttons {
        flex-direction: column;
        gap: 10px;
      }
      
      .popup-button {
        width: 100%;
      }
      
      .btn-row {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
    
    /* Ajuste para os bot√µes principais */
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .btn-principal {
      flex: 1;
      min-width: 150px;
    }

    /* Valor em destaque */
    .valor-destaque {
      background: #dff0d8;
      color: #155724;
      padding: 15px;
      border-radius: 6px;
      font-size: 1.2rem;
      text-align: center;
      margin-top: 20px;
    }

    /* Para impress√£o */
    @media print {
      .no-print {
        display: none !important;
      }
      
      body {
        background: white;
        padding: 0;
      }
      
      .container {
        box-shadow: none;
        background: white;
        padding: 10px;
      }
      
      .btn {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>CONTROLE DE ERROS</h1>
    
    <!-- Formul√°rio principal -->
    <div class="card">
      <div class="form-row">
        <div class="form-col">
          <label>üë∑ Operador:</label>
          <select id="operador" required>
            <option value="">Selecione um operador</option>
            <option value="Caio Jos√©">Caio Jos√©</option>
            <option value="Daniel Rodrigo">Daniel Rodrigo</option>
            <option value="Igor Nascimento">Igor Nascimento</option>
            <option value="Lissandro da Silva">Lissandro da Silva</option>
            <option value="Leonardo Vaz">Leonardo Vaz</option>
            <option value="Patrick Darlan">Patrick Darlan</option>
            <option value="Ricardo Alves">Ricardo Alves</option>
            <option value="Keniel vasque">Keniel vasque</option>
          </select>
        </div>
        <div class="form-col">
          <label>‚ùå Erro:</label>
          <select id="erro" required>
            <option value="SEM ERROS">SEM ERROS</option>
            <option value="N√£o sincronizou¬†no¬†final¬†do¬†dia">N√£o sincronizou¬†no¬†final¬†do¬†dia</option>            
            <option value="N√£o marcou corretamente o horario que realizou o servi√ßo">N√£o marcou corretamente o horario que realizou o servi√ßo</option>            
            <option value="Cancelou rota sem justificativa">Cancelou rota sem justificativa</option>
            <option value="N√£o avisou o atraso com 30 min. De anteced√™ncia">N√£o avisou o atraso com 30 min. De anteced√™ncia</option>
            <option value="Chegou atrasado na empresa">Chegou atrasado na empresa</option>
            <option value="N√£o usou o produto certo no servi√ßo">N√£o usou o produto certo no servi√ßo</option>
            <option value="N√£o tirou a foto do antes e depois">N√£o tirou a foto do antes e depois</option>
            <option value="N√£o tirou a foto da tampa da caixa">N√£o tirou a foto da tampa da caixa</option>
            <option value="N√£o abriu e fechou a os no hor√°rio certo">N√£o abriu e fechou a os no hor√°rio certo</option>
            <option value="Lan√ßo errado a quantidade de produto no sistema">Lan√ßo errado a quantidade de produto no sistema</option>
            <option value="N√£o lan√ßou o produto no sistema">N√£o lan√ßou o produto no sistema</option>
            <option value="Teve retrabalho de Expugos">Teve retrabalho de Expugos</option>
            <option value="Teve retrabalho de Limpezas">Teve retrabalho de Limpezas</option>
            <option value="Teve retrabalho de dedetiza√ß√£o ou desratiza√ß√£o">Teve retrabalho de dedetiza√ß√£o ou desratiza√ß√£o</option>
            <option value="Teve reclama√ß√£o do cliente">Teve reclama√ß√£o do cliente</option>
            <option value="N√£o est√° uniformizado">N√£o est√° uniformizado</option>
            <option value="N√£o usa EPI adequadamente">N√£o usa EPI adequadamente</option>
            <option value="N√£o cobrou ou n√£o colocou o comprovante de pg no grupo">N√£o cobrou ou n√£o colocou o comprovante de pg no grupo</option>
            <option value="N√£o registrou corretamente a n√£o conformidade">N√£o registrou corretamente a n√£o conformidade</option>
            <option value="N√£o registro na planilha os parametros da piscina">N√£o registro na planilha os parametros da piscina</option>
            <option value="N√£o registrou corretamente o carro no app">N√£o registrou corretamente o carro no app</option>
            <option value="N√£o coletou assinatura no app">N√£o coletou assinatura no app</option>
            <option value="Lan√ßou produto errado">Lan√ßou produto errado</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <label>üìÖ Data:</label>
          <input type="date" id="data" required>
        </div>
        <div class="form-col">
          <label>üîÅ Repetido:</label>
          <select id="repetido">
            <option value="N√£o">N√£o</option>
            <option value="Sim">Sim</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <label>üè∑Ô∏è Marca de Erro Espec√≠fico:</label>
          <input type="text" id="marcaErro" placeholder="Informe uma marca√ß√£o espec√≠fica (opcional)">
        </div>
        <div class="form-col">
          <label>‚úîÔ∏è Corre√ß√£o:</label>
          <select id="correcao" required>
            <option value="">Selecione uma corre√ß√£o</option>
            <option value="Treinamento aplicado">Treinamento aplicado</option>
            <option value="Advert√™ncia verbal">Advert√™ncia verbal</option>
            <option value="Refazer tarefa com supervis√£o">Refazer tarefa com supervis√£o</option>
            <option value="Reuni√£o com gestor">Reuni√£o com gestor</option>
            <option value="Falado via Whatsapp">Falado via Whatsapp</option>
            <option value="Outro">Outro</option>
          </select>
          <input type="text" id="campoOutro" placeholder="Descreva a corre√ß√£o personalizada" style="display: none; margin-top: 10px;">
        </div>
      </div>

      <div class="form-row">
        <div class="form-col">
          <label>üìù Observa√ß√µes:</label>
          <textarea id="obs" placeholder="Adicione observa√ß√µes relevantes (opcional)"></textarea>
        </div>
      </div>

      <div class="btn-container">
        <button onclick="adicionarErro()" class="btn btn-success btn-principal">ADICIONAR</button>
        <button id="btnExportar" onclick="exportarPDFFiltro()" class="btn btn-info btn-principal">üìÑ PDF (Filtro)</button>
        <button id="btnExportarCompleto" onclick="exportarPDFCompleto()" class="btn btn-secondary btn-principal">üì§ PDF (Completo)</button>
        <button id="btnAtualizarDados" class="btn btn-warning btn-principal" onclick="carregarDados(); sincronizarItensLocais();" title="Atualiza dados do servidor e sincroniza altera√ß√µes locais">üîÑ ATUALIZAR</button>
      </div>
    </div>

    <!-- Filtros -->
    <div class="card">
      <h3>üîç Filtros</h3>
      <div class="form-row">
        <div class="form-col">
          <label>Operador:</label>
          <select id="filtroOperador">
            <option value="Todos">TODOS os operadores</option>
          </select>
        </div>
        <div class="form-col">
          <label>Data:</label>
          <input type="month" id="filtroData" value="">
        </div>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" onclick="filtrarErros()">Aplicar Filtros</button>
        <button class="btn btn-gray" onclick="limparFiltros()">Limpar Filtros</button>
      </div>
    </div>
    
    <!-- Tabela de hist√≥rico -->
    <div class="card">
      <div style="overflow-x: auto;">
        <table id="tabelaErros">
          <thead>
            <tr>
              <th>ID</th>
              <th>Operador</th>
              <th>Erro</th>
              <th>Marca Erro</th>
              <th>Data</th>
              <th>Repetido</th>
              <th>Corre√ß√£o</th>
              <th>Observa√ß√µes</th>
              <th>Total Descontado (R$)</th>
              <th>Valor Final (R$)</th>
              <th class="no-print">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <!-- Resumo -->
    <div id="resumo" class="card">
      <h3>üìà Resumo dos Valores</h3>
      <div id="resumoConteudo"></div>
    </div>
  </div>

  <script>
    // Configura√ß√µes do Supabase - ATUALIZADO para usar a nova tabela
    const SUPABASE_URL = "https://nsfliimhsokyzhacnfdg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zZmxpaW1oc29reXpoYWNuZmRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczNDg3MzQsImV4cCI6MjA2MjkyNDczNH0.QqosDhPG2xK16rAfitDiW837GMIL_dh5lmDwg8cOn_8";
    const { jsPDF } = window.jspdf;
    
    // Vari√°veis globais
    let registros = [];
    let editandoId = null;

    // Tabela de dedu√ß√µes (valores em reais)
    const deducoes = {
      "N√£o sincronizou¬†no¬†final¬†do¬†dia": 25,
      "N√£o marcou corretamente o horario que realizou o servi√ßo": 25,
      "Cancelou rota sem justificativa": 150,
      "N√£o avisou o atraso com 30 min. De anteced√™ncia": 25,
      "Chegou atrasado na empresa": 25,
      "N√£o usou o produto certo no servi√ßo": 50,
      "N√£o tirou a foto do antes e depois": 25,
      "N√£o tirou a foto da tampa da caixa": 25,
      "N√£o abriu e fechou a os no hor√°rio certo": 25,
      "Lan√ßo errado a quantidade de produto no sistema": 25,
      "N√£o lan√ßou o produto no sistema": 50,
      "Teve retrabalho de Expugos": 100,
      "Teve retrabalho de Limpezas": 50,
      "Teve retrabalho de dedetiza√ß√£o ou desratiza√ß√£o": 50,
      "Teve reclama√ß√£o do cliente": 50,
      "N√£o est√° uniformizado": 25,
      "N√£o usa EPI adequadamente": 50,
      "N√£o cobrou ou n√£o colocou o comprovante de pg no grupo": 25,
      "N√£o registrou corretamente a n√£o conformidade": 25,
      "N√£o registro na planilha os parametros da piscina": 25,
      "N√£o registrou corretamente o carro no app": 25,
      "N√£o coletou assinatura no app": 25,
      "Lan√ßou produto errado": 25
    };
    // Valor base para c√°lculo
    const baseValor = 500;

    // Fun√ß√£o para mostrar popup de confirma√ß√£o
    function mostrarPopupConfirmacao(titulo, mensagem, detalhes = null) {
      return new Promise((resolve) => {
        const popup = document.createElement('div');
        popup.className = 'popup-overlay';
        
        let detalhesHTML = '';
        if (detalhes) {
          detalhesHTML = `
            <div class="popup-details">
              ${Object.entries(detalhes).map(([key, value]) => `
                <div class="popup-details-item"><strong>${key}:</strong> ${value}</div>
              `).join('')}
            </div>
          `;
        }
        
        popup.innerHTML = `
          <div class="popup-container popup-warning">
            <div class="popup-icon">‚ö†Ô∏è</div>
            <div class="popup-title">${titulo}</div>
            <div class="popup-message">${mensagem}</div>
            ${detalhesHTML}
            <div class="popup-buttons">
              <button class="popup-button popup-confirm" id="popupConfirm">Sim</button>
              <button class="popup-button popup-cancel" id="popupCancel">N√£o</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(popup);
        
        document.getElementById('popupConfirm').addEventListener('click', () => {
          document.body.removeChild(popup);
          resolve(true);
        });
        
        document.getElementById('popupCancel').addEventListener('click', () => {
          document.body.removeChild(popup);
          resolve(false);
        });
      });
    }

    // Fun√ß√£o para mostrar popup de informa√ß√£o
    function mostrarPopupInformacao(titulo, mensagem, tipo = 'info') {
      return new Promise((resolve) => {
        const popup = document.createElement('div');
        popup.className = 'popup-overlay';
        
        const icon = tipo === 'success' ? '‚úÖ' : tipo === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
        const popupClass = tipo === 'success' ? 'popup-success' : tipo === 'error' ? 'popup-error' : '';
        
        popup.innerHTML = `
          <div class="popup-container ${popupClass}">
            <div class="popup-icon">${icon}</div>
            <div class="popup-title">${titulo}</div>
            <div class="popup-message">${mensagem}</div>
            <div class="popup-buttons">
              <button class="popup-button popup-ok" id="popupOK">OK</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(popup);
        
        document.getElementById('popupOK').addEventListener('click', () => {
          document.body.removeChild(popup);
          resolve(true);
        });
      });
    }

    // Fun√ß√£o para mostrar popup que fecha automaticamente
    function mostrarPopupAutomatico(titulo, mensagem, tipo = 'info') {
      const popupDiv = document.createElement('div');
      popupDiv.className = 'popup-overlay';
      
      const icon = tipo === 'success' ? '‚úÖ' : tipo === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
      const popupClass = tipo === 'success' ? 'popup-success' : 
                        tipo === 'error' ? 'popup-error' : 
                        tipo === 'warning' ? 'popup-warning' : '';
      
      popupDiv.innerHTML = `
        <div class="popup-container ${popupClass}">
          <div class="popup-icon">${icon}</div>
          <div class="popup-title">${titulo}</div>
          <div class="popup-message">${mensagem}</div>
          <div class="popup-buttons">
            <button class="popup-button popup-ok" id="popupAutoClose">OK</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(popupDiv);
      
      // Fecha automaticamente ap√≥s 2 segundos
      const timer = setTimeout(() => {
        if (document.body.contains(popupDiv)) {
          document.body.removeChild(popupDiv);
        }
      }, 2000);
      
      // Fecha ao clicar no bot√£o
      document.getElementById('popupAutoClose').addEventListener('click', () => {
        clearTimeout(timer);
        document.body.removeChild(popupDiv);
      });
    }

    // Fun√ß√£o para gerar ID √∫nico - ATUALIZADO para seguir o padr√£o do Aluguel de Ve√≠culos
    function gerarID() {
      const min = 10000;
      const max = 99999;
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    // Fun√ß√£o para formatar data para o padr√£o brasileiro
    function formatarDataBR(dataISO) {
      if (!dataISO) return "-";
      const [ano, mes, dia] = dataISO.split("-");
      return `${dia}/${mes}/${ano}`;
    }

    // Fun√ß√£o para editar um registro no Supabase - ATUALIZADO para usar a nova tabela
    async function editarRegistroSupabase(id, dadosAtualizados) {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/erro-operadorV2?id=eq.${id}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_KEY,
            "Authorization": `Bearer ${SUPABASE_KEY}`
          },
          body: JSON.stringify(dadosAtualizados)
        });

        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.error("Erro ao editar registro:", error);
        throw error;
      }
    }
    
    // Fun√ß√£o para adicionar erro - ATUALIZADO para usar a nova tabela
    async function adicionarErro() {
      // Obt√©m os valores dos campos
      const operador = document.getElementById("operador").value;
      const erro = document.getElementById("erro").value;
      const data = document.getElementById("data").value;
      const repetido = document.getElementById("repetido").value;
      let correcao = document.getElementById("correcao").value;
      const obs = document.getElementById("obs").value.trim();
      const marcaErro = document.getElementById("marcaErro").value.trim();
      
      // Trata o campo "Outro" se selecionado
      if (correcao === "Outro") {
        const campoOutro = document.getElementById("campoOutro").value.trim();
        if (!campoOutro) {
          await mostrarPopupInformacao(
            "Campo obrigat√≥rio", 
            "Por favor, descreva a corre√ß√£o personalizada no campo 'Outro'.",
            'error'
          );
          return;
        }
        correcao = campoOutro;
      }
      
      // Valida√ß√£o dos campos obrigat√≥rios
      if (!operador || !erro || !data || !correcao) {
        await mostrarPopupInformacao(
          "Campos obrigat√≥rios", 
          "Preencha todos os campos obrigat√≥rios marcados com asterisco (*).",
          'error'
        );
        return;
      }
      
      // Verifica se j√° existe um erro igual no mesmo dia
      if (erro !== "SEM ERROS") {
        const erroDuplicado = registros.find(r => 
          r.operador === operador && 
          r.erro === erro && 
          r.data === data
        );
        
        if (erroDuplicado) {
          const detalhes = {
            "Operador": operador,
            "Erro": erro,
            "Data": formatarDataBR(data),
            "Corre√ß√£o anterior": erroDuplicado.correcao,
            "Valor descontado": `R$ ${erroDuplicado.valor_total_descontado.toFixed(2)}`,
            "Valor final": `R$ ${erroDuplicado.valor_final_pago.toFixed(2)}`
          };
          
          const confirmar = await mostrarPopupConfirmacao(
            "‚ö†Ô∏è Erro duplicado detectado",
            `J√° existe um registro id√™ntico para <strong>${operador}</strong> na data <strong>${formatarDataBR(data)}</strong>. Deseja adicionar mesmo assim?`,
            detalhes
          );
          
          if (!confirmar) {
            return;
          }
        }
      }
      
      // Gera ID √∫nico seguindo o padr√£o do Aluguel de Ve√≠culos
      const idUnico = editandoId || gerarID();
      
      // Calcula os valores monet√°rios
      const valorDescontado = erro !== "SEM ERROS" ? (deducoes[erro] || 0) : 0;
      const valorFinal = baseValor - valorDescontado;
      
      // Cria o objeto do erro com ID √∫nico
      const novoErro = { 
        id: idUnico,
        operador: operador, 
        erro: erro, 
        data: data, 
        repetido: repetido, 
        correcao: correcao, 
        obs: obs, 
        marca_erro: marcaErro,
        valor_total_descontado: valorDescontado,
        valor_final_pago: valorFinal,
        timestamp: new Date().toISOString(),
        periodo: formatarDataBR(data),
        dias_selecionados: data // Para manter consist√™ncia com a estrutura do Aluguel de Ve√≠culos
      };
      
      try {
        let response;
        if (editandoId) {
          // Atualiza o registro existente
          response = await editarRegistroSupabase(idUnico, novoErro);
          
          // Remove o registro antigo do hist√≥rico local
          registros = registros.filter(item => item.id !== idUnico);
        } else {
          // Cria um novo registro na nova tabela
          response = await fetch(`${SUPABASE_URL}/rest/v1/erro-operadorV2`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "apikey": SUPABASE_KEY,
              "Authorization": `Bearer ${SUPABASE_KEY}`,
              "Prefer": "return=representation"
            },
            body: JSON.stringify(novoErro)
          });
        }

        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }

        // Adiciona ao array de registros
        registros.push(novoErro);
        
        // Mostra popup de confirma√ß√£o de envio
        await mostrarPopupInformacao(
          "‚úÖ Registro salvo com sucesso!",
          `O erro foi registrado para <strong>${operador}</strong> com valor final de <strong>R$ ${valorFinal.toFixed(2)}</strong>.`,
          'success'
        );
        
        // Salva e atualiza a interface
        salvarLocal();
        atualizarTabela();
        atualizarResumo();
        atualizarFiltroOperadores();
        
        // Limpa o formul√°rio (exceto a data)
        document.getElementById("operador").value = "";
        document.getElementById("erro").value = "SEM ERROS";
        document.getElementById("repetido").value = "N√£o";
        document.getElementById("correcao").value = "";
        document.getElementById("campoOutro").value = "";
        document.getElementById("campoOutro").style.display = "none";
        document.getElementById("obs").value = "";
        document.getElementById("marcaErro").value = "";
        
        // Limpa o modo de edi√ß√£o
        if (editandoId) {
          editandoId = null;
        }
        
        // Foca no operador para novo cadastro
        document.getElementById("operador").focus();
      } catch (error) {
        console.error("Erro ao salvar no Supabase:", error);
        // Adiciona ao hist√≥rico local mesmo em caso de erro
        registros.push(novoErro);
        salvarLocal();
        atualizarTabela();
        atualizarResumo();
        atualizarFiltroOperadores();
        
        await mostrarPopupInformacao(
          "Erro de conex√£o",
          "N√£o foi poss√≠vel salvar os dados no servidor. Os dados foram salvos localmente e ser√£o sincronizados quando a conex√£o for restabelecida.",
          'error'
        );
      }
    }

    // Fun√ß√£o para carregar dados do Supabase - ATUALIZADO para usar a nova tabela
    async function carregarDados() {
      try {
        // Tenta carregar do Supabase (nova tabela)
        const response = await fetch(`${SUPABASE_URL}/rest/v1/erro-operadorV2?select=*&order=timestamp.desc`, {
          headers: {
            "apikey": SUPABASE_KEY,
            "Authorization": `Bearer ${SUPABASE_KEY}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const dadosSupabase = await response.json();
        
        // Verifica se h√° dados no Supabase
        if (dadosSupabase && dadosSupabase.length > 0) {
          // Verifica se h√° dados locais n√£o sincronizados
          const historicoSalvo = localStorage.getItem('registrosErros');
          let dadosLocais = [];
          
          if (historicoSalvo) {
            dadosLocais = JSON.parse(historicoSalvo);
            
            // Filtra apenas os itens locais que n√£o existem no Supabase
            const itensNaoSincronizados = dadosLocais.filter(itemLocal => 
                !dadosSupabase.some(itemSupabase => itemSupabase.id === itemLocal.id)
            );
            
            // Combina os dados (Supabase + itens locais n√£o sincronizados)
            registros = [
                ...dadosSupabase.map(item => ({
                    ...item,
                    data: item.data.split('T')[0] // Remove a parte do tempo da data
                })),
                ...itensNaoSincronizados
            ];
          } else {
            registros = dadosSupabase.map(item => ({
                ...item,
                data: item.data.split('T')[0] // Remove a parte do tempo da data
            }));
          }
          
          // Salva no localStorage como backup
          localStorage.setItem('registrosErros', JSON.stringify(registros));
        } else {
          // Se n√£o houver dados no Supabase, tenta carregar do localStorage
          const historicoSalvo = localStorage.getItem('registrosErros');
          if (historicoSalvo) {
            registros = JSON.parse(historicoSalvo);
          }
        }
        
        // Mostra popup que fecha automaticamente
        mostrarPopupAutomatico('Dados Atualizados', 'Os dados foram carregados com sucesso.', 'success');
        
      } catch (error) {
        console.error("Erro ao carregar do Supabase, usando localStorage:", error);
        // Se houver erro, usa o localStorage como fallback
        const historicoSalvo = localStorage.getItem('registrosErros');
        if (historicoSalvo) {
          registros = JSON.parse(historicoSalvo);
        }
        mostrarPopupAutomatico('Aviso', 'Dados carregados do cache local.', 'warning');
      }
      
      // Atualiza a interface
      atualizarTabela();
      atualizarResumo();
      atualizarFiltroOperadores();
      
      // Define o m√™s atual como padr√£o no filtro
      const hoje = new Date();
      const mesAtual = hoje.getFullYear() + '-' + String(hoje.getMonth() + 1).padStart(2, '0');
      document.getElementById('filtroData').value = mesAtual;
    }

    // Fun√ß√£o para sincronizar itens locais - ATUALIZADO para usar a nova tabela
    async function sincronizarItensLocais() {
      try {
          const historicoSalvo = localStorage.getItem('registrosErros');
          if (!historicoSalvo) return;
          
          const dadosLocais = JSON.parse(historicoSalvo);
          
          // Verifica quais itens locais n√£o existem no Supabase
          const response = await fetch(`${SUPABASE_URL}/rest/v1/erro-operadorV2?select=id`, {
              headers: {
                  "apikey": SUPABASE_KEY,
                  "Authorization": `Bearer ${SUPABASE_KEY}`
              }
          });
          
          if (!response.ok) {
              throw new Error(`Erro HTTP: ${response.status}`);
          }
          
          const idsSupabase = (await response.json()).map(item => item.id);
          const itensParaSincronizar = dadosLocais.filter(item => !idsSupabase.includes(item.id));
          
          // Tenta enviar cada item n√£o sincronizado
          for (const item of itensParaSincronizar) {
              await fetch(`${SUPABASE_URL}/rest/v1/erro-operadorV2`, {
                  method: "POST",
                  headers: {
                      "Content-Type": "application/json",
                      "apikey": SUPABASE_KEY,
                      "Authorization": `Bearer ${SUPABASE_KEY}`,
                      "Prefer": "return=representation"
                  },
                  body: JSON.stringify(item)
              });
          }
          
          // Recarrega os dados ap√≥s sincroniza√ß√£o
          carregarDados();
          
      } catch (error) {
          console.error("Erro ao sincronizar itens locais:", error);
          mostrarPopupAutomatico('Aten√ß√£o', 'Alguns itens locais n√£o puderam ser sincronizados.', 'warning');
      }
    }

    // Salva dados no localStorage
    function salvarLocal() {
      localStorage.setItem("registrosErros", JSON.stringify(registros));
    }

    // Fun√ß√£o para editar um registro
    function editarRegistro(index) {
      const registro = registros[index];
      
      // Preenche o formul√°rio com os dados do registro
      document.getElementById("operador").value = registro.operador;
      document.getElementById("erro").value = registro.erro;
      document.getElementById("data").value = registro.data;
      document.getElementById("repetido").value = registro.repetido;
      
      // Verifica se a corre√ß√£o √© "Outro"
      if (registro.correcao === "Treinamento aplicado" || 
          registro.correcao === "Advert√™ncia verbal" || 
          registro.correcao === "Refazer tarefa com supervis√£o" || 
          registro.correcao === "Reuni√£o com gestor" || 
          registro.correcao === "Falado via Whatsapp") {
        document.getElementById("correcao").value = registro.correcao;
        document.getElementById("campoOutro").style.display = "none";
      } else {
        document.getElementById("correcao").value = "Outro";
        document.getElementById("campoOutro").value = registro.correcao;
        document.getElementById("campoOutro").style.display = "block";
      }
      
      document.getElementById("obs").value = registro.obs || "";
      document.getElementById("marcaErro").value = registro.marca_erro || "";
      
      // Remove o registro da lista (ser√° readicionado quando salvar)
      registros.splice(index, 1);
      
      // Define que estamos editando
      editandoId = registro.id;
      
      // Rola para o topo do formul√°rio
      window.scrollTo(0, 0);
    }

    // Atualiza a tabela de erros
    function atualizarTabela() {
      const tbody = document.querySelector("#tabelaErros tbody");
      tbody.innerHTML = "";
      
      const listaFiltrada = filtrarListaErros();
      
      if (listaFiltrada.length === 0) {
        tbody.innerHTML = `<tr><td colspan="11" style="text-align: center;">Nenhum registro encontrado</td></tr>`;
        return;
      }
      
      listaFiltrada.forEach((r, index) => {
        tbody.innerHTML += `
          <tr>
            <td>${r.id}</td>
            <td>${r.operador}</td>
            <td>${r.erro}</td>
            <td>${r.marca_erro || "-"}</td>
            <td>${formatarDataBR(r.data)}</td>
            <td>${r.repetido}</td>
            <td>${r.correcao}</td>
            <td>${r.obs || "-"}</td>
            <td>${r.valor_total_descontado.toFixed(2)}</td>
            <td>${r.valor_final_pago.toFixed(2)}</td>
            <td class="no-print">
              <button class="btn-excluir" onclick="excluirRegistro(${r.id})">Excluir</button>
            </td>
          </tr>`;
      });
    }

    // Exclui um registro - ATUALIZADO para usar a nova tabela
    async function excluirRegistro(id) {
      const registro = registros.find(r => r.id === id);
      if (!registro) return;
      
      const confirmar = await mostrarPopupConfirmacao(
        "Confirmar exclus√£o",
        `Deseja realmente excluir este registro do operador <strong>${registro.operador}</strong>?`,
        {
          "Erro": registro.erro,
          "Data": formatarDataBR(registro.data),
          "Valor": `R$ ${registro.valor_final_pago.toFixed(2)}`
        }
      );
      
      if (!confirmar) {
        return;
      }
      
      try {
        // Remove do Supabase (nova tabela)
        const response = await fetch(`${SUPABASE_URL}/rest/v1/erro-operadorV2?id=eq.${id}`, {
          method: "DELETE",
          headers: {
            "apikey": SUPABASE_KEY,
            "Authorization": `Bearer ${SUPABASE_KEY}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        // Remove do array local
        registros = registros.filter(r => r.id !== id);
        salvarLocal();
        atualizarTabela();
        atualizarResumo();
        atualizarFiltroOperadores();
        
        await mostrarPopupInformacao(
          "Registro exclu√≠do",
          "O registro foi removido com sucesso.",
          'success'
        );
      } catch (error) {
        console.error("Erro ao excluir do Supabase:", error);
        await mostrarPopupInformacao(
          "Erro de conex√£o",
          "N√£o foi poss√≠vel excluir o registro do servidor. O registro foi removido apenas localmente.",
          'error'
        );
        
        // Remove apenas localmente em caso de erro
        registros = registros.filter(r => r.id !== id);
        salvarLocal();
        atualizarTabela();
        atualizarResumo();
        atualizarFiltroOperadores();
      }
    }

    // Atualiza o filtro de operadores
    function atualizarFiltroOperadores() {
      const selectFiltro = document.getElementById("filtroOperador");
      const operadoresUnicos = [...new Set(registros.map(r => r.operador))].sort();
      
      // Mant√©m a sele√ß√£o atual
      const valorAtual = selectFiltro.value;
      selectFiltro.innerHTML = `<option value="Todos">TODOS os operadores</option>`;
      
      operadoresUnicos.forEach(op => {
        const opt = document.createElement("option");
        opt.value = op;
        opt.textContent = op;
        selectFiltro.appendChild(opt);
      });
      
      // Restaura a sele√ß√£o se ainda existir
      if (operadoresUnicos.includes(valorAtual)) {
        selectFiltro.value = valorAtual;
      }
    }

    // Limpa todos os registros - ATUALIZADO para usar a nova tabela
    async function limparRegistros() {
      if (registros.length === 0) {
        await mostrarPopupInformacao(
          "Nada para limpar",
          "N√£o h√° registros para serem removidos.",
          'info'
        );
        return;
      }
      
      const confirmar = await mostrarPopupConfirmacao(
        "Confirmar limpeza total",
        "Tem certeza que deseja apagar TODOS os registros? Esta a√ß√£o n√£o pode ser desfeita.",
        {
          "Total de registros": registros.length,
          "Operadores afetados": [...new Set(registros.map(r => r.operador))].length
        }
      );
      
      if (confirmar) {
        try {
          // Remove todos os registros do Supabase (nova tabela)
          const response = await fetch(`${SUPABASE_URL}/rest/v1/erro-operadorV2`, {
            method: "DELETE",
            headers: {
              "apikey": SUPABASE_KEY,
              "Authorization": `Bearer ${SUPABASE_KEY}`
            }
          });
          
          if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
          }
          
          // Limpa localmente
          registros = [];
          localStorage.removeItem("registrosErros");
          atualizarTabela();
          atualizarResumo();
          atualizarFiltroOperadores();
          
          await mostrarPopupInformacao(
            "Limpeza conclu√≠da",
            "Todos os registros foram removidos com sucesso.",
            'success'
          );
        } catch (error) {
          console.error("Erro ao limpar registros no Supabase:", error);
          await mostrarPopupInformacao(
            "Erro de conex√£o",
            "N√£o foi poss√≠vel limpar os registros no servidor. Os registros foram removidos apenas localmente.",
            'error'
          );
          
          // Limpa apenas localmente em caso de erro
          registros = [];
          localStorage.removeItem("registrosErros");
          atualizarTabela();
          atualizarResumo();
          atualizarFiltroOperadores();
        }
      }
    }

    // Limpa os filtros
    function limparFiltros() {
      document.getElementById("filtroOperador").value = "Todos";
      document.getElementById("filtroData").value = "";
      filtrarErros();
    }

    // Filtra os erros conforme os crit√©rios selecionados
    function filtrarErros() {
      atualizarTabela();
      atualizarResumo();
    }

    // Fun√ß√£o para filtrar a lista de erros
    function filtrarListaErros() {
      const filtroOperador = document.getElementById('filtroOperador').value;
      const filtroData = document.getElementById('filtroData').value;
      
      return registros.filter(item => {
        // Filtro por operador
        const operadorMatch = filtroOperador === "Todos" || item.operador === filtroOperador;
        
        // Filtro por m√™s/ano
        let dataMatch = true;
        if (filtroData) {
          const dataItem = new Date(item.data);
          const mesItem = dataItem.getFullYear() + '-' + String(dataItem.getMonth() + 1).padStart(2, '0');
          dataMatch = mesItem === filtroData;
        }

        return operadorMatch && dataMatch;
      });
    }

    // Atualiza o resumo exibido na p√°gina
    function atualizarResumo() {
      const resumoOp = {};
      
      const listaFiltrada = filtrarListaErros();
      
      // Calcula totais por operador
      listaFiltrada.forEach(r => {
        const op = r.operador;
        if (!resumoOp[op]) {
          resumoOp[op] = { 
            totalErros: 0, 
            desconto: 0,
            ids: [] // Array para armazenar todos os IDs
          };
        }
        
        // Conta apenas erros que n√£o s√£o "SEM ERROS"
        if (r.erro !== "SEM ERROS") {
          resumoOp[op].totalErros++;
          resumoOp[op].ids.push(r.id); // Adiciona o ID ao array
          
          // Adiciona desconto se existir na tabela
          if (deducoes[r.erro] !== undefined) {
            resumoOp[op].desconto += deducoes[r.erro];
          }
        }
      });
      
      // Calcula valor final para cada operador
      for (let op in resumoOp) {
        resumoOp[op].valorFinal = Math.max(0, baseValor - resumoOp[op].desconto);
      }
      
      // Monta o HTML do resumo
      let html = "<h4>Resumo por Operador</h4>";
      
      if (Object.keys(resumoOp).length === 0) {
        html += "<p>Nenhum registro para exibir</p>";
      } else {
        html += `<div style="overflow-x: auto;"><table>
          <thead>
            <tr style="background-color: var(--primary); color: white;">
              <th>Operador</th>
              <th>Total de Erros</th>
              <th>IDs dos Erros</th>
              <th>Total Descontado (R$)</th>
              <th>Valor Final (R$)</th>
            </tr>
          </thead>
          <tbody>`;
        
        for (let op in resumoOp) {
          const item = resumoOp[op];
          html += `<tr>
            <td>${op}</td>
            <td>${item.totalErros}</td>
            <td>${item.ids.join(', ')}</td>
            <td>${item.desconto.toFixed(2)}</td>
            <td style="font-weight: bold; color: var(--success);">R$ ${item.valorFinal.toFixed(2)}</td>
          </tr>`;
        }
        
        html += "</tbody></table></div>";
      }
      
      // Se houver filtro por data, acrescenta o resumo dos erros cometidos
      const filtroData = document.getElementById("filtroData").value;
      
      if (filtroData) {
        const resumoErros = {};
        
        listaFiltrada.forEach(r => {
          const erro = r.erro;
          if (erro !== "SEM ERROS") {
            if (!resumoErros[erro]) {
              resumoErros[erro] = 0;
            }
            resumoErros[erro]++;
          }
        });
        
        html += "<h4 style='margin-top:20px;'>Resumo de Erros Cometidos</h4>";
        
        if (Object.keys(resumoErros).length === 0) {
          html += "<p>Nenhum erro registrado no per√≠odo</p>";
        } else {
          html += `<div style="overflow-x: auto;"><table>
            <thead>
              <tr style="background-color: var(--primary); color: white;">
                <th>Erro</th>
                <th>Quantidade</th>
                <th>Valor (R$)</th>
              </tr>
            </thead>
            <tbody>`;
          
          for (let erro in resumoErros) {
            const valor = deducoes[erro] || 0;
            html += `<tr>
              <td>${erro}</td>
              <td>${resumoErros[erro]}</td>
              <td>${valor.toFixed(2)}</td>
            </tr>`;
          }
          
          html += "</tbody></table></div>";
        }
      }
      
      document.getElementById("resumoConteudo").innerHTML = html;
    }

    // Exporta PDF com filtro aplicado (somente tabela de erros)
    async function exportarPDFFiltro() {
      const listaFiltrada = filtrarListaErros();
      
      if (listaFiltrada.length === 0) {
        await mostrarPopupInformacao(
          "Nada para exportar",
          "N√£o h√° registros para exportar com os filtros atuais.",
          'info'
        );
        return;
      }
      
      const titulo = document.getElementById("filtroOperador").value !== "Todos" ? 
        `Relat√≥rio de Erros - ${document.getElementById("filtroOperador").value}` : 
        "Relat√≥rio de Erros (Filtrado)";
      
      gerarPDF(listaFiltrada, titulo, false); // false indica para n√£o incluir o resumo
    }

    // Exporta PDF completo (com tabela e resumo)
    async function exportarPDFCompleto() {
      if (registros.length === 0) {
        await mostrarPopupInformacao(
          "Nada para exportar",
          "N√£o h√° registros para exportar.",
          'info'
        );
        return;
      }
      gerarPDF(registros, "Relat√≥rio de Erros (Completo)", true); // true inclui o resumo
    }

    // Gera o PDF (modificada para aceitar par√¢metro incluirResumo)
    function gerarPDF(dados, titulo, incluirResumo = true) {
      const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'mm'
      });
      
      // Configura√ß√µes do documento
      doc.setProperties({
        title: titulo,
        subject: 'Relat√≥rio de Erros Operacionais',
        author: 'AFT Qu√≠mica',
        keywords: 'erros, operadores, relat√≥rio',
        creator: 'Sistema de Controle de Erros'
      });
      
      // Cabe√ßalho
      doc.setFontSize(16);
      doc.setTextColor(46, 134, 193);
      doc.setFont("helvetica", "bold");
      doc.text(titulo, doc.internal.pageSize.width / 2, 15, { align: 'center' });
      
      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      doc.setFont("helvetica", "normal");
      doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, doc.internal.pageSize.width / 2, 22, { align: 'center' });
      doc.text(`Total de registros: ${dados.length}`, doc.internal.pageSize.width / 2, 27, { align: 'center' });
      
      // Tabela de registros
      const headers = [["ID", "Operador", "Erro", "Marca Erro", "Data", "Repetido", "Corre√ß√£o", "Observa√ß√µes", "Desconto (R$)", "Valor Final (R$)"]];
      
      const dataTabela = dados.map(r => {
        return [
          r.id.toString(),
          r.operador,
          r.erro,
          r.marca_erro || "-",
          formatarDataBR(r.data),
          r.repetido,
          r.correcao,
          r.obs || "-",
          r.valor_total_descontado.toFixed(2),
          r.valor_final_pago.toFixed(2)
        ];
      });
      
      doc.autoTable({
        head: headers,
        body: dataTabela,
        startY: 35,
        theme: "grid",
        headStyles: { 
          fillColor: [46, 134, 193],
          textColor: 255,
          fontStyle: 'bold'
        },
        alternateRowStyles: {
          fillColor: [240, 240, 240]
        },
        margin: { top: 35 },
        styles: {
          fontSize: 8,
          cellPadding: 3,
          overflow: 'linebreak'
        },
        columnStyles: {
          0: { cellWidth: 15 },
          1: { cellWidth: 25 },
          2: { cellWidth: 40 },
          3: { cellWidth: 25 },
          4: { cellWidth: 15 },
          5: { cellWidth: 15 },
          6: { cellWidth: 30 },
          7: { cellWidth: 40 },
          8: { cellWidth: 20, halign: 'right' },
          9: { cellWidth: 20, halign: 'right' }
        }
      });
      
      // Apenas adiciona o resumo se incluirResumo for true
      if (incluirResumo) {
        const resumoObj = gerarResumoPDF(dados);
        
        // Adiciona p√°gina com resumo por operador
        if (Object.keys(resumoObj.operadores).length > 0) {
          doc.addPage('landscape');
          
          // T√≠tulo do resumo
          doc.setFontSize(14);
          doc.setTextColor(46, 134, 193);
          doc.setFont("helvetica", "bold");
          doc.text("Resumo por Operador", 15, 15);
          
          // Tabela de resumo por operador
          const resumoHeaders = [["Operador", "Total de Erros", "IDs dos Erros", "Total Descontado (R$)", "Valor Final (R$)"]];
          const resumoData = [];
          
          for (let op in resumoObj.operadores) {
            const item = resumoObj.operadores[op];
            resumoData.push([
              op,
              item.totalErros.toString(),
              item.ids.join(', '),
              item.desconto.toFixed(2),
              item.valorFinal.toFixed(2)
            ]);
          }
          
          doc.autoTable({
            head: resumoHeaders,
            body: resumoData,
            startY: 25,
            theme: "grid",
            headStyles: { 
              fillColor: [46, 134, 193],
              textColor: 255,
              fontStyle: 'bold'
            },
            columnStyles: {
              3: { halign: 'right' },
              4: { halign: 'right' }
            },
            styles: {
              fontSize: 10,
              cellPadding: 3
            }
          });
        }
      }
      
      // Salva o PDF
      doc.save(`${titulo.replace(/[^a-z0-9]/gi, '_')}.pdf`);
    }

    // Gera os dados resumo para o PDF
    function gerarResumoPDF(dados) {
      const operadores = {};
      const erros = {};
      
      dados.forEach(r => {
        const op = r.operador;
        
        if (!operadores[op]) { 
          operadores[op] = { 
            totalErros: 0, 
            desconto: 0,
            ids: [] // Adiciona array para armazenar IDs
          }; 
        }
        
        // Conta apenas erros que n√£o s√£o "SEM ERROS"
        if (r.erro !== "SEM ERROS") {
          operadores[op].totalErros++;
          operadores[op].ids.push(r.id); // Adiciona ID ao array
          
          // Adiciona desconto se existir na tabela
          if (deducoes[r.erro] !== undefined) {
            operadores[op].desconto += deducoes[r.erro];
          }
        }
        
        // Contagem de erros para o resumo
        if (!erros[r.erro]) { 
          erros[r.erro] = 0; 
        }
        erros[r.erro]++;
      });
      
      // Calcula valor final para cada operador
      for (let op in operadores) {
        operadores[op].valorFinal = Math.max(0, baseValor - operadores[op].desconto);
      }
      
      return { operadores, erros };
    }

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
      // Configura eventos de filtro
      document.getElementById('filtroOperador').addEventListener('change', filtrarErros);
      document.getElementById('filtroData').addEventListener('change', filtrarErros);
      
      // Configura o evento para mostrar/ocultar campo "Outro"
      document.getElementById("correcao").addEventListener("change", function() {
        document.getElementById("campoOutro").style.display = this.value === "Outro" ? "block" : "none";
        if (this.value !== "Outro") {
          document.getElementById("campoOutro").value = "";
        }
      });
      
      // Define a data atual como padr√£o
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('data').value = hoje;
      
      // Carrega os dados salvos
      carregarDados();
    });
  </script>
</body>
</html>
