<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Erros - AFT Qu√≠mica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    :root {
      --primary: #2E86C1;
      --danger: #E74C3C;
      --success: #28B463;
      --gray: #F2F2F2;
      --warning: #F39C12;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 15px;
      min-width: 320px;
    }
    h1, h2, h3 {
      text-align: center;
      color: #2E86C1;
      margin-top: 0;
    }
    h1 {
      font-size: 1.8rem;
    }
    h2 {
      font-size: 1.5rem;
    }
    h3 {
      font-size: 1.3rem;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      width: 100%;
    }
    .card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 10px;
    }
    .form-col {
      flex: 1;
      min-width: 200px;
    }
    label {
      font-weight: bold;
      margin-bottom: 6px;
      display: block;
      font-size: 0.9rem;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.9rem;
      white-space: nowrap;
      flex: 1;
      min-width: 120px;
      text-align: center;
      transition: all 0.2s;
    }
    .btn-primary { background-color: var(--primary); }
    .btn-danger { background-color: var(--danger); }
    .btn-success { background-color: var(--success); }
    .btn-gray { background-color: #888; }
    .btn-secondary { background-color: #5A5A5A; }
    .btn-warning { background-color: var(--warning); }
    .btn:hover { opacity: 0.9; transform: scale(1.02); }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      font-size: 0.85rem;
    }
    th {
      background-color: var(--primary);
      color: white;
      padding: 10px;
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: 0.9rem;
    }
    td { 
      padding: 8px; 
      border-bottom: 1px solid #ddd; 
      text-align: center;
    }
    #campoOutro { 
      display: none;
      margin-top: 10px;
    }
    #resumo {
      margin-top: 15px;
      padding: 10px;
      background: #eef;
      border-radius: 8px;
      overflow-x: auto;
    }
    #resumo table {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
      margin-top: 10px;
      border: 1px solid #ccc;
    }
    #resumo th, #resumo td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
      font-size: 0.85rem;
    }
    .btn-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      width: 100%;
    }
    .btn-excluir {
      background-color: #E74C3C;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
      margin: 2px;
    }
    .btn-editar {
      background-color: #2E86C1;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
      margin: 2px;
    }
    .btn-excluir:hover, .btn-editar:hover {
      opacity: 0.8;
      transform: scale(1.05);
    }
    #tabelaErros th:nth-child(9), 
    #tabelaErros td:nth-child(9),
    #tabelaErros th:nth-child(10), 
    #tabelaErros td:nth-child(10) {
      text-align: right;
      padding-right: 15px;
    }
    .alert-duplicata {
      background-color: #F39C12;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      display: none;
      text-align: center;
      font-weight: bold;
    }
    tr.editando {
      background-color: rgba(46, 134, 193, 0.1) !important;
    }
    @media (max-width: 768px) {
      .form-col {
        min-width: 100%;
      }
      table {
        font-size: 0.8rem;
      }
      th, td {
        padding: 6px 4px;
      }
      #tabelaErros th:nth-child(4), 
      #tabelaErros td:nth-child(4),
      #tabelaErros th:nth-child(8),
      #tabelaErros td:nth-child(8),
      #tabelaErros th:nth-child(9),
      #tabelaErros td:nth-child(9),
      #tabelaErros th:nth-child(10),
      #tabelaErros td:nth-child(10) {
        display: none;
      }
      .btn {
        padding: 10px 8px;
        font-size: 0.8rem;
        min-width: 100px;
      }
    }
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }
      .card {
        padding: 10px;
      }
      h1 {
        font-size: 1.5rem;
      }
      h2 {
        font-size: 1.3rem;
      }
      #tabelaErros th:nth-child(1),
      #tabelaErros td:nth-child(1),
      #tabelaErros th:nth-child(6),
      #tabelaErros td:nth-child(6) {
        display: none;
      }
      #resumo table {
        font-size: 0.75rem;
      }
      .btn-row {
        gap: 5px;
      }
      .btn {
        min-width: 80px;
        font-size: 0.75rem;
        padding: 8px 5px;
      }
    }
    @media (max-width: 768px) {
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
    }
  </style>
</head>
<body>
<div class="container">

<h1 style="color: #38a738c9;">CONTROLE DE ERROS</h1>

<div class="card">
  <div id="alertDuplicata" class="alert-duplicata">
    ATEN√á√ÉO: J√° existe um registro com este operador, erro e data. Isso pode gerar uma duplicata!
  </div>
  <div class="form-row">
    <div class="form-col">
      <label>üë∑ Operador:</label>
      <select id="operador" required>
        <option value="">Selecione um operador</option>
        <option value="Caio Jos√©">Caio Jos√©</option>
        <option value="Daniel Rodrigo">Daniel Rodrigo</option>
        <option value="Igor Nascimento">Igor Nascimento</option>
        <option value="Lissandro da Silva">Lissandro da Silva</option>
        <option value="Patrick Darlan">Patrick Darlan</option>
        <option value="Ricardo Alves">Ricardo Alves</option>
        <option value="Keniel vasque">Keniel vasque</option>
      </select>
    </div>
    <div class="form-col">
      <label>‚ùå Erro:</label>
      <select id="erro" required>
        <option value="SEM ERROS">SEM ERROS</option>
        <option value="N√£o avisou o atraso com 30 min. De anteced√™ncia">N√£o avisou o atraso com 30 min. De anteced√™ncia</option>
        <option value="Chegou atrasado na empresa">Chegou atrasado na empresa</option>
        <option value="N√£o usou o produto certo no servi√ßo">N√£o usou o produto certo no servi√ßo</option>
        <option value="N√£o tirou a foto do antes e depois">N√£o tirou a foto do antes e depois</option>
        <option value="N√£o tirou a foto da tampa da caixa">N√£o tirou a foto da tampa da caixa</option>
        <option value="N√£o abriu e fechou a os no hor√°rio certo">N√£o abriu e fechou a os no hor√°rio certo</option>
        <option value="Lan√ßo errado a quantidade de produto no sistema">Lan√ßo errado a quantidade de produto no sistema</option>
        <option value="N√£o lan√ßou o produto no sistema">N√£o lan√ßou o produto no sistema</option>
        <option value="Teve retrabalho de Expugos">Teve retrabalho de Expugos</option>
        <option value="Teve retrabalho de Limpezas">Teve retrabalho de Limpezas</option>
        <option value="Teve retrabalho de dedetiza√ß√£o ou desratiza√ß√£o">Teve retrabalho de dedetiza√ß√£o ou desratiza√ß√£o</option>
        <option value="Teve reclama√ß√£o do cliente">Teve reclama√ß√£o do cliente</option>
        <option value="N√£o est√° uniformizado">N√£o est√° uniformizado</option>
        <option value="N√£o usa EPI adequadamente">N√£o usa EPI adequadamente</option>
        <option value="N√£o cobrou ou n√£o colocou o comprovante de pg no grupo">N√£o cobrou ou n√£o colocou o comprovante de pg no grupo</option>
        <option value="N√£o registrou corretamente a n√£o conformidade">N√£o registrou corretamente a n√£o conformidade</option>
        <option value="N√£o registro na planilha os parametros da piscina">N√£o registro na planilha os parametros da piscina</option>
        <option value="N√£o registrou corretamente o carro no app">N√£o registrou corretamente o carro no app</option>
        <option value="N√£o coletou assinatura no app">N√£o coletou assinatura no app</option>
        <option value="Lan√ßou produto errado">Lan√ßou produto errado</option>
      </select>
    </div>
    <div class="form-col">
      <label>üìÖ Data:</label>
      <input type="date" id="data" required>
    </div>
    <div class="form-col">
      <label>üîÅ Repetido:</label>
      <select id="repetido">
        <option value="N√£o">N√£o</option>
        <option value="Sim">Sim</option>
      </select>
    </div>
  </div>
  <div class="form-row">
    <div class="form-col">
      <label>üè∑Ô∏è Marca de Erro Espec√≠fico:</label>
      <input type="text" id="marcaErro" placeholder="Informe uma marca√ß√£o espec√≠fica (opcional)">
    </div>
  </div>
  <div class="form-row">
    <div class="form-col">
      <label>‚úîÔ∏è Corre√ß√£o:</label>
      <select id="correcao" required>
        <option value="">Selecione uma corre√ß√£o</option>
        <option value="Treinamento aplicado">Treinamento aplicado</option>
        <option value="Advert√™ncia verbal">Advert√™ncia verbal</option>
        <option value="Refazer tarefa com supervis√£o">Refazer tarefa com supervis√£o</option>
        <option value="Reuni√£o com gestor">Reuni√£o com gestor</option>
        <option value="Falado via Whatsapp">Falado via Whatsapp</option>
        <option value="Outro">Outro</option>
      </select>
      <input type="text" id="campoOutro" placeholder="Descreva a corre√ß√£o personalizada">
    </div>
    <div class="form-col">
      <label>üìù Observa√ß√µes:</label>
      <textarea id="obs" rows="3" placeholder="Adicione observa√ß√µes relevantes (opcional)"></textarea>
    </div>
  </div>
  <div class="btn-row">
    <button id="btnAdicionar" class="btn btn-success" onclick="adicionarErro()">‚ûï Adicionar</button>
    <button id="btnAtualizar" class="btn btn-warning" onclick="atualizarErro()" style="display: none;">üîÑ Atualizar</button>
    <button id="btnCancelar" class="btn btn-gray" onclick="cancelarEdicao()" style="display: none;">‚ùå Cancelar</button>
    <button class="btn btn-primary" onclick="exportarPDFFiltro()">üìÑ PDF (Filtro)</button>
    <button class="btn btn-secondary" onclick="exportarPDFCompleto()">üì§ PDF (Completo)</button>
    <button class="btn btn-danger" onclick="confirmarLimpeza()">üßπ Limpar Tudo</button>
  </div>
</div>

<div class="card">
  <h3>üîç Filtros</h3>
  <div class="form-row">
    <div class="form-col">
      <label>Operador:</label>
      <select id="filtroOperador">
        <option value="Todos">TODOS os operadores</option>
      </select>
    </div>
    <div class="form-col">
      <label>Data In√≠cio:</label>
      <input type="date" id="filtroDataInicio">
    </div>
    <div class="form-col">
      <label>Data Fim:</label>
      <input type="date" id="filtroDataFim">
    </div>
  </div>
  <div class="btn-row">
    <button class="btn btn-primary" onclick="filtrarErros()">Aplicar Filtros</button>
    <button class="btn btn-gray" onclick="limparDataFiltros()">Limpar Datas</button>
  </div>
</div>

<div style="overflow-x: auto;">
  <table id="tabelaErros">
    <thead>
      <tr>
        <th>ID</th>
        <th>Operador</th>
        <th>Erro</th>
        <th>Marca Erro</th>
        <th>Data</th>
        <th>Repetido</th>
        <th>Corre√ß√£o</th>
        <th>Observa√ß√µes</th>
        <th>Total Descontado (R$)</th>
        <th>Valor Final (R$)</th>
        <th class="no-print">A√ß√µes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="resumo" class="card">
  <h3>üìà Resumo dos Valores</h3>
  <div id="resumoConteudo"></div>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // Declara√ß√£o de vari√°veis globais
  let registros = [];
  let registroEditando = null;
  const { jsPDF } = window.jspdf;
  const Swal = window.Swal;
  
  // Configura√ß√µes do Supabase
  const SUPABASE_URL = "https://nsfliimhsokyzhacnfdg.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zZmxpaW1oc29reXpoYWNuZmRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDczNDg3MzQsImV4cCI6MjA2MjkyNDczNH0.QqosDhPG2xK16rAfitDiW837GMIL_dh5lmDwg8cOn_8";
  
  // Tabela de dedu√ß√µes (valores em reais)
  const deducoes = {
    "N√£o avisou o atraso com 30 min. De anteced√™ncia": 25,
    "Chegou atrasado na empresa": 25,
    "N√£o usou o produto certo no servi√ßo": 50,
    "N√£o tirou a foto do antes e depois": 25,
    "N√£o tirou a foto da tampa da caixa": 25,
    "N√£o abriu e fechou a os no hor√°rio certo": 25,
    "Lan√ßo errado a quantidade de produto no sistema": 25,
    "N√£o lan√ßou o produto no sistema": 50,
    "Teve retrabalho de Expugos": 100,
    "Teve retrabalho de Limpezas": 50,
    "Teve retrabalho de dedetiza√ß√£o ou desratiza√ß√£o": 50,
    "Teve reclama√ß√£o do cliente": 50,
    "N√£o est√° uniformizado": 25,
    "N√£o usa EPI adequadamente": 50,
    "N√£o cobrou ou n√£o colocou o comprovante de pg no grupo": 25,
    "N√£o registrou corretamente a n√£o conformidade": 25,
    "N√£o registro na planilha os parametros da piscina": 25,
    "N√£o registrou corretamente o carro no app": 25,
    "N√£o coletou assinatura no app": 25,
    "Lan√ßou produto errado": 25
  };

  // Valor base para c√°lculo
  const baseValor = 500;

  // Ao carregar a p√°gina
  window.onload = async function() {
    // Define a data atual como padr√£o
    const hoje = new Date().toISOString().split('T')[0];
    document.getElementById('data').value = hoje;
    document.getElementById('filtroDataInicio').value = hoje;
    document.getElementById('filtroDataFim').value = hoje;
    
    // Carrega os dados do Supabase (com fallback para localStorage)
    await carregarDados();
    
    // Configura o evento para mostrar/ocultar campo "Outro"
    document.getElementById("correcao").addEventListener("change", function() {
      document.getElementById("campoOutro").style.display = this.value === "Outro" ? "block" : "none";
      if (this.value !== "Outro") {
        document.getElementById("campoOutro").value = "";
      }
    });
    
    // Adiciona eventos para verificar duplicatas em tempo real
    document.getElementById("operador").addEventListener("change", verificarDuplicata);
    document.getElementById("erro").addEventListener("change", verificarDuplicata);
    document.getElementById("data").addEventListener("change", verificarDuplicata);
  };

  // Verifica se j√° existe um registro com os mesmos dados
  function verificarDuplicata() {
    const operador = document.getElementById("operador").value;
    const erro = document.getElementById("erro").value;
    const data = document.getElementById("data").value;
    
    if (!operador || !erro || !data) return;
    
    // Verifica se existe um registro com os mesmos dados (exceto o que est√° sendo editado)
    const duplicata = registros.find(r => 
      r.operador === operador && 
      r.erro === erro && 
      r.data === data &&
      (!registroEditando || r.id != registroEditando.id)
    );
    
    const alertDuplicata = document.getElementById("alertDuplicata");
    if (duplicata) {
      alertDuplicata.style.display = "block";
    } else {
      alertDuplicata.style.display = "none";
    }
  }

  // Carrega dados do Supabase com fallback para localStorage
  async function carregarDados() {
    try {
      // Tenta carregar do Supabase
      const response = await fetch(`${SUPABASE_URL}/rest/v1/erros?select=*`, {
        headers: {
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`Erro HTTP: ${response.status}`);
      }
      
      const dadosSupabase = await response.json();
      
      // Verifica se h√° dados no Supabase
      if (dadosSupabase && dadosSupabase.length > 0) {
        registros = dadosSupabase.map(item => ({
          id: item.id,
          operador: item.operador,
          erro: item.erro,
          data: item.data,
          repetido: item.repetido,
          correcao: item.correcao,
          obs: item.obs || "",
          marcaErro: item.marca_erro || "",
          valor_total_descontado: item.valor_total_descontado || 0,
          valor_final_pago: item.valor_final_pago || baseValor
        }));
        
        // Salva no localStorage como backup
        salvarLocal();
      } else {
        // Se n√£o houver dados no Supabase, tenta carregar do localStorage
        carregarLocal();
      }
    } catch (error) {
      console.error("Erro ao carregar do Supabase, usando localStorage:", error);
      // Se houver erro, usa o localStorage como fallback
      carregarLocal();
    }
    
    // Atualiza a interface
    atualizarTabela(registros);
    atualizarResumo(registros);
    atualizarFiltroOperadores();
  }

  // Carrega dados do localStorage
  function carregarLocal() {
    const dadosLocais = localStorage.getItem("registrosErros");
    if (dadosLocais) {
      registros = JSON.parse(dadosLocais);
    }
  }

  // Salva dados no localStorage
  function salvarLocal() {
    localStorage.setItem("registrosErros", JSON.stringify(registros));
  }

  // Prepara o formul√°rio para edi√ß√£o
  function editarRegistro(id) {
    const registro = registros.find(r => r.id == id);
    if (!registro) {
      Swal.fire('Erro', 'Registro n√£o encontrado.', 'error');
      return;
    }
    
    registroEditando = { ...registro, index: registros.findIndex(r => r.id == id) };
    
    // Preenche o formul√°rio
    document.getElementById("operador").value = registro.operador;
    document.getElementById("erro").value = registro.erro;
    document.getElementById("data").value = registro.data;
    document.getElementById("repetido").value = registro.repetido;
    document.getElementById("marcaErro").value = registro.marcaErro || "";
    document.getElementById("obs").value = registro.obs || "";

    // Trata o campo de corre√ß√£o
    const correcao = registro.correcao;
    const selectCorrecao = document.getElementById("correcao");
    let opcaoEncontrada = false;
    
    // Verifica se a corre√ß√£o est√° nas op√ß√µes padr√£o
    for (let i = 0; i < selectCorrecao.options.length; i++) {
      if (selectCorrecao.options[i].value === correcao) {
        selectCorrecao.value = correcao;
        opcaoEncontrada = true;
        break;
      }
    }
    
    // Se n√£o encontrou, usa a op√ß√£o "Outro"
    if (!opcaoEncontrada) {
      selectCorrecao.value = "Outro";
      document.getElementById("campoOutro").value = correcao;
      document.getElementById("campoOutro").style.display = "block";
    } else {
      document.getElementById("campoOutro").style.display = "none";
    }
    
    // Mostra bot√µes de edi√ß√£o
    document.getElementById("btnAdicionar").style.display = "none";
    document.getElementById("btnAtualizar").style.display = "inline-block";
    document.getElementById("btnCancelar").style.display = "inline-block";
    
    // Destaca a linha na tabela
    const linhas = document.querySelectorAll("#tabelaErros tbody tr");
    linhas.forEach(linha => {
      if (linha.cells[0].textContent == id) {
        linha.classList.add('editando');
      } else {
        linha.classList.remove('editando');
      }
    });
    
    // Verifica duplicatas e rola para o topo
    verificarDuplicata();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Cancela a edi√ß√£o
  function cancelarEdicao() {
    registroEditando = null;
    limparFormulario();
    
    // Restaura os bot√µes
    document.getElementById("btnAdicionar").style.display = "inline-block";
    document.getElementById("btnAtualizar").style.display = "none";
    document.getElementById("btnCancelar").style.display = "none";
    
    // Remove destaque da tabela
    const linhas = document.querySelectorAll("#tabelaErros tbody tr");
    linhas.forEach(linha => {
      linha.classList.remove('editando');
    });
    
    // Oculta alerta de duplicata
    document.getElementById("alertDuplicata").style.display = "none";
  }

  // Limpa o formul√°rio
  function limparFormulario() {
    document.getElementById("operador").value = "";
    document.getElementById("erro").value = "SEM ERROS";
    document.getElementById("data").value = new Date().toISOString().split('T')[0];
    document.getElementById("repetido").value = "N√£o";
    document.getElementById("correcao").value = "";
    document.getElementById("campoOutro").value = "";
    document.getElementById("campoOutro").style.display = "none";
    document.getElementById("obs").value = "";
    document.getElementById("marcaErro").value = "";
  }

  // Atualiza um erro existente
  async function atualizarErro() {
    if (!registroEditando) {
      Swal.fire('Erro', 'Nenhum registro em edi√ß√£o.', 'error');
      return;
    }
    
    // Obt√©m valores dos campos
    const operador = document.getElementById("operador").value;
    const erro = document.getElementById("erro").value;
    const data = document.getElementById("data").value;
    const repetido = document.getElementById("repetido").value;
    let correcao = document.getElementById("correcao").value;
    const obs = document.getElementById("obs").value.trim();
    const marcaErro = document.getElementById("marcaErro").value.trim();
    
    // Trata campo "Outro"
    if (correcao === "Outro") {
      correcao = document.getElementById("campoOutro").value.trim();
      if (!correcao) {
        Swal.fire('Aten√ß√£o', 'Descreva a corre√ß√£o personalizada.', 'warning');
        return;
      }
    }
    
    // Valida√ß√£o
    if (!operador || !erro || !data || !correcao) {
      Swal.fire('Aten√ß√£o', 'Preencha todos os campos obrigat√≥rios.', 'warning');
      return;
    }
    
    // Verifica duplicatas (ignorando o registro atual)
    const duplicata = registros.find(r => 
      r.operador === operador && 
      r.erro === erro && 
      r.data === data &&
      r.id != registroEditando.id
    );
    
    if (duplicata) {
      const confirmar = await Swal.fire({
        title: 'Poss√≠vel duplicata!',
        text: 'J√° existe um registro similar. Continuar?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, atualizar',
        cancelButtonText: 'Cancelar'
      });
      if (!confirmar.isConfirmed) return;
    }
    
    // Calcula valores
    const valorDescontado = erro !== "SEM ERROS" ? (deducoes[erro] || 0) : 0;
    const valorFinal = baseValor - valorDescontado;
    
    // Cria objeto atualizado
    const registroAtualizado = { 
      ...registroEditando,
      operador, 
      erro, 
      data, 
      repetido, 
      correcao, 
      obs, 
      marcaErro,
      valor_total_descontado: valorDescontado,
      valor_final_pago: valorFinal
    };
    
    try {
      // Atualiza no Supabase
      const response = await fetch(`${SUPABASE_URL}/rest/v1/erros?id=eq.${registroEditando.id}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`
        },
        body: JSON.stringify({
          operador: operador,
          erro: erro,
          data: data,
          repetido: repetido,
          correcao: correcao,
          obs: obs || null,
          marca_erro: marcaErro || null,
          valor_total_descontado: valorDescontado,
          valor_final_pago: valorFinal
        })
      });
      
      if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
      
      // Atualiza localmente
      registros[registroEditando.index] = registroAtualizado;
      salvarLocal();
      
      // Atualiza interface
      atualizarTabela();
      atualizarResumo();
      atualizarFiltroOperadores();
      
      Swal.fire('Sucesso', 'Registro atualizado!', 'success');
      cancelarEdicao();
      
    } catch (error) {
      console.error("Erro ao atualizar:", error);
      Swal.fire('Erro', 'Falha na atualiza√ß√£o. Tente novamente.', 'error');
    }
  }

  // Adiciona um novo erro
  async function adicionarErro() {
    // Obt√©m os valores dos campos
    const operador = document.getElementById("operador").value;
    const erro = document.getElementById("erro").value;
    const data = document.getElementById("data").value;
    const repetido = document.getElementById("repetido").value;
    let correcao = document.getElementById("correcao").value;
    const obs = document.getElementById("obs").value.trim();
    const marcaErro = document.getElementById("marcaErro").value.trim();
    
    // Trata o campo "Outro" se selecionado
    if (correcao === "Outro") {
      const campoOutro = document.getElementById("campoOutro").value.trim();
      if (!campoOutro) {
        Swal.fire('Aten√ß√£o', 'Por favor, descreva a corre√ß√£o personalizada.', 'warning');
        return;
      }
      correcao = campoOutro;
    }
    
    // Valida√ß√£o dos campos obrigat√≥rios
    if (!operador || !erro || !data || !correcao) {
      Swal.fire('Aten√ß√£o', 'Preencha todos os campos obrigat√≥rios.', 'warning');
      return;
    }
    
    // Verifica duplicatas
    const duplicata = registros.find(r => 
      r.operador === operador && 
      r.erro === erro && 
      r.data === data
    );
    
    if (duplicata) {
      const confirmar = await Swal.fire({
        title: 'Poss√≠vel duplicata!',
        text: 'J√° existe um registro com este operador, erro e data. Deseja continuar mesmo assim?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sim, adicionar',
        cancelButtonText: 'Cancelar'
      });
      
      if (!confirmar.isConfirmed) {
        return;
      }
    }
    
    // Calcula os valores monet√°rios
    const valorDescontado = erro !== "SEM ERROS" ? (deducoes[erro] || 0) : 0;
    const valorFinal = baseValor - valorDescontado;
    
    // Cria o objeto do erro
    const novoErro = { 
      operador: operador, 
      erro: erro, 
      data: data, 
      repetido: repetido, 
      correcao: correcao, 
      obs: obs, 
      marcaErro: marcaErro,
      valor_total_descontado: valorDescontado,
      valor_final_pago: valorFinal
    };
    
    try {
      // Tenta salvar no Supabase primeiro
      const respostaSupabase = await salvarNoSupabase(novoErro);
      
      // Verifica se foi salvo com sucesso no Supabase
      if (respostaSupabase && respostaSupabase[0] && respostaSupabase[0].id) {
        // Adiciona o ID retornado pelo Supabase
        novoErro.id = respostaSupabase[0].id;
        
        // Adiciona ao array local
        registros.push(novoErro);
        
        // Salva no localStorage como backup
        salvarLocal();
        
        // Atualiza a interface
        atualizarTabela(registros);
        atualizarResumo(registros);
        atualizarFiltroOperadores();
        
        // Limpa o formul√°rio (exceto a data)
        limparFormulario();
        
        // Feedback ao usu√°rio
        Swal.fire('Sucesso', 'Erro registrado com sucesso!', 'success');
        
        // Foca no operador para novo cadastro
        document.getElementById("operador").focus();
      } else {
        throw new Error("N√£o foi poss√≠vel salvar no Supabase");
      }
    } catch (error) {
      console.error("Erro ao salvar no Supabase:", error);
      Swal.fire('Erro', 'N√£o foi poss√≠vel salvar o registro. Tente novamente.', 'error');
    }
  }

  // Atualiza a tabela de erros
  function atualizarTabela(lista = registros) {
    const tbody = document.querySelector("#tabelaErros tbody");
    tbody.innerHTML = "";
    if (lista.length === 0) {
      tbody.innerHTML = `<tr><td colspan="11" style="text-align: center;">Nenhum registro encontrado</td></tr>`;
      return;
    }

    lista.forEach((r) => {
      tbody.innerHTML += `
        <tr>
          <td>${r.id}</td>
          <td>${r.operador}</td>
          <td>${r.erro}</td>
          <td>${r.marcaErro || "-"}</td>
          <td>${formatarDataBR(r.data)}</td>
          <td>${r.repetido}</td>
          <td>${r.correcao}</td>
          <td>${r.obs || "-"}</td>
          <td>${r.valor_total_descontado.toFixed(2)}</td>
          <td>${r.valor_final_pago.toFixed(2)}</td>
          <td class="no-print">
            <button class="btn-editar" onclick="editarRegistro(${r.id})">Editar</button>
            <button class="btn-excluir" onclick="confirmarExclusao(${r.id})">Excluir</button>
          </td>
        </tr>`;
    });
  }

  // Fun√ß√£o para confirmar exclus√£o de um registro
  function confirmarExclusao(id) {
    Swal.fire({
      title: 'Tem certeza?',
      text: "Voc√™ n√£o poder√° reverter esta a√ß√£o!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Sim, excluir!',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        excluirRegistro(id);
      }
    });
  }

  // Fun√ß√£o para excluir um registro
  async function excluirRegistro(id) {
    try {
      // Encontra a linha correspondente na tabela
      const linhas = document.querySelectorAll("#tabelaErros tbody tr");
      let linhaParaRemover = null;
      
      linhas.forEach(linha => {
        if (linha.cells[0].textContent == id) {
          linhaParaRemover = linha;
          linha.classList.add('removing');
        }
      });
      
      // Tenta excluir do Supabase
      const response = await fetch(`${SUPABASE_URL}/rest/v1/erros?id=eq.${id}`, {
        method: "DELETE",
        headers: {
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`Falha ao excluir: ${response.status}`);
      }
      
      // Remove do array local
      registros = registros.filter(r => r.id != id);
      
      // Salva no localStorage
      salvarLocal();
      
      // Remove a linha ap√≥s um pequeno delay para a anima√ß√£o
      setTimeout(() => {
        if (linhaParaRemover) {
          linhaParaRemover.remove();
        }
        
        // Atualiza resumo e filtros
        atualizarResumo(registros);
        atualizarFiltroOperadores();
        
        // Se estava editando o registro exclu√≠do, cancela a edi√ß√£o
        if (registroEditando && registroEditando.id == id) {
          cancelarEdicao();
        }
        
        // Feedback ao usu√°rio
        Swal.fire('Exclu√≠do!', 'O registro foi removido com sucesso.', 'success');
      }, 300);
      
    } catch (error) {
      console.error("Erro na exclus√£o:", error);
      
      // Remove a classe de anima√ß√£o em caso de erro
      const linhas = document.querySelectorAll("#tabelaErros tbody tr");
      linhas.forEach(linha => {
        if (linha.cells[0].textContent == id) {
          linha.classList.remove('removing');
        }
      });
      
      Swal.fire('Erro!', 'N√£o foi poss√≠vel excluir o registro.', 'error');
    }
  }

  // Fun√ß√£o para confirmar limpeza de todos os registros
  function confirmarLimpeza() {
    Swal.fire({
      title: 'Tem certeza absoluta?',
      text: "Isso apagar√° TODOS os registros permanentemente!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Sim, limpar tudo!',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        limparRegistros();
      }
    });
  }

  // Fun√ß√£o para limpar todos os registros
  async function limparRegistros() {
    try {
      // Feedback visual
      document.querySelector("#tabelaErros tbody").innerHTML =
        `<tr><td colspan="11" style="text-align: center; opacity: 0.5;">Limpando registros...</td></tr>`;
      
      // Exclui tudo do Supabase
      const response = await fetch(`${SUPABASE_URL}/rest/v1/erros`, {
        method: "DELETE",
        headers: {
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`Erro ao limpar: ${response.status}`);
      }
      
      // Limpa dados locais
      registros = [];
      localStorage.removeItem("registrosErros");
      
      // Atualiza a interface
      atualizarTabela(registros);
      atualizarResumo(registros);
      atualizarFiltroOperadores();
      cancelarEdicao(); // Se estava editando, cancela
      
      // Feedback ao usu√°rio
      Swal.fire('Limpeza conclu√≠da!', 'Todos os registros foram removidos.', 'success');
      
    } catch (error) {
      console.error("Erro ao limpar:", error);
      Swal.fire('Erro!', 'N√£o foi poss√≠vel limpar os registros.', 'error');
      
      // Restaura os dados
      await carregarDados();
    }
  }

  // Atualiza o filtro de operadores
  function atualizarFiltroOperadores() {
    const selectFiltro = document.getElementById("filtroOperador");
    const operadoresUnicos = [...new Set(registros.map(r => r.operador))].sort();
    // Mant√©m a sele√ß√£o atual
    const valorAtual = selectFiltro.value;
    selectFiltro.innerHTML = `<option value="Todos">TODOS os operadores</option>`;

    operadoresUnicos.forEach(op => {
      const opt = document.createElement("option");
      opt.value = op;
      opt.textContent = op;
      selectFiltro.appendChild(opt);
    });

    // Restaura a sele√ß√£o se ainda existir
    if (operadoresUnicos.includes(valorAtual)) {
      selectFiltro.value = valorAtual;
    }
  }

  // Formata data para o padr√£o brasileiro
  function formatarDataBR(dataISO) {
    if (!dataISO) return "-";
    const [ano, mes, dia] = dataISO.split("-");
    return `${dia}/${mes}/${ano}`;
  }

  // Limpa os filtros de data
  function limparDataFiltros() {
    document.getElementById("filtroDataInicio").value = "";
    document.getElementById("filtroDataFim").value = "";
    filtrarErros();
  }

  // Filtra os erros conforme os crit√©rios selecionados
  function filtrarErros() {
    const filtroOperador = document.getElementById("filtroOperador").value;
    const inicio = document.getElementById("filtroDataInicio").value;
    const fim = document.getElementById("filtroDataFim").value;
    let filtrados = registros;

    // Aplica filtro por operador
    if (filtroOperador !== "Todos") {
      filtrados = filtrados.filter(r => r.operador === filtroOperador);
    }

    // Aplica filtro por data
    if (inicio || fim) {
      filtrados = filtrados.filter(r => {
        const dataErro = r.data;
        return (!inicio || dataErro >= inicio) && (!fim || dataErro <= fim);
      });
    }

    // Atualiza a tabela e o resumo com os dados filtrados
    atualizarTabela(filtrados);
    atualizarResumo(filtrados);
  }

  // Atualiza o resumo exibido na p√°gina
  function atualizarResumo(lista = registros) {
    const resumoOp = {};
    // Calcula totais por operador
    lista.forEach(r => {
      const op = r.operador;
      if (!resumoOp[op]) {
        resumoOp[op] = { 
          totalErros: 0, 
          desconto: 0,
          ids: []
        };
      }
      
      if (r.erro !== "SEM ERROS") {
        resumoOp[op].totalErros++;
        resumoOp[op].ids.push(r.id);
        
        if (deducoes[r.erro] !== undefined) {
          resumoOp[op].desconto += deducoes[r.erro];
        }
      }
    });

    for (let op in resumoOp) {
      resumoOp[op].valorFinal = Math.max(0, baseValor - resumoOp[op].desconto);
    }

    let html = "<h4>Resumo por Operador</h4>";

    if (Object.keys(resumoOp).length === 0) {
      html += "<p>Nenhum registro para exibir</p>";
    } else {
      html += `<div style="overflow-x: auto;"><table>
        <thead>
          <tr style="background-color: var(--primary); color: white;">
            <th>Operador</th>
            <th>Total de Erros</th>
            <th>IDs dos Erros</th>
            <th>Total Descontado (R$)</th>
            <th>Valor Final (R$)</th>
          </tr>
        </thead>
        <tbody>`;
      
      for (let op in resumoOp) {
        const item = resumoOp[op];
        html += `<tr>
          <td>${op}</td>
          <td>${item.totalErros}</td>
          <td>${item.ids.join(', ')}</td>
          <td>${item.desconto.toFixed(2)}</td>
          <td style="font-weight: bold; color: var(--success);">R$ ${item.valorFinal.toFixed(2)}</td>
        </tr>`;
      }
      
      html += "</tbody></table></div>";
    }

    const inicio = document.getElementById("filtroDataInicio").value;
    const fim = document.getElementById("filtroDataFim").value;

    if (inicio || fim) {
      const resumoErros = {};
      
      lista.forEach(r => {
        const erro = r.erro;
        if (erro !== "SEM ERROS") {
          if (!resumoErros[erro]) {
            resumoErros[erro] = 0;
          }
          resumoErros[erro]++;
        }
      });
      
      html += "<h4 style='margin-top:20px;'>Resumo de Erros Cometidos</h4>";
      
      if (Object.keys(resumoErros).length === 0) {
        html += "<p>Nenhum erro registrado no per√≠odo</p>";
      } else {
        html += `<div style="overflow-x: auto;"><table>
          <thead>
            <tr style="background-color: var(--primary); color: white;">
              <th>Erro</th>
              <th>Quantidade</th>
              <th>Valor (R$)</th>
            </tr>
          </thead>
          <tbody>`;
        
        for (let erro in resumoErros) {
          const valor = deducoes[erro] || 0;
          html += `<tr>
            <td>${erro}</td>
            <td>${resumoErros[erro]}</td>
            <td>${valor.toFixed(2)}</td>
          </tr>`;
        }
        
        html += "</tbody></table></div>";
      }
    }

    document.getElementById("resumoConteudo").innerHTML = html;
  }

  // Exporta PDF com filtro aplicado (somente tabela de erros)
  function exportarPDFFiltro() {
    const filtroOperador = document.getElementById("filtroOperador").value;
    const inicio = document.getElementById("filtroDataInicio").value;
    const fim = document.getElementById("filtroDataFim").value;
    let dados = registros;

    if (filtroOperador !== "Todos") {
      dados = dados.filter(r => r.operador === filtroOperador);
    }

    if (inicio || fim) {
      dados = dados.filter(r => {
        return (!inicio || r.data >= inicio) && (!fim || r.data <= fim);
      });
    }

    if (dados.length === 0) {
      Swal.fire('Aten√ß√£o', 'N√£o h√° registros para exportar com os filtros atuais.', 'warning');
      return;
    }

    const titulo = filtroOperador !== "Todos" ? 
      `Relat√≥rio de Erros - ${filtroOperador}` : 
      "Relat√≥rio de Erros (Filtrado)";

    gerarPDF(dados, titulo, false);
  }

  // Exporta PDF completo (com tabela e resumo)
  function exportarPDFCompleto() {
    if (registros.length === 0) {
      Swal.fire('Aten√ß√£o', 'N√£o h√° registros para exportar.', 'warning');
      return;
    }
    gerarPDF(registros, "Relat√≥rio de Erros (Completo)", true);
  }

  // Gera o PDF
  function gerarPDF(dados, titulo, incluirResumo = true) {
    const doc = new jsPDF({
      orientation: 'landscape',
      unit: 'mm'
    });
    doc.setProperties({
      title: titulo,
      subject: 'Relat√≥rio de Erros Operacionais',
      author: 'AFT Qu√≠mica',
      keywords: 'erros, operadores, relat√≥rio',
      creator: 'Sistema de Controle de Erros'
    });

    doc.setFontSize(16);
    doc.setTextColor(46, 134, 193);
    doc.setFont("helvetica", "bold");
    doc.text(titulo, doc.internal.pageSize.width / 2, 15, { align: 'center' });

    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.setFont("helvetica", "normal");
    doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, doc.internal.pageSize.width / 2, 22, { align: 'center' });
    doc.text(`Total de registros: ${dados.length}`, doc.internal.pageSize.width / 2, 27, { align: 'center' });

    const headers = [["ID", "Operador", "Erro", "Marca Erro", "Data", "Repetido", "Corre√ß√£o", "Observa√ß√µes", "Desconto (R$)", "Valor Final (R$)"]];
    const dataTabela = dados.map(r => {
      return [
        r.id.toString(),
        r.operador,
        r.erro,
        r.marcaErro || "-",
        formatarDataBR(r.data),
        r.repetido,
        r.correcao,
        r.obs || "-",
        r.valor_total_descontado.toFixed(2),
        r.valor_final_pago.toFixed(2)
      ];
    });

    doc.autoTable({
      head: headers,
      body: dataTabela,
      startY: 35,
      theme: "grid",
      headStyles: { 
        fillColor: [46, 134, 193],
        textColor: 255,
        fontStyle: 'bold'
      },
      alternateRowStyles: {
        fillColor: [240, 240, 240]
      },
      margin: { top: 35 },
      styles: {
        fontSize: 8,
        cellPadding: 3,
        overflow: 'linebreak'
      },
      columnStyles: {
        0: { cellWidth: 15 },
        1: { cellWidth: 25 },
        2: { cellWidth: 40 },
        3: { cellWidth: 25 },
        4: { cellWidth: 15 },
        5: { cellWidth: 15 },
        6: { cellWidth: 30 },
        7: { cellWidth: 40 },
        8: { cellWidth: 20, halign: 'right' },
        9: { cellWidth: 20, halign: 'right' }
      }
    });

    if (incluirResumo) {
      const resumoObj = gerarResumoPDF(dados);
      
      if (Object.keys(resumoObj.operadores).length > 0) {
        doc.addPage('landscape');
        
        doc.setFontSize(14);
        doc.setTextColor(46, 134, 193);
        doc.setFont("helvetica", "bold");
        doc.text("Resumo por Operador", 15, 15);
        
        const resumoHeaders = [["Operador", "Total de Erros", "IDs dos Erros", "Total Descontado (R$)", "Valor Final (R$)"]];
        const resumoData = [];
        
        for (let op in resumoObj.operadores) {
          const item = resumoObj.operadores[op];
          resumoData.push([
            op,
            item.totalErros.toString(),
            item.ids.join(', '),
            item.desconto.toFixed(2),
            item.valorFinal.toFixed(2)
          ]);
        }
        
        doc.autoTable({
          head: resumoHeaders,
          body: resumoData,
          startY: 25,
          theme: "grid",
          headStyles: { 
            fillColor: [46, 134, 193],
            textColor: 255,
            fontStyle: 'bold'
          },
          columnStyles: {
            3: { halign: 'right' },
            4: { halign: 'right' }
          },
          styles: {
            fontSize: 10,
            cellPadding: 3
          }
        });
      }
    }

    doc.save(`${titulo.replace(/[^a-z0-9]/gi, '_')}.pdf`);
  }

  // Gera os dados resumo para o PDF
  function gerarResumoPDF(dados) {
    const operadores = {};
    const erros = {};
    dados.forEach(r => {
      const op = r.operador;
      
      if (!operadores[op]) { 
        operadores[op] = { 
          totalErros: 0, 
          desconto: 0,
          ids: []
        }; 
      }
      
      if (r.erro !== "SEM ERROS") {
        operadores[op].totalErros++;
        operadores[op].ids.push(r.id);
        
        if (deducoes[r.erro] !== undefined) {
          operadores[op].desconto += deducoes[r.erro];
        }
      }
      
      if (!erros[r.erro]) { 
        erros[r.erro] = 0; 
      }
      erros[r.erro]++;
    });

    for (let op in operadores) {
      operadores[op].valorFinal = Math.max(0, baseValor - operadores[op].desconto);
    }

    return { operadores, erros };
  }

  // Fun√ß√£o para salvar no Supabase com todos os campos
  async function salvarNoSupabase(erro) {
    const response = await fetch(`${SUPABASE_URL}/rest/v1/erros`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "apikey": SUPABASE_KEY,
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "Prefer": "return=representation"
      },
      body: JSON.stringify({
        operador: erro.operador,
        erro: erro.erro,
        data: erro.data,
        repetido: erro.repetido,
        correcao: erro.correcao,
        obs: erro.obs || null,
        marca_erro: erro.marcaErro || null,
        valor_total_descontado: erro.valor_total_descontado,
        valor_final_pago: erro.valor_final_pago
      })
    });
    if (!response.ok) {
      throw new Error(`Erro HTTP: ${response.status}`);
    }

    return response.json();
  }
</script>
</body>
</html>
